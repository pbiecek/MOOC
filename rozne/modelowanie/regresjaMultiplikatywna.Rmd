---
title: "Modelowanie / regresja multiplikatywna"
output:
  html_document:
    toc: yes
    mathjax: "http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
---

# Regresja liniowa - kontynuacja

Analizując rzeczywiste dane, często możemy spotkać sytuacje w których zależność pomiędzy zmiennymi nie wygląda na liniową.
Również w takich sytuacjach regresja jest użytecznym narzędziem, ponieważ często zależności można sprowadzić do liniowych 
wykonując transformacje zmiennych.

Jak? O tym poniżej.

W tej części będziemy bazować na przykładach dotyczących cen samochodów. Wczytajmy dane.

## Wczytanie danych

W naszym zbiorze danych znajdują się oferty sprzedaży bardzo różnych marek. 
Analizowanie ich wszystkich w jednym worku nie ma sensu. 
Dlatego dalsze analizy przeprowadzimy na podzbiorze danych dotyczącym marki Volkswagen.
Dlaczego tej? Jest ona najpopularniejsza w zebranych ogłoszeniach.

```{r, warning=FALSE, width=8, height=8}
library(SmarterPoland)      # w tym pakiecie znajduje się zbiór danych auta2012
volkswagen <- auta2012 %>%
  filter(Marka == "Volkswagen")
head(volkswagen, 2)
```


**PCH: Jeśli nie chcesz zrobić ludziom wody z mózgu, to musisz wytłumaczyć o co chodzi
w tej różnicy ;) Chyba nie obejdzie się bez krótkiego wprowadzenia do dplyra:**

```
> head(auta2012,2)
   Cena Waluta Cena.w.PLN Brutto.netto  KM  kW      Marka     Model Wersja Liczba.drzwi Pojemnosc.skokowa Przebieg.w.km
1 49900    PLN      49900       brutto 140 103        Kia    Carens                 4/5              1991         41000
2 88000    PLN      88000       brutto 156 115 Mitsubishi Outlander                 4/5              2179         46500
           Rodzaj.paliwa Rok.produkcji Kolor Kraj.aktualnej.rejestracji Kraj.pochodzenia Pojazd.uszkodzony Skrzynia.biegow
1 olej napedowy (diesel)          2008                           Polska                                           manualna
2 olej napedowy (diesel)          2008                           Polska                                           manualna
  Status.pojazdu.sprowadzonego
1                             
2                             
                                                                                                                                                                               Wyposazenie.dodatkowe
1                         ABS, el. lusterka, klimatyzacja, alufelgi, centralny zamek, autoalarm, poduszka powietrzna, radio / CD, wspomaganie kierownicy, immobiliser, komputer, przyciemniane szyby
2 ABS, 4x4, el. lusterka, klimatyzacja, skorzana tapicerka, alufelgi, centralny zamek, poduszka powietrzna, radio / CD, wspomaganie kierownicy, immobiliser, komputer, tempomat, przyciemniane szyby
> library(dplyr)

Dołączanie pakietu: ‘dplyr’

The following objects are masked from ‘package:stats’:

    filter, lag

The following objects are masked from ‘package:base’:

    intersect, setdiff, setequal, union

> head(auta2012,2)
Source: local data frame [2 x 21]

   Cena Waluta Cena.w.PLN Brutto.netto  KM  kW      Marka     Model Wersja Liczba.drzwi Pojemnosc.skokowa Przebieg.w.km
1 49900    PLN      49900       brutto 140 103        Kia    Carens                 4/5              1991         41000
2 88000    PLN      88000       brutto 156 115 Mitsubishi Outlander                 4/5              2179         46500
Variables not shown: Rodzaj.paliwa (fctr), Rok.produkcji (dbl), Kolor (fctr), Kraj.aktualnej.rejestracji (fctr),
  Kraj.pochodzenia (fctr), Pojazd.uszkodzony (fctr), Skrzynia.biegow (fctr), Status.pojazdu.sprowadzonego (fctr),
  Wyposazenie.dodatkowe (fctr)
```

Każdy wiersz tego zbioru danych opisuje jedną ofertę sprzedaży auta. Każda kolumna opisuje jedną cechę / właściwość tej oferty.

## Jaka to zależność?

Zobaczmy jak wygląda zależność ceny od wieku volkswagena. 
W naszym zbiorze danych nie ma zmiennej wiek, jest jedynie rok produkcji.
Wiedząc, że te oferty były zbierane w styczniu 2012 roku łatwo nam będzie wyznaczyć wiek auta.
Zacznijmy więc od wyznaczenia zmiennej wiek auta, a następnie usunięcia aut ponad 20 letnich 
(mało ich jest i będą nam przeszkadzać w modelowaniu).

```{r, warning=FALSE}
volkswagen <- volkswagen %>%
  mutate(Wiek = 2012 - Rok.produkcji) %>%
  filter(Wiek < 20)
```

Wykorzystamy funkcję `lm()`, którą poznaliśmy w poprzednim module, do wyznaczenia zależności pomiędzy 
ceną a wiekiem auta. 

Narysujemy też te dwie zmienne dorysowując do nich linię trendu liniowego.

```{r, warning=FALSE}
lm(Cena.w.PLN ~ Wiek, data=volkswagen)$coef

ggplot(volkswagen, aes(y=Cena.w.PLN, x = Wiek)) + 
  geom_point() + 
  geom_smooth(method="lm", col="red", size=2) +
  ylim(0,400000)
```

**PCH: pojawia się znany wszystkim 'ylim' ;) **

Gdyby bezrefleksyjnie przyjąć wyniki estymacji, okazałoby się, że zależność pomiędzy ceną a wiekiem opisana jest przez równanie
_Średnia cena = 67640.352 - 4236.639 * Wiek_

Nieufność powinna w nas wzbudzić obserwacja, że podstawiając do tego wzoru za wiek 16 lub więcej lat, okaże się, że otrzymujemy oszacowanie średniej ceny ujemne. Jest to jeden z sygnałów, że coś jest nie tak z naszym modelem.

### Zadania:
+ Czy Volkswagen jest wyjątkowy pod tym względem? Zobacz jak wygląda zależność pomiędzy ceną a wiekiem dla innych marek. Dziesięć najczęstszych marek w tym zbiorze danych to ```r paste(collapse=", ", names(head(rev(sort(table(auta2012$Marka))),10)))```

### Odpowiedzi:
```{r, warning=FALSE}
toyota <- auta2012 %>%
  filter(Marka == "Toyota") %>%
  mutate(Wiek = 2012 - Rok.produkcji) %>%
  filter(Wiek < 20)

lm(Cena.w.PLN ~ Wiek, data=toyota)$coef

ggplot(toyota, aes(y=Cena.w.PLN, x = Wiek)) + 
  geom_point() + 
  geom_smooth(method="lm", col="red", size=2) +
  ylim(0,400000)
```



## Jeżeli nie liniowa, to jaka?

Gdy się zastanowić, łatwo dojść do wniosku, że auta tracą na wartości najwięcej w pierwszych latach, gdy są najdroższe.
Starsze auta są już tańsze i mniej tracą na wartości. Nie dotyczy to antyków, ale analizowane volkswageny nie są antykami (dlatego mamy tylko auta młodsze niż 20 lat).

Model, który możemy rozważyć, to model w którym co roku auta tracą pewien procent swojej ceny.
Taką zależność można opisać jako

_Cena.w.roku.i+1 = Cena.w.roku.i * (1-procent) = Cena.w.roku.i * wsp_

i równoważnie 

$$latex
Cena.w.roku.i = Cena.w.roku.0 * (1-procent)^i = Cena.w.roku.0 * wsp^i
$$

**PCH: Dopiero teraz to zauważyłem, ale wcześniej też było to nieco drażniące - 
wzory trzeba pisać tak, żeby były wyświetlane w specjalny sposób, czyli
np. składnią LaTeXową, jak przykład powyżej, który próbowałem zmienić, ale nie mogę
uruchomić renderowania równań poprawnie. Jakiś pomysł?**


Takie zależności nazywamy multiplikatywnymi. Można je sprowadzić do zależności liniowych logarytmując obie strony.
(Tak, logarytmy się przydają).

_log(Cena.w.roku.i) = log(Cena.w.roku.0) +  log(wsp) * i_

czyli zmieniając zapis

_log(Cena) = b0 + b1 * Wiek_

A to już wygląda jak model liniowy!

Zobaczmy najpierw, jak te dane wyglądać będą,
jeżeli ceny przedstawimy w skali logarytmicznej.

```{r, warning=FALSE}
ggplot(volkswagen, aes(y=Cena.w.PLN, x = Wiek)) + 
  geom_point() + 
  geom_smooth(size=2) + geom_smooth(method="lm", col="red", size=2) +
  scale_y_continuous(trans="log10")
```

Na rysunku ta zależność wygląda na liniową.

Zobaczmy jak wykonać model liniowy z użyciem funkcji `lm()`.
Wpierw musimy policzyć logarytm ceny.

```{r, warning=FALSE}
volkswagen <- volkswagen %>%
  mutate(logCena.w.PLN = log10(Cena.w.PLN))

(wsp = lm(logCena.w.PLN ~ Wiek, data=volkswagen)$coef)
```

Jeżeli przejść teraz ze skali logarytmicznej (logarytm dziesiętny) na oryginalną skalę, 
to okaże się, że średnia cena wyjściowa to `10^```r wsp[1]``` = ```r 10^wsp[1]````.

Drugi współczynnik wynosi ```r wsp[2]```, co oznacza, że cena w kolejnym roku to ```r 10^wsp[2]``` ceny z poprzedniego roku, 
czyli przecietnie, corocznie auto traci 15% swojej ceny.


### Zadania:
+ Wykonaj modelowanie z użyciem modelu multiplikatywnego dla innej marki. 
+ Jeżeli model multiplikatywny wygląda na uzasadniony, policz ile procent corocznie traci na cenie auto danej marki.

**PCH: Albo wprowadzasz pętle, albo ideą 'apply'. There is no other way, chociaż pobieżnie.
To nie powinny być zadania, po których ludzie będą siedzieć 3 dni z tępym wzrokiem
i zastanawiać się jak to zrobić, a potem jak podejrzą rozwiązanie i zobaczą,
że używasz nieznanych im funkcji to zdobędą Twój adres i przyjadą Ci podziękować
osobiście za stracone dni swojeo życia.**


### Odpowiedzi:
```{r, warning=FALSE, fig.width=4, fig.height=4}
marki <- names(head(rev(sort(table(auta2012$Marka))),10))
sapply(marki, function(marka) {
  wybranamarka <- auta2012 %>%
    filter(Marka == marka) %>%
    mutate(Wiek = 2012 - Rok.produkcji) %>%
    filter(Wiek < 20) %>%
    mutate(logCena.w.PLN = log10(Cena.w.PLN))
  
  plot(ggplot(wybranamarka, aes(y=Cena.w.PLN, x = Wiek)) + 
    geom_point() + 
    geom_smooth(method="lm", col="red", size=2) +
    ggtitle(marka) + scale_y_continuous(trans="log10"))
  
  wsp <- lm(logCena.w.PLN ~ Wiek, data=wybranamarka)$coef
  procent <- 1- 10^(wsp[2])
  round(100*procent,1)
} )
```



## Zależność kawałkami liniowa

Są sytuacje, w których zależność pomiędzy dwiema zmiennymi można opisać nie tyle przez linię prosta co przez łamaną. 

Za przykład takiej zależności posłuży nam zależność pomiędzy przebiegiem a wiekiem auta.

## Czyszczenie danych

Zanim rozpoczniemy jakiekolwiek modelowanie musimy wpierw przyjrzeć się danym.

W modelowaniu obowiązuje żelazna zasada _śmieci na wejściu — śmieci na wyjściu_ (ang. garbage in, garbage out). 
Bez względu na to jakie metody będziemy wykorzystywać, jeżeli w danych są błędy to nasze modelowanie prowadzić może do bezsensownych wniosków.

```{r, warning=FALSE}
ggplot(volkswagen, aes(y=Przebieg.w.km, x = Wiek)) + 
  geom_point()
```

Okazuje się, że są wśród naszych ofert auta o absurdalnym przebiegu ponad 15 milionów kilometrów. Usuńmy wszystkie, których przebieg przekracza czterysta tysięcy kilometrów.

```{r, warning=FALSE}
volkswagen <- volkswagen %>%
  filter(Przebieg.w.km < 400000)

ggplot(volkswagen, aes(y=Przebieg.w.km, x = Wiek)) + 
  geom_point()+
  geom_smooth(size=2) + geom_smooth(method="lm", col="red", size=2) 
```

**PCH: Pamiętaj, że minęły 3 dni odkąd śmiałkowie zaczęli rozwiązywać poprzednie
zadanie. Mogą nie mieć już w środowisku zmiennej 'volskwagen'. Może lepiej dodać
to do filtrowania i zacząć od zbioru auta2012?**


Kolorem czerwonym zaznaczono krzywą liniowej zależności pomiędzy zmiennymi. Jak widać odstaje ona znacznie dla kilkuletnich aut. **PCH: Od czego odstaje? Od niebieskiej?**

Niebieska linia, to linia wygładzonego trendu, lokalnie przybliżającego dane. Gdy się jej przyjrzeć, okazuje się, że ma ona bardzo ciekawe zachowanie. 

Przez pierwsze pięć lat auta gwałtownie przybierają na liczniku, a po piątym roku to tempo znacząco spada.

Czy volkswagenami starszymi niż 5 lat mniej się jeździ? Jest to jakieś wytłumaczenie, ale inne, badziej prawdopodobne, jest takie że starsze auta rzadziej są serwisowane, a przez to ich przebiegi często są wartościami deklarowanymi.

W jaki sposób zamodelować taką łamaną krzywą?
Potrzebujemy modelu, który będzie miał inną krzywą nachylenia w przedziale do 5 lat i ponad 5 lat.

Można taki model zbudować w następujący sposób

_Średni przebieg = b0 + b1 * wiek[0+] + b2 * wiek[5+]_

gdzie _wiek[5+]_ to zmienna przyjmująca wartość _0_, jeżeli wiek jest mniejszy niż 5 oraz wartość _wiek-5_ gdy wiek jest większy niż 5.

Stosując taką dodatkową zmienną, zależność pomiędzy wiekiem a przebiegiem będzie opisana przez współczynnik _b1_ gdy wiek jest w przedziale 0-5 lat oraz przez współczynnik _b1 + b2_ gdy wiek jest wyższy niż 5 lat.

```{r, warning=FALSE}
volkswagen <- volkswagen %>%
  mutate(Wiek0 = ifelse(Wiek >= 0, Wiek, 0),
         Wiek5 = ifelse(Wiek >= 5, Wiek - 5, 0))

(M1 = lm(Przebieg.w.km ~ Wiek0 + Wiek5, data=volkswagen))
```

Zauważmy, że powyższy model szacuje przebieg dla nowych aut na _b0_.
Bardziej naturalnym modelem jest taki, który dla nowych aut będzie 
prognozował przebieg zero. Można to osiągnąć usuwając wyraz wolny.

_Średni przebieg = b1 * wiek[0+] + b2 * wiek[5+]_

Co w formule R można zapisać jako

```{r, warning=FALSE}
(M2 = lm(Przebieg.w.km ~ Wiek0 + Wiek5 - 1, data=volkswagen))
```

Jak odczytać ten model?
Dla aut o wieku poniżej 5 lat obserwuje się średnie zwiększanie przebiegu w tempie ```r format(round(M2$coef[1]))```km na rok, ale już dla aut starszych niż 5 lat obserwuje się wydłużanie średniego przebiegu w tempie ```r round(sum(M2$coef))```km na rok.

Przedstawmy te modele graficznie.
Wykorzystamy do tego funkcję predict, która wyznacza średni przebieg dla zadanego wieku. 
**PCH: No przy okazji wyznacza, ale chyba warto było wcześniej przy prostej regresji
powiedzieć coś więcej o modelu (na przykład co jest w obiekcie klasy 'lm'), 
np. co się stanie jak zrobisz na nim plot, summary, ale również o predict**


```{r, warning=FALSE}
topred = data.frame(Wiek0 = c(0,5,20), Wiek5 = c(0, 0, 15))
topred$M1 = predict(M1, newdata = topred)
topred$M2 = predict(M2, newdata = topred)

ggplot(volkswagen, aes(y=Przebieg.w.km, x = Wiek)) + 
  geom_point() + 
  geom_smooth(method="lm", col="red", size=2) +
  geom_line(data= topred, aes(y=M1, x = Wiek0), size=2, col="green") + 
  geom_line(data= topred, aes(y=M2, x = Wiek0), size=2, col="blue")

```

### Zadania:
+ Wykonaj modelowanie z użyciem łamanej regresji dla innych marek.

### Odpowiedzi:
```{r, warning=FALSE, fig.width=4, fig.height=4}
marki <- names(head(rev(sort(table(auta2012$Marka))),10))
invisible(sapply(marki, function(marka) {
  wybranamarka <- auta2012 %>%
    filter(Marka == marka) %>%
    mutate(Wiek = 2012 - Rok.produkcji) %>%
    filter(Wiek < 20,
           Przebieg.w.km < 400000) %>%
    mutate(Wiek0 = ifelse(Wiek >= 0, Wiek, 0),
         Wiek5 = ifelse(Wiek >= 5, Wiek - 5, 0))
  
    M1 = lm(Przebieg.w.km ~ Wiek0 + Wiek5, data=wybranamarka)
    M2 = lm(Przebieg.w.km ~ Wiek0 + Wiek5 - 1, data=wybranamarka)
    
    topred = data.frame(Wiek0 = c(0,5,20), Wiek5 = c(0, 0, 15))
    topred$M1 = predict(M1, newdata = topred)
    topred$M2 = predict(M2, newdata = topred)
    
    plot(ggplot(wybranamarka, aes(y=Przebieg.w.km, x = Wiek)) + 
      geom_point() + 
      geom_smooth(method="lm", col="red", size=2) +
      geom_line(data= topred, aes(y=M1, x = Wiek0), size=2, col="green") + 
      geom_line(data= topred, aes(y=M2, x = Wiek0), size=2, col="blue") +
    ggtitle(marka))
  
} ))
```

