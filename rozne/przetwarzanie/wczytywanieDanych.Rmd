---
title: "Jak wczytać dane do R?"
output:
  html_document:
    toc: yes
---

## Wczytywanie danych z zewnętrznych plików

### Intro
Najczęściej dane, na których chcemy pracować są w pliku Excela [xls lub xlsx], w pliku tekstowym [w formacie csv, tzw. comma-separated values] lub są zapisane w postaci binarnej R.
Zobaczmy jak wczytać dane z każdego z tych formatów.


### Część właściwa
Przedstawione poniżej dane można wczytać bezpośrednio z Internetu.
Można je też pobrać, dane są dostępne w różnych formatach pod następującymi linkami:

* dane Excelowe http://biecek.pl/MOOC/dane/auta2012mini.xls
* dane tekstowe http://biecek.pl/MOOC/dane/auta2012mini.csv
* dane binarne http://biecek.pl/MOOC/dane/auta2012mini.rda

*Uwaga!* Wczytywane pliki mają do 3.5 MB. Ich pobieranie może potrwać kilka minut, lub więcej jeżeli połączenie internetowe nie jest dobre lub wiele osób jednocześnie z niego korzysta.

W przypadku problemów z dostępem do danych, można skorzystać z mniejszych danych odpowiednio w formacie nano (3 tys wierszy, 350 kB do pobrania).

* dane tekstowe http://biecek.pl/MOOC/dane/auta2012nano.csv
* dane Excelowe http://biecek.pl/MOOC/dane/auta2012nano.xls
* dane binarne http://biecek.pl/MOOC/dane/auta2012nano.rda


## Dane tekstowe csv

Dane w formacie csv to dane tekstowe. Rozdzielane średnikami z przecinkiem jako kropką dziesiętną.
Można je wczytać poleceniem `read.table()`.

```{r, warning=FALSE}
auta2012mini = read.table("http://biecek.pl/MOOC/dane/auta2012mini.csv",
                       sep=";", dec=",", header=TRUE)
head(auta2012mini, 2)
```

## Dane Excelowe xls

Dane w formacie xls to dane w formacie Excela. 
Można je wczytać poleceniem `read.xls()`, ale wcześniej trzeba wczytać pakiet `gdata`.
Jeżeli ten pakiet nie jest dostępny, to należy go wcześniej zainstalować poleceniem `install.packages("gdata")`.

```{r, warning=FALSE}
library(gdata)
auta2012mini <- read.xls("http://biecek.pl/MOOC/dane/auta2012mini.xls", sheet = 1)
head(auta2012mini, 2)
```

## Dane binarne rda

Dane w formacie rda to dane binarne w natywnym formacie R. 
Zajmują najmniej miejsca na dysku, ale można je otworzyć tylko w programie R.
Można je wczytać poleceniem `load()`.

```{r, warning=FALSE}
plik <- url("http://biecek.pl/MOOC/dane/auta2012mini.rda")
load(plik)
head(auta2012mini, 2)
```





## Wczytywanie danych z pakietów R

### Intro
Przygotowując ten kurs miałem taki problem. 
Jak w najprostszy sposób udostępnić uczestnikom tego kursu kilka zbiorów danych?
Rozważając różne opcje, stwierdziłem że najłatwiejsza to z użyciem papkietu z danymi.

### Część właściwa
Pakiety to zbiory funkcji oraz zbiorów danych.
Są takie pakiety, w których są tylko funkcje, takie które mają wyłącznie zbiory danych i zawierające i funkcje i dane.

Aby sprawdzić jakie zbiory danych są dostępne w określonym pakiecie, można wykorzystać funkcję `data()` z argumentem `package`. 
Zobaczmy na przykład jakie zbiory danych udostępnione są w pakiecie `SmarterPoland`.

```{r, warning=FALSE}
data(package="SmarterPoland")
```

Jednym ze zbiorów danych w tym pakiecie jest zbiór `auta2012`.
Aby z niego korzystać wystarczy załadować zbiór danych `SmarterPoland` i wszystkie zbiory danych są dostępne.
Zademonstrujmy to wyświetlając pierwsze trzy wiersze.

```{r, warning=FALSE}
library("SmarterPoland")
head(auta2012, 3)
```






## Pobieranie danych z internetu na przykładzie Banku Danych Lokalnych

### Intro
Czy zastanawialiście się, jak wygląda poziom bezrobocia w różnych grupach wykształcenia? I jak zmieniał się on w ostatnich latach?

W najbliższym odcinku zastanowimy się, skąd wziąć dane o bezrobociu oraz zobaczymy, jak się ono zmieniało w ostatnich latach.

### Część właściwa

Coraz popularniejszym źródłem danych stają się usługi internetowe pozwalające na pobieranie wycinków danych z większych repozytoriów danych bez konieczności pobierania całego repozytorium.

Przykładem takiego źródła danych jest Bank Danych Lokalnych GUS. Przechowuje on wiele danych na różnych poziomach agregacji. Najczęściej jesteśmy zainteresowany tylko małym wycinkiem całości, którą GUS udostępnia.
Zamiast więc pobierać całe repozytorium, możemy pobrać wybrany raport z całego repozytorium.

Komunikacja z takimi repozytoriami odbywa się zazwyczaj za pomocą tzw. API (Application Programming Interface), czyli protokołu udostępniania danych. 

Poniżej pokażemy przykład pobierania danych bazując na API do Banku Danych Lokalnych. Różne repozytoria wymagają innych funkcji by z nich skorzytać (np. dane z eurostatu są dostępne w pakiecie `eurostat`). Uniwersalny jest za to sposób wydobywania danych.

Przypuśćmy, że interesuje nas bezrobocie w kraju. Zazwyczaj API udostępniają funkcję, pozwalającą odszukac konkretny raport w gąszczu wszystkich przechowywanych raportów.

W tym przypadku, dostęp do API Banku Danych Lokalnych jest możliwy za pośrednictwem pakietu SmarterPoland, który zawiera fucnkję `getBDLtree()` pobierającą nazwy i opisy raportów z repozytorium. 

```{r, warning=FALSE}
library(dplyr)
library(ggplot2)

listaTematow <- getBDLtree()
nrow(listaTematow)
```

W sumie mamy 1337 raportów. W kolumnie `subgroup` pobranej ramki znajduje się szczegółowy opis czego dany raport dotyczy. Odfiltrujmy wszystkie raporty, które w opisie zawierają frazę `bezroboci`.


```{r, warning=FALSE}
listaTematow %>%
  filter(grepl(subgroup, pattern="bezroboci"))
```

Przypyśćmy, że z tej listy interesuje nas raport 'Stopa bezrobocia wg poziomu wykształcenia'. Jest to raport o ID (numerze identyfikacyjnym) 41319, co można odczytać z ostatniej kolumny.
(Nazwę tej serii danych można też odczytać przez stronę GUS http://stat.gov.pl/bdl/)

Używając funkcji `getBDLseries()` możemy pobrać serie danych wskazując interesujący nas identyfikator.

```{r, warning=FALSE}
seria <- getBDLseries("41319")
head(seria)
```

W ten sposób odczytaliśmy dane z zewnętrzengo źródła danych do programu R.
Narysujmy je graficznie, aby zobaczyć co się dzieje z bezrobociem.
Tajemnicą poliszynela jest, że kolumna `value` jest napisem a nie liczbą, więc przed rysowaniem, musimy ją zamienić na liczbę, używając funkcji as.numeric.

Funkcją ggplot rysujemy wykres, z procentem bezrobocia dla różnych grup wyksztalcenia.

```{r, warning=FALSE}
seria$value <- as.numeric(seria$value)
ggplot(seria, aes(x=year, y=value, color=dimension)) +
  geom_line() + 
  geom_point() + ylab("Procent bezrobotnych") + xlab("Rok")
```

### Zadanie:
Sprawdź jaki ID ma raport o tytule 'Stopa bezrobocia wg wieku produkcyjnego i płci'.
Następnie pobierz dane z tego raportu i narysuj je na wykresie.






# Więcej informacji 

Więcej informacji o tym jak wczytywać i zapisywać dane z i do baz danych lub plików w egzotycznych formatach znaleźć można w dokumencie *R Data Import/Export*
http://cran.r-project.org/doc/manuals/r-release/R-data.pdf
https://github.com/pbiecek/MOOC/blob/master/materialyZewnetrzne/R-data.pdf?raw=true
