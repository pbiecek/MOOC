```{r}
library(XML)
library(dplyr)

ltop <- readLines("http://graphtv.kevinformatics.com/top")
movies <- strsplit(paste(ltop, collapse=" "), split="<a href='/")[[1]]

ids <- sapply(strsplit(movies, split="'"), '[', 1)[-1]
names <- sapply(strsplit(movies, split="[<>]"), '[', 6)[-1] %>%
  gsub(., pattern="^ *[0-9]*\\. *", replacement="") %>%
  gsub(., pattern=" *$*", replacement="")





http://www.seriesmonitor.com/thebigbangtheory/graphs.html

# super
http://graphtv.kevinformatics.com/tt0412142



tables = readHTMLTable("http://www.imdb.com/title/tt1475582/epdate?ref_=ttep_ql_4")
names(tables)
tables[[1]]
tables = readHTMLTable("http://www.imdb.com/title/tt1871731/epdate?ref_=ttep_ql_4")
tables = readHTMLTable("http://www.imdb.com/title/tt0944947/epdate?ref_=ttep_ql_4")
names(tables)
tb <- tables[[1]]

sezon <- sapply(strsplit(as.character(tb[,1]), split=".", fixed=TRUE), `[`, 1)
ocena <- as.numeric(as.character(tb[,3]))
nazwa <- as.character(tb[,2])

df <- data.frame(id=seq_along(sezon), sezon, ocena, nazwa)

library(ggvis)
df %>% ggvis(x = ~ id, y = ~ ocena, fill = ~sezon) %>%
  layer_points() %>%
  layer_smooths()




lines <- readLines("http://thetvdb.com/?tab=seasonall&id=80379&lid=7")
lines <- readLines("http://thetvdb.com/?tab=seasonall&id=79168&lid=7")
lines <- readLines("http://thetvdb.com/?tab=seasonall&id=73255&lid=7")
lines <- grep(lines, pattern="<tr><td class=", value = TRUE)

linlin <- strsplit(lines, split='[<>\\"]')

sezony <- sapply(linlin, `[`, 11)
daty <- sapply(linlin, `[`, 31)
linki <- paste("http://thetvdb.com/", sapply(linlin, `[`, 21), sep="")

stars <- sapply(linki, function(l) {
  ll <- paste(readLines(l), collapse="")
  c(length(strsplit(ll, split="star.on.gif")[[1]])-4,
    length(strsplit(ll, split="star.off.gif")[[1]])-4)
})

summary(t(stars))

plot(stars[1,])

qplot()


tables = readHTMLTable("http://thetvdb.com/?tab=seasonall&id=80379&lid=7")
names(tables)

tables[[2]] 


nodes <- html_nodes(page, "table:nth-child(11) td:nth-child(3)")
html_text(nodes)
as.numeric(gsub(html_text(nodes), pattern="[^0-9\\.]", replacement=""))


#####
# Blog
library(rvest)
library(PogromcyDanych)
serialsToParse <- levels(serialeIMDB$imdbId)

ratingsGroup <- matrix("", length(serialsToParse), 14)
rownames(ratingsGroup) <- serialsToParse
colnames(ratingsGroup) <- c("Males", "Females", "Aged under 18", "Males under 18", 
"Females under 18", "Aged 18-29", "Males Aged 18-29", "Females Aged 18-29", 
"Aged 30-44", "Males Aged 30-44", "Females Aged 30-44", 
"Aged 45+", "Males Aged 45+", "Females Aged 45+")

i <- 0
for (serial in serialsToParse) {
  page <- html(paste0("http://www.imdb.com/title/",serial,"/ratings")) 
  
  nodes3 <- html_nodes(page, "table:nth-child(11) td:nth-child(3)")
  ratingsGroup[serial,] <- gsub(html_text(nodes3)[-1], pattern="[^0-9\\.]", replacement="")[1:14]
}




# Full opcja

library(rvest)
library(PogromcyDanych)
serialsToParse <- levels(serialeIMDB$imdbId)

ratings <- matrix("", length(serialsToParse), 10)
rownames(ratings) <- serialsToParse

ratingsGroup <- matrix("", length(serialsToParse), 14)
rownames(ratingsGroup) <- serialsToParse
colnames(ratingsGroup) <- c("Males ", " Females ", " Aged under 18 ", " Males under 18 ", 
"Females under 18", " Aged 18-29 ", " Males Aged 18-29 ", " Females Aged 18-29 ", 
"Aged 30-44", " Males Aged 30-44 ", " Females Aged 30-44 ", 
"Aged 45+", " Males Aged 45+ ", " Females Aged 45+ ")

votesGroup <- matrix("", length(serialsToParse), 14)
rownames(votesGroup) <- serialsToParse

i <- 0
for (serial in serialsToParse) {
  i <- i + 1
  cat(serial,"  ",i,"  ",Sys.time(),"\n")
  page <- html(paste0("http://www.imdb.com/title/",serial,"/ratings")) 
  nodes <- html_nodes(page, "table:nth-child(6) td:nth-child(1)")
  ratings[serial,] <- html_text(nodes)[-1]
  
  nodes2 <- html_nodes(page, "table:nth-child(11) td:nth-child(2)")
  nodes3 <- html_nodes(page, "table:nth-child(11) td:nth-child(3)")
  ratingsGroup[serial,] <- gsub(html_text(nodes2)[-1], pattern="[^0-9\\.]", replacement="")[1:14]
  votesGroup[serial,] <- gsub(html_text(nodes3)[-1], pattern="[^0-9\\.]", replacement="")[1:14]

  Sys.sleep(5)
}

slownik <- unique(serialeIMDB[,c(2,8)])
rownames(slownik) <- slownik[,2]

colnames(votesGroup) <- colnames(ratingsGroup)

xy <- votesGroup[,c(7,8,13,14)]
for (i in 1:4)
  xy[,i] <- as.numeric(xy[,i])

mf <- xy[,1] + xy[,3] - xy[,2] - xy[,4]
yo <- xy[,1] + xy[,2] - xy[,3] - xy[,4]
te <- as.character(slownik[rownames(votesGroup),1])
te[(mf^2+yo^2) < 2] = ""
  
plot(xy[-200,1] + xy[-200,2], xy[-200,1] - xy[-200,2])
text(xy[-200,1] + xy[-200,2], xy[-200,1] - xy[-200,2], te, cex=0.8)

plot(mf, yo, pch=19)
abline(h=0)
abline(v=0)
text(mf, yo, te, cex=0.8)




x <- as.numeric(votesGroup[,1]) - as.numeric(votesGroup[,2])
y <- as.numeric(votesGroup[,3]) - as.numeric(votesGroup[,12])
te <- levels(serialeIMDB$serial)
te[(x^2+y^2) < 1] = ""
plot(x,y)
abline(h=0)
abline(v=0)
text(x, y, te)

```
