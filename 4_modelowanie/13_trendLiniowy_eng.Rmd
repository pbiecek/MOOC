---
title: "Data trends"
author: "Data CruncheRs"
date: "Season 2 / Episode 13<br><br> All rights reserved.<br> The use shall be subject to prior consent of the author.  <br><br><br><br>Press `A` to see the plain text instead of the slides. <br> Press `T` to display the table of contents."
output:
  slidy_presentation:
    includes:
      in_header: ../tracking.html
    highlight: default
    css: ../style.css
    font_adjustment: 0
    footer: "Data CruncheRs / modelling / trends"
---

# What is this episode about?


In analyzing the data, we often come across a situation where we have a sequence of numbers, and we want to determine whether the values display any trend.

By analyzing energy consumption we can check whether there is a growing trend in energy demand. If we work with the data on ticket sales, we might be interested in the trend concerning the amount of tickets sold.

However, even if there is an apparent trend, the values are very rarely perfectly arranged in a line. Usually, the trend is submerged within large fluctuations. 

Then, how to determine which linear trend are we dealing with?

Here, statistics can help us. By using such tools as linear regression we can assess the parameters of linear trend.

Obviously, tendencies do not always provide for linear growth or linear drop. We'll therefor treat the work with linear trend as a first step before we can customize more complex dependencies.

In this episode, using data from IMDB (Internet Movie Database) website, we'll show how the procedure of setting the data trend works.

---

# Movie and TV Series database

In the IMDB movie database (Internet Movie Database) one can find different data concerning TV series, in particular, the average user ratings issued for subsequent episodes of the series.

For example no the http://www.imdb.com/title/tt0903747/epdate?ref_=ttep_ql_4 website there are ratings for *Breaking Bad* TV series.

We have downloaded this data from the Internet, and prepared them so they would be available in a dataset `serialeIMDB` in a packet `PogromcyDanych`, which was attached to this course.

Using this data, we exercise working with linear trend.

```{r, warning=FALSE, message=FALSE}
library(PogromcyDanych)
head(serialeIMDB)
```

---

# How does a trend look in the series?

Having this data set we'll review how do ratings for the *Breaking Bad* TV series look like. 

The following plot displays average rating (on the OY axis) for subsequent episodes (laid out along the OX axis). In last episode we have shown how to prepare such a plot.

Subsequent seasons are marked with different colors. Is there any global tendency/trend apparent from those results?

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=7, fig.height=4}
library(dplyr)
library(ggvis)
serialeIMDB %>%
  filter(serial == "Breaking Bad") %>%
  mutate(sezon = droplevels(sezon)) %>%
    ggvis(x = ~id, y = ~ocena, fill = ~sezon) %>%
    # alternatively group_by(sezon)
    layer_text(text := ~nazwa, opacity=0, fontSize:=1) %>%
    layer_points(fillOpacity:=0.8) 
```

---

# How does a trend look in the series?

Let's supplement the plot with the linear trend line best adjusted to the data. 

Now it is easier to notice the growth tendency, and what's more, we can read the growth pace from the plot.

But how was this line determined? What does "best adjusted to the data" mean?

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=7, fig.height=4}
  serialeIMDB %>%
  filter(serial == "Breaking Bad") %>%
  mutate(sezon = droplevels(sezon)) %>%
    ggvis(x = ~id, y = ~ocena, fill = ~sezon) %>%
    # alternatively group_by(sezon)
    layer_text(text := ~nazwa, opacity=0, fontSize:=1) %>%
    layer_points(fillOpacity:=0.8) %>%
    layer_model_predictions(model = "lm") 
```

---

# How to find the linear trend?

The issue of finding the linear trend may be presented in a number of ways. Below, we'll present it as an optimization issue.

We assume that the trend is linear, which means we can present it with an equation: $a_0 + a_1 * numerOdcinka$, where vaues $a_0$ and $a_1$ are unknown.

How to determine them? We want the linear line to be as close as possible to the data. 

But what does as close as possible mean? 

There are many ways to determine the measure of closeness, but most commonly used is the following:

* For the `i` episode, which is point with ($i$, $ocena_i$) coordinates, we count the distance from the trend line as 
$$
niedopasowanie_i = (ocena_i - (a_0 + a_1 * i))^2
$$
* Mismatch across the trend curve (usually labeled as RSS, acronym of _Residual Sum of Squares_) is calculated as the sum of mismatches for each point
$$
RSS = \sum_i niedopasowanie_i = \sum_i (ocena_i - (a_0 + a_1 * i))^2
$$
* Ratings of the trend line factors $\hat a_0$ i $\hat a_1$ are determined in a way which minimizes the RSS mismatch. 

To derive the formula for the factors, it is good to at least know the calculus (it is then sufficient to calculate the derivative and then compare it to zero). 

To determine the values of these factors in the R program is sufficient to use the `lm()` function.

---

# How to determine linear trend factors in the R program

Let's prepare `tylkoBreakingBad` data set in which there will only be `id` and `ocena` variable values for the episodes of `Breaking Bad` series.

More about how the `filter()` and `select()` functions work can be found in the first season.

```{r}
# select only two columns and rows for a single series
tylkoBreakingBad <- serialeIMDB %>%
  filter(serial == "Breaking Bad") %>% 
  select(id, ocena)
# inital 6 rows from the created data frame
head(tylkoBreakingBad)
```

---

# How to determine linear trend factors in the R program

For determining the linear trend we use the `lm()` function (named after *linear model*).

The `lm()` function as the first argument accepts a formula describing between which variables do we want to determine the relationship, and as the second argument indicates the data set.

The formula has `~` (tilde) symbol, on the left side of which we indicate the variable that we want to describe (the so-called dependent variable), and on the right side we indicate the independent variable.

```{r}
lm(ocena~id, tylkoBreakingBad)
```

The result of the `lm()` function is a multiple information list. The factors of the model can be found in the attribute named `coef`.

```{r}
lm(ocena~id, tylkoBreakingBad)$coef
```

The `(Intercept)` value is a $\hat a_0$ factor, and `id` is a $\hat a_1$ factor. 

# How to determine linear trend factors in the R program

Thus, for the `Breaking Bad` series, the line which minimizes RSS has the following formula
$$
ocena =  7.90222  +  0.01836 * id
$$

How to read this equation?

For `id` we must substitute the episode number in order to read the rating estimate of the episode.

For example, for the first episode `id=1`, so the start rating estimate is
$$
ocena_1 =  7.90222  +  0.01836 = 7.92058
$$

Per episode, mean value of rating difference is 0.01836. 

Thus, after 62 episodes, adjusted trend estimates the popularity of the season's finish as

$$
ocena_{62} =  7.90222  +  62*0.01836 = 9.04054
$$

Using those mean values we obviously have to consider that although straight line is an adjustment, it is not perfect. 
How to adjust the more complex models - we'll write about it in the next episodes.

---

# How does the trend development for your favorite series look like?

By using the following application we can analyze ratings of subsequent series and review their popularity trend.

If the application turns itself off (it's greyed), you should refresh this website in your browser.

<center><iframe width="870" height="700" frameborder="0" src="https://smarterpoland.shinyapps.io/serialeIMDB"></iframe></center>

# Summary of R instructions

In this episode we discussed the functions used to determine the linear trend.

```{r, eval=FALSE}
# plotting episode ratings, package ggvis
library(PogromcyDanych)
library(ggvis)
serialeIMDB %>%
  filter(serial == "Breaking Bad") %>%
  mutate(sezon = droplevels(sezon)) %>%
    ggvis(x = ~id, y = ~ocena, fill = ~sezon) %>%
    layer_text(text := ~nazwa, opacity=0, fontSize:=1) %>%
    layer_points(fillOpacity:=0.8) 

# plot with the trend, package ggvis
  serialeIMDB %>%
  filter(serial == "Breaking Bad") %>%
  mutate(sezon = droplevels(sezon)) %>%
    ggvis(x = ~id, y = ~ocena, fill = ~sezon) %>%
    # alternatively group_by(sezon)
    layer_text(text := ~nazwa, opacity=0, fontSize:=1) %>%
    layer_points(fillOpacity:=0.8) %>%
    layer_model_predictions(model = "lm") 

# select only two columns and rows for a single series
tylkoBreakingBad <- serialeIMDB %>%
  filter(serial == "Breaking Bad") %>% 
  select(id, ocena)
# initial 6 rows of the created data frame  
head(tylkoBreakingBad)

# estimate linear trend for BreakingBad series
lm(ocena~id, tylkoBreakingBad)

# coefficients of the linear trend
lm(ocena~id, tylkoBreakingBad)$coef
```

# Exercises

* Find a TV series with the biggest ratings growth trend (as the ratings are limited by 10 it cannot be a series with the highest average rating)

* Find a TV series with the biggest drop trend


# How does a trend look in the series - Bonus

Up to this point, an impression could have arisen that perhaps the linear trend is not the only, and, moreover, perhaps not the best choice. 

The illustration below shows the trend results calculated in a more local way, so it can be seen that change of the ratings until about the 30th episode (end of the third season) was different, you could see a slight downward trend, and the change after the 30th episode (ever higher ratings) was different.

How to model such more complicated dependencies? 

We'll show in the last episode of this season 'What's next?'.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=7, fig.height=4}
serialeIMDB %>%
  filter(serial == "Breaking Bad") %>%
  mutate(sezon = droplevels(sezon)) %>%
    ggvis(x = ~id, y = ~ocena, fill = ~sezon) %>%
    # alternatively group_by(sezon)
    layer_text(text := ~nazwa, opacity=0, fontSize:=1) %>%
    layer_points(fillOpacity:=0.8) %>%
    layer_smooths() 
```

