---
title: "Multiplicative regression"
author: "data busteRs"
date: "season 2 / episode 17<br><br> All rights reserved.<br> Usage allowed only with the author's permission.  <br><br><br><br>Press `A` to turn slides into full text. <br> Press `T` to show Table of Contents."
output:
  slidy_presentation:
    includes:
      in_header: ../tracking.html
    highlight: default
    mathjax: "http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
    css: ../style.css
    font_adjustment: 0
    footer: "pogRomcy danych / modelowanie / regresja multiplikatywna"
---


# Linear regression - continued

In the last episode we have presented a model for linear dependence between height of children and parents.

However, analyzing real data, we often encounter situations in which dependence between the variables does not look linear.

In such cases, regression is also a useful tool, as such dependences can often be reduced to linear following the transformation of variables.

How? 

We'll discuss it later.

In this section, we will rely on examples concerning car prices. Let's start working by loading the data.

# Loading the data

In the `PogromcyDanych` packet there is a `auta2012` data set, on which we have already worked in the first season. It contains car sales offers of a wide variety of brands. 

In this episode we will perform a statistical analysis of this data set. However, analyzing all of the offers at once is pointless.
Therefore, further analyzes will be conducted only on a subset of the data relating to Volkswagen brand.

Why this one? It is most popular in the collected advertisements, thus there is the most observations for it. Furthermore, the results we get are interesting.

Each line of this data set describes one car sale offer. Each column describes one characteristic/attribute of this offer.

```{r, warning=FALSE, width=8, height=8, message=FALSE, warning=FALSE}
# w tym pakiecie znajduje się zbiór danych auta2012
library(PogromcyDanych)      
# funkcja filter pozostawia wybrane wiersze ze zbioru danych
volkswagen <- auta2012 %>%
  filter(Marka == "Volkswagen")
# pierwsze dwa wiersze
head(volkswagen, 2)
```

# What is the dependence?

Let's observe the dependence between price and age of the Volkswagen. 

Our data set does not have an age variable, only the year of production. Knowing that those offers were collected in January 2012, it will be easy to determine the age of the car (2012 - year of production).

So let's start with determining the car age variable (`mutate()` function in the example below), and then deleting cars more than 20 years old (`filter()` function, there isn't a lot of very old cars, and they would interfere with our modeling).

```{r, warning=FALSE}
mlodeVolkswageny <- volkswagen %>%
  mutate(Wiek = 2012 - Rok.produkcji) %>%
  filter(Wiek < 20)
```

Let's use the `lm()` function, which we learned in the last episode, to determine the linear dependence between the price and age of the car. 

```{r, warning=FALSE}
modelCenaWiek <- lm(Cena.w.PLN ~ Wiek, data=mlodeVolkswageny)
# współczynniki modelu
coef(modelCenaWiek)
```

# What is the dependence?

Knowing the factors, we can assess that the average price of a new car is 67430 according to the linear model, and the car loses per average -4220 PLN in value every year. Those two numbers are useful, but we can read even more from the plot.

Thus, we'll draw both variables and supplement them with a linear trend line.

```{r, warning=FALSE, width=8, height=6, message=FALSE, warning=FALSE}
ggplot(mlodeVolkswageny, aes(y=Cena.w.PLN, x = Wiek)) + 
  geom_point() + 
  geom_smooth(method="lm", col="red", size=2) +
  # funkcją ylim() ograniczamy zakres na osiach, by wykres był czytelniejszy
  ylim(0,400000)
```

If we'd mindlessly accept the estimation results, it would appear that the dependence between price and age is described by the following equation

$Średnia.cena = 67640.352 - 4236.639 * Wiek$

Distrust should arise in us at observation that in this equation, substituting 16 years or more for the value of the age variable will result in a negative estimate of the average price. It is one of the signs that our model is somewhat wrong.

What can we do about it?


# If not linear, then what?

When you think about it, you can easily come to the conclusion that cars depreciate in value the most in the early years, when they are the most expensive.

Older cars are already cheaper and depreciate in value to a lesser extent. This does not include antiques, but analyzed Volkswagens are not antiques (that's why we only have cars younger than 20 years).

A model that we may consider is a model in which every year cars lose a certain percentage of their price.

Such a dependence may be described as follows

$Cena.w.roku.i+1 = Cena.w.roku.i * (1-procent) = Cena.w.roku.i * wsp$

And equivalently 

$Cena.w.roku.i = Cena.w.roku.0 * (1-procent)^i = Cena.w.roku.0 * wsp^i$

Such dependences are called multiplicative. We can reduce them to linear dependences by taking logarithms of both sides (yes, logarithms come in handy).

_log(Cena.w.roku.i) = log(Cena.w.roku.0) +  log(wsp) * i_

in essence using the variable names from the data set

_log(Cena) = b0 + b1 * Wiek_

This looks like a linear model!

# Maybe logarithmic/multiplicative

First, let's see how this data will look like if we present the prices on a logarithmic scale. Adding the `scale_y_continuous()` function we change the plot axes. We add regression line to the dots.

```{r, warning=FALSE}
ggplot(mlodeVolkswageny, aes(y=Cena.w.PLN, x = Wiek)) + 
  geom_point() + 
  geom_smooth(size=2) + geom_smooth(method="lm", col="red", size=2) +
  scale_y_continuous(trans="log10")
```

On the drawing, after taking logarithms of the data, this dependence looks perfectly linear.

# Logarithmic/multiplicative in R

To build such a multiplicative model with the `lm()` function we mast first calculate logarithm of the price.

```{r, warning=FALSE}
# dodajemy nową kolumnę logCena.w.PLN
mlodeVolkswageny <- mlodeVolkswageny %>%
  mutate(logCena.w.PLN = log10(Cena.w.PLN))

# budujemy model na logarytmach
modelCenaWiek <- lm(logCena.w.PLN ~ Wiek, data=mlodeVolkswageny)
wsp <- coef(modelCenaWiek)
wsp
```

Now, if we transfer from a logarithmic scale (decimal logarithm) to the original scale, it turns out that the average output price is \(10^``4.9372375`` = ``8.6544099\times 10^{4}``\).

The second factor is ```r wsp[2]```, which means that price in the subsequent year is ```r 10^wsp[2]``` of the price in the preceding year,
thus the car per average loses 15% of its price annually.

# Piecewise linear dependence

There are situations in which the dependence between the two variables can be described not so much by a straight, but by a polygonal line, i.e. sectionally curved line. 

Example of such a dependence is a dependence between the car's mileage and age.

Before we progress with any modeling we must first look at the data.

The rule of thumb that applies to modeling is _garbage in - garbage out_. 
No matter what methods will be used if there are errors in the data then our modeling may lead to nonsensical conclusions.

Let's observe the mileage and age of the cars.

```{r, warning=FALSE, fig.width=6, fig.height=5}
ggplot(mlodeVolkswageny, aes(y=Przebieg.w.km, x = Wiek)) + 
  geom_point()
```

If we look closely, it turns out that among our offers there are cars with ridiculous mileage of more than 15 million kilometers. It clearly is a mistake. 

Let's delete all lines in which the mileage exceeds four hundred thousand kilometers.

```{r, warning=FALSE}
mlodeVolkswageny <-   auta2012 %>%
  filter(Marka == "Volkswagen") %>%
  mutate(Wiek = 2012 - Rok.produkcji) %>%
  filter(Wiek < 20) %>%
  filter(Przebieg.w.km < 400000)
```

# Piecewise linear dependence

After cleansing the data, let's once again draw a dependence between mileage and age.

In red we mark linear regression trend line, in blue we mark smoothed mean value over the years.

```{r, warning=FALSE, message=FALSE, fig.width=6, fig.height=5}
ggplot(mlodeVolkswageny, aes(y=Przebieg.w.km, x = Wiek)) + 
  geom_point()+
  geom_smooth(size=2) + geom_smooth(method="lm", col="red", size=2) 
```

Smoothed and linear trend differ significantly. What does it mean? Maybe the dependence of the data isn't linear after all.

The blue line is a smoothed trend line, locally approximating the data. When you look at it, it turns out that it presents a very interesting behavior. 

# Piecewise linear dependence

```{r, warning=FALSE, echo=FALSE, fig.width=6, fig.height=5, message=FALSE}
ggplot(mlodeVolkswageny, aes(y=Przebieg.w.km, x = Wiek)) + 
  geom_point() +
  geom_smooth(size=2) + geom_smooth(method="lm", col="red", size=2) 
```

For the first five years, the cars pile up the counter value at a very high rate, and after the fifth year, this rate drops significantly.

Are Volkswagens older than 5 years used less frequently? It is an explanation, but other, more likely, is the one that older cars are serviced less frequently, and thus their mileages are often declared values.

# Piecewise linear dependence

How to model such a polygonal curve?

We need a model, which will have a different tilt curve in the rang of up to 5 years and over 5 years.

We can build such a model as follows

_Średni przebieg = b0 + b1 * wiek[0+] + b2 * wiek[5+]_

where _wiek[5+]_ is a variable assuming value of _0_, if age is lesser than 5 and value of _wiek-5_ if age is larger than 5.

Using this additional variable, dependence between age and the mileage will be described by the _b1_ factor when age is in the range of 0-5 years, and by the _b1 + b2_ factor when age is larger than 5 years.

```{r, warning=FALSE}
mlodeVolkswageny <- mlodeVolkswageny %>%
  mutate(Wiek0 = ifelse(Wiek >= 0, Wiek, 0),
         Wiek5 = ifelse(Wiek >= 5, Wiek - 5, 0))

# model z nowymi zmiennymi
M1 <- lm(Przebieg.w.km ~ Wiek0 + Wiek5, data=mlodeVolkswageny)
M1
```

We should observe that the model above estimates mileage of new cars as _b0_.
A more natural model is that which prognoses zero mileage for the new cars. It may be done by deleting the intercept.

# Piecewise linear dependence without the intercept

After deleting the intercept we have the following model.

_Średni przebieg = b1 * wiek[0+] + b2 * wiek[5+]_

Which can be stored in the R program as

```{r, warning=FALSE}
M2 <- lm(Przebieg.w.km ~ Wiek0 + Wiek5 - 1, data=mlodeVolkswageny)
M2
```

How to read this model?

For cars less than 5 years old the average mileage increase rate observed is ```r format(round(M2$coef[1]))```km per year, but for the cars more than 5 years old the average mileage increase rate observed is ```r round(sum(M2$coef))```km per year.

Class `lm()` object allows for performing interesting operations. For example, `summary()` function allows us to check whether the elements of this model are significantly different from zero (last column of the following summary is the p-value).

```{r, warning=FALSE}
summary(M2)
```

# Models comparison

We have discussed a number of different models.

Let's display those models graphically and see which one seems the most accurate to the data.

To display how does the polygonal regression model look like we'll use the `predict()` function, which determines the average mileage for a given age according to the specified model.

Among the presented models, the blue curve looks the best, which is the `M2` model.

```{r, warning=FALSE, message=FALSE}
# sztuczny zbiór danych, na potrzeby pokazywania modeli
topred <- data.frame(Wiek0 = c(0, 5, 20), Wiek5 = c(0, 0, 15))
topred$M1 <- predict(M1, newdata = topred)
topred$M2 <- predict(M2, newdata = topred)

# graficznie predstawiamy dane i dorysowane do nich modele
ggplot(mlodeVolkswageny, aes(y=Przebieg.w.km, x = Wiek)) + 
  geom_point() + 
  geom_smooth(method="lm", col="red", size=2) +
  geom_line(data= topred, aes(y=M1, x = Wiek0), size=2, col="green") + 
  geom_line(data= topred, aes(y=M2, x = Wiek0), size=2, col="blue")
```

# Tasks

+ ???Perform modeling using multiplicative model for another brand.
+ ???If the multiplicative model seems legitimate, calculate by what percentage the car's price decreases annually.
+ ???Review how does the dependence between price and age look like for other brands. Ten most frequent brands in this data set are ```r paste(collapse=", ", names(head(rev(sort(table(auta2012$Marka))),10)))```
+ ???Perform modeling using polygonal regression for other brands.


