---
title: "Regresja prosta"
author: "pogRomcy danych"
date: "sezon 2 / odcinek 16<br><br><a href='http://biecek.pl/'>Przemysław Biecek @ Uniwersytet Warszawski</a><br><br>Naciśnij `A` by zamienić slajdy na ciągły tekst. <br> Naciśnij `T` by wyświetlić spis treści."
output:
  slidy_presentation:
    includes:
      in_header: ../tracking.html
    highlight: default
    css: ../style.css
    font_adjustment: 0
    footer: "pogRomcy danych / modelowanie / regresja prosta"
---

# Wprowadzenie

Jak myślicie, czy wzrost jest dziedziczny?

Czy dzieci wysokich rodziców są wysokie?

Pewnie tak, 
ale mam znajomego, który jest niewysoki, 165cm, ale ma bardzo wysokie dziecko.

Jak to jest, jaka część wzrostu dziecka jest zależna od wzrostu rodzica?

Dziś zmierzymy się z tym pytaniem.

Przyjrzymy się bardzo znanemu zbiorowi danych, który przedstawia zależność pomiędzy wzrostem rodzica a dziecka.

Zaczniemy od przyjrzenia się temu, jak wygląda zależność,
następnie odpowiemy na pytanie jaka część wzrostu jest odziedziczalna
a na koniec spróbujemy oszacować jaki będzie wzrost moich dzieci.

---

# Kim był Francis Galton?

Podstawy matematyczne liniowych metod analizy danych powstały na przełomie XVIII i XIX
wieku. Metody te były z początku wykorzystywane w nawigacji oraz astronomii.

Termin regresja został użyty po raz pierwszy przez Sir Francisa Galtona jeszcze
w XIX wieku. Francis Galton był człowiekiem renesansu, zajmującym się zarówno
antropologią, statystyką, jak i wieloma innymi naukami. W 1886 roku opublikował
pracę ,,Regression towards mediocrity in hereditary stature'' w The Journal of
the Anthropological Institute of Great Britain and Ireland, w której
przedstawił wyniki badań nad dziedziczeniem wzrostu. Galton zauważył, że synowie
bardzo wysokich ojców są średnio wyżsi niż synowie niższych ojców, ale ich
średni wzrost jest niższy niż średni wzrost ojców. Podobnie wzrost synów niskich
ojców jest bliższy średniej w populacji. To zjawisko nazwał ,,dążeniem do przeciętności''
lub ,,tendencją do przeciętności'' (w języku angielskim ten współczynnik
nazywa się *regression toward the mean*). Galton zaproponował równanie
opisujące zależność między wzrostem synów i ojców lub równoważnie opisujące
regresję wzrostu z pokolenia na pokolenie w kierunku wartości przeciętnej (dziś
nazwalibyśmy to równanie równaniem regresji). 

!["Francis Galton 1850". Domena publiczna via Wikimedia Commons](Francis_Galton.jpg)


# Czy wzrost rodziców się liczy?

Naszą przygodę z regresją liniową również rozpoczniemy od danych zebranych przez Galtona.
Zbiór danych nazywa się `galton`, zobaczmy kilka pierwszych obserwacji z tego zbioru.

```{r, warning=FALSE, width=8, height=8, message=FALSE}
# w tym pakiecie znajduje się zbiór danych galton
library(PogromcyDanych)      
# pierwsze 6 wierszy
head(galton)
```

W kolumnie `rodzic` przedstawiona jest średni ważony wzrost rodziców (średnia wzrostu
ojca i 1,08 wzrostu matki), a w kolumnie `syn` wzrost dorosłego syna. Wzrosty podane są w centymetrach.

# Czy wzrost rodziców się liczy?

Pytanie, które interesowało Galtona, jak również interesuje nas, to czy jest zależność pomiędzy wzrostem rodziców a dziecka.

Modelowanie zawsze rozpoczyna się od wykresu, zobaczmy więc jak ta zależność pomiędzy wzrostem dziecka a rodzica wygląda graficznie.

Do przedstawienia zależności wykorzystujemy pakiet `ggplot2` i funkcję `ggplot()`. Więcej informacji o tym, jak z tej funkcji korzystać znajduje się w pierwszych czterech odcinkach tego sezonu (poświęconych wizualizacji).

```{r, warning=FALSE, width=8, height=8}
ggplot(galton, aes(x=rodzic, y=syn)) + 
  geom_point() 
```

# Bez szumu mało widać

Ponieważ dane są zbierane z dokładnością do połowy cala, punkty dla różnych wierszy pokrywają się. Jedna kropka może oznaczać wiele par wzrost rodzica x wzrost dziecka.

Oglądając takie dane (zbieranie z niewielką precyzją), na potrzeby prezentacji warto je zaburzyć małym zastrzykiem szumu.
Zrobimy to argumentem `position = "jitter"`.

```{r, warning=FALSE, width=8, height=8}
ggplot(galton, aes(x=rodzic, y=syn)) + 
  geom_point(position = "jitter") 
```

# Jaka to zależność?

Wygląda na to, że jakaś zależność występuje, ale jaka?
Jedną z możliwości jest policzenie średniego wzrostu dziecka dla każdej grupy średniego wzrostu rodziców.

Używając operatora `%>%` (szerzej omówionego w pierwszym sezonie), średni wzrost dziecka dla każdej grupy wzrostów rodziców wyznacza się następująco.

```{r, warning=FALSE, width=8, height=8}
srednie <- galton %>%
  group_by(rodzic) %>%
  summarise(srednia = mean(syn))
# wyświetl te średnie
srednie
```

# Jaka to zależność?

Narysujmy na niebiesko wektor średnich ,,w grupach wzrostów rodziców'', w tle pokażemy wszystkie przypadki ze zbioru danych.

Pięknie! Widzimy, że im wyżsi rodzice tym średnio wyższe dzieci. 

Jednak posługiwanie się samymi średnimi jest dosyć niewygodne.
Aby opisać tą zależność należy pamiętać średnią dla każdego wzrostu rodziców.
Co więcej średnie w grupach bardzo wysokich lub bardzo niskich rodziców wyznaczane są na bazie tylko kilku obserwacji, a więc wyznaczane są niedokładnie.


```{r, warning=FALSE, width=8, height=8}
ggplot(galton, aes(x=rodzic, y=syn)) + 
  geom_point(position = "jitter") +
# poniższa funkcja dorysowuje średnie w grupach
  geom_line(data=srednie, aes(x=rodzic, y=srednia), size=2, color = "blue") + 
  geom_point(data=srednie, aes(x=rodzic, y=srednia), size=5, color = "blue") 
```


# Model liniowy

Wygodniej by było opisać zależność pomiędzy wzrostem rodzica a średnim wzrostem dziecka za pomocą mniejszej liczby parametrów, niż pamiętanie średniego wzrostu dzieci dla każdego możliwego wzrostu rodzica.

Załóżmy, że można tę zależność opisać zależnością liniową, a więc zależnością

$średni.wzrost.dziecka = b_0 + średni.wzrost.rodziców * b_1$

gdzie $b_0$ i $b_1$ to pewne nieznane wartości. 

Metoda regresji liniowej pozwala wyznaczyć te nieznane wartości.
Dokładny opis algorytmu wyznaczania tych wartości jest opisany w kolejnym punkcie, poniżej
przyjrzyjmy się, jak można to zrobić w programie R.

# Ocena współczynników

Proces wyznaczania nieznanych wartości w oparciu o model i dane nazywa się estymacją.

W programie R, do estymacji można wykorzystać funkcję `lm()` (skrót od *linear model*).

Dla modelu 
$średni.wzrost.dziecka = b_0 + średni.wzrost.rodziców * b_1$

lub używając nazw zmiennych z naszego zbioru danych
$syn = b_0 + rodzic * b_1$

Funkcja estymująca parametry wygląda następująco.

```{r, warning = FALSE, width = 8, height = 8}
lm(syn ~ 1 + rodzic, data = galton)
# osoby lubiące parametr %>% mogą też napisać
# galton %>% lm(syn ~ 1 + rodzic, data = .)
```

Funkcja `lm()` przyjmuje dwa argumenty, pierwszy to formuła opisująca przyjęty model, drugi argument wskazuje zbiór danych.

Formuła składa się z lewej strony i prawej, rozdzielonej znakiem `~`. Lewa strona opisuje zmienną, którą chcemy opisać, tzw. zmienną objaśnianą, a prawa strona składa się z zmiennych, które wykorzystujemy do opisania lewej strony, czyli zmiennych objaśniających. Zapis `1 + parent` oznacza, że średni wzrost dziecka chcemy opisać za pomocą wyrażenia $1 * b_0 + parent * b_1$,
w którym należy wyznaczyć $b_0$ i $b_1$.

# Ocena współczynników

Wynikiem funkcji `lm()` jest szczegółowy opis dopasowanego modelu. Jeżeli interesują nas jedynie oceny  $b_0$ i $b_1$, możemy się odwołać do tych ocen przez funkcję `coef()`.

```{r, warning=FALSE, width=8, height=8}
modelSynRodzic <- lm(syn ~ 1 + rodzic, data=galton)
coef(modelSynRodzic)
```

A wiec otrzymujemy model

_średni.wzrost.dziecka = 60.813 + wzrost.rodzica * 0.6463_

W formule możemy pominąć człon `1+`, jest on domyślnie dodawany do formuły, dlatego taki sam wynik otrzymamy stosując następującą instrukcję.

```{r, warning=FALSE, width=8, height=8}
# wartość 1 dodawana jest automatycznie
modelSynRodzic <- lm(syn ~ rodzic, data=galton)
coef(modelSynRodzic)
```


# Jak wygląda zależność pomiędzy wzrostem dziecka a rodzica

W powyższym toku rozumowania rozważaliśmy kilka alternatywnych modeli. Podsumujmy je tutaj. 

1. Model, w którym średni wzrost dziecka jest równy wzrostowi rodzica,
$średni.wzrost.dziecka = wzrost.rodziców$

2. Model, w którym nie ma zależności pomiędzy wzrostem rodziców a dzieci, a więc, że dla każdego wzrostu rodziców, średni wzrost dzieci jest taki sam,
$średni.wzrost.dziecka = b_0$

3. Model, w którym wzrost dziecka jest liniowo zależny od wzrostu rodziców
$średni.wzrost.dziecka = b_0 + wzrost.rodziców * b_1$

4. Model, w średni wzrost dziecka jest różny dla każdego wzrostu rodzica.

Modele te zostały uporządkowane ze względu na liczbę nieznanych parametrów. Pierwszy z powyższych modeli nie ma żadnego parametru, kolejny ma jeden parametr, kolejny dwa a ostatni 11 parametrów.

Pokażmy jak każdy z tych czterech modeli wygląda na tle danych. Oznaczenia kolorów: pierwszy model to kolor złoty, drugi - czarny, trzeci - czerwony, czwarty - niebieski.

```{r, warning=FALSE, width=8, height=8}
ggplot(galton, aes(x=rodzic, y=syn)) + 
  geom_point(position = "jitter")+
  # model 4, dla każdej grupy wzrostu rodziców wyznaczamy średni wzrost dzieci
  geom_line(data=srednie, aes(x=rodzic, y=srednia), size=2, color = "blue") + 
  geom_point(data=srednie, aes(x=rodzic, y=srednia), size=5, color = "blue")  + 
  # model 3, do danych dopasowujemy trend liniowy
  geom_smooth(method="lm", se=FALSE, size=3, color="red") +
  # model 2, wzost dziecka jest taki jak wzrost rodzica
  geom_abline(size=2, color="gold3")+
  # model 1, wzrost dziecka nei zależy od wzrostu rodzica
  geom_abline(size=2, slope=0, intercept=mean(galton$syn))
```

# Który model wybrać?
 
Zależność wzrostu pomiędzy dzieckiem a rodzicem można opisywać różnymi modelami. Który wybrać?

Z jednej strony zbyt proste modele (1 i 2) nie opisują dobrze danych, widać na poniższym wykresie, że występuje dla nich systematyczny błąd.

Z drugiej strony, zbyt złożone modele (4) powodują, że trudno nam zrozumieć całą relację. Co  z tego, że mamy średnią dzieci dla rodziców o wzroście 170 i 172 cm, skoro nie potrafimy tej wiedzy rozszerzyć na rodziców o wzroście 171 cm?
 
Praca z modelowaniem to wybieranie modelu, który do danych pasuje dobrze, ale nie za dobrze. Często (nie zawsze) sprawdza się model liniowy.
 
```{r, warning=FALSE, width=8, height=6, echo=FALSE}
ggplot(galton, aes(x=rodzic, y=syn)) + 
  geom_point(position = "jitter")+
  # model 4, dla każdej grupy wzrostu rodziców wyznaczamy średni wzrost dzieci
  geom_line(data=srednie, aes(x=rodzic, y=srednia), size=2, color = "blue") + 
  geom_point(data=srednie, aes(x=rodzic, y=srednia), size=5, color = "blue")  + 
  # model 3, do danych dopasowujemy trend liniowy
  geom_smooth(method="lm", se=FALSE, size=3, color="red") +
  # model 2, wzost dziecka jest taki jak wzrost rodzica
  geom_abline(size=2, color="gold3")+
  # model 1, wzrost dziecka nei zależy od wzrostu rodzica
  geom_abline(size=2, slope=0, intercept=mean(galton$syn))
```


# Zadania
+ Dla każdego wzrostu rodzica ze zbioru danych `galton` wyznacz o ile średnio niższe są dzieci od rodziców

+ Mając wyznaczone parametry _b0_ i _b1_ policz oceny średniego wzrostu dziecka dla każdego średniego wzrostu rodzica

+ Wyznacz różnice pomiędzy ocenami z modelu liniowego a średnimi liczonymi osobno dla każdej grupy rodziców

+  W pakiecie `PogromcyDanych` udostępniony jest również zbiór danych `pearson` zebrany przez Pearsona. W tym zbiorze danych zebrane są wzrosty ojców i synów.

Dla tego zbioru danych wyznacz model regresji liniowej oraz narysuj zbiór danych z zaznaczoną krzywą regresji liniowej.

Czy parametry regresji liniowej w zbiorze pearsona (z wysokością ojca) różnią się od parametrów ze zbioru galtona (ze średnią wysokością rodziców)?


