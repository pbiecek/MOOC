---
title: "Trendy - testy"
author: "pogRomcy danych"
date: "sezon 2 / odcinek 5<br><br> Wszelkie prawa zastrzeżone.<br> Wykorzystanie możliwe wyłącznie za zgodą autora.  <br><br><br><br>Naciśnij `A` by zamienić slajdy na ciągły tekst. <br> Naciśnij `T` by wyświetlić spis treści."
output:
  slidy_presentation:
    includes:
      in_header: ../tracking.html
    highlight: default
    css: ../style.css
    font_adjustment: 0
    footer: "pogRomcy danych / modelowanie / trendy - test"
---

# O czym jest ten odcinek

W poprzednim odcunki poznaliśmy metodę wyznaczania trendu liniowego. 

Dzięki temu, możemy np. ocenić czy określona wartość średnio rośnie czy maleje.
Czasem jednak współczynnik $a_1$ opisujący tempo wzrostu jet bardzo bliski $0$. Możemy wtedy zadać dodatkowe pytanie, czy obserwowany wzrost nie jest wynikiem przypadkowych fluktuacji?

I tutaj pojawia się statystyka. Używając takich narzędzi jak test dla współczynnika trendu możemy ocenić na ile wielkość współczynnika wzrostu jest nieprzypadkowa.

W tym odcinku, na przykładzie danych z serwisu IMDB (Internet Movie Database), pokażemy jak działa procedura testowania trendu w danych.

---

# Dane i trend liniowy

W bazie danych o filmach IMDB (Internet Movie Database) znaleźć można dane o serialach a w szczególności średnie oceny użytkowników wystawione kolejnym odcinkom serialu.

Przykładowo, na stronie http://www.imdb.com/title/tt0903747/epdate?ref_=ttep_ql_4 znajdują się oceny serialu *Breaking Bad*.

Dane te zostały pobrane z Internetu i przygotowane tak, że teraz są dostępne w zbiorze danych `serialeIMDB` w pakiecie `PogromcyDanych`, który towarzyszy temu kursowi.

Wybierzemy z tego zbioru danych tylko wartości dla serialu `Breaking Bad`.

```{r, warning=FALSE, message=FALSE}
library(PogromcyDanych)

tylkoBreakingBad <- serialeIMDB %>%
  filter(serial == "Breaking Bad") %>% 
  select(id, ocena)

head(tylkoBreakingBad)
```

---

# Dane i trend liniowy

W poprzednim odcinku pokazaliśmy jak wyznaczyć współczynniki trendu liniowego z użyciem funkcji `lm()`.

```{r}
lm(ocena~id, tylkoBreakingBad)$coef
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=7, fig.height=4}
library(ggvis)
library(dplyr)
serialeIMDB %>%
  filter(serial == "Breaking Bad") %>%
  mutate(sezon = droplevels(sezon)) %>%
    ggvis(x = ~id, y = ~ocena, fill = ~sezon) %>%
    # ewentualnie group_by(sezon)
    layer_text(text := ~nazwa, opacity=0, fontSize:=1) %>%
    layer_points(fillOpacity:=0.8) %>%
    layer_model_predictions(model = "lm") 
```

---














[Test permutacyjny dla trendu?]


# Czy wzrost ocen dla Breaking Bad to przypadek?

Statystycy opracowali wiele testów aby porównać wartości w dwóch grupach. W większości przypadków te testy dają zbliżone wyniki, więc zamiast przedstawiać ich leksykon wyjaśnimy na jednym przykładzie na czym polega testowanie. Przedstawimy tak zwany test permutacyjny do porównywania średnich.

Pomysł na porównanie dwóch grup składa się z trzech kroków. Przedstawmy je jeden po drugim.

### Krok 1: Postaw hipotezę, określ co chcesz porównać

Będziemy testować hipotezę, czy wartości w jednym zbiorze są istotnie większe niż wartości w drugim zbiorze. 

Tę hipotezę, sformujmy w następujący sposób: *Czy obserwowana różnica pomiędzy średnimi ocenami jest wystarczająco duża, by uznać ją za istotną?*

### Krok 2: Określ miarę wielkości różnic

Ustalmy, że wielkość różnicy pomiędzy grupami będziemy mierzyć za pomocą wartości bezwzględnej z różnicy pomiędzy średnimi w obu grupach.

```{r}

# moduł różnicy średnich

```

# Czy serial Friends jest lepszy niż serial Breaking Bed?

### Krok 3: Porównaj zaobserwowaną wielkość różnicy z różnicą w sytuacji gdyby grupy nie były różne

Wciąż nie wiemy, czy `0.02628083` to duża różnica czy mała. Musimy ją z czymś porównać.
Najlepiej by było porównać ją z wartościami, które byśmy obserwowali gdyby te dwie grupy się nie różniły. 

Ale skąd wiadomo jakie byłyby różnice gdyby obie grupy się nie różniły? 
Możemy to oszacować w następujący sposób

* [I] Wymieszamy losowo wartości w obu grupach zachowując liczebność grup. Dzięki temu otrzymamy dwie grupy o których wiemy, że się nie różnią istotnie a jedyne różnice wynikają z losowych fluktuacji,
* [II] Policzymy jak duża jest różnica dla tych nowo wylosowanych grup,
* [III] Powtórzymy kroki [I] i [II] wielokrotnie aby zobaczyć jak duże wartości może przyjmować ta różnica w sytuacji gdy obie grupy nie różnią się od siebie.

To liczenie różnic na próbach różniących się jedynie losową fluktuacją jest realizowane przez poniższy kod.


```{r, eval=FALSE}
liczbaFriends <- length(ocenyFriends)

roznice <- replicate(100000, {
  # wymeiszaj losowo wartości
  wymieszane <- sample(c(ocenyFriends, ocenyBreakingBad))
  # losowo dobrane repliki próby
  oceny1 <- wymieszane[1:liczbaFriends]
  oceny2 <- wymieszane[-(1:liczbaFriends)]
  # różnica pomiedzy losowymi grupami
  abs(mean(oceny1) - mean(oceny2))
})
```

# Czy serial Friends jest lepszy niż serial Breaking Bed?

Możemy teraz wartość `obserwowana_roznica` porównać z wektorem wartości `roznice`. 
Wektor różnice opisuje jakich różnic spodziewać się możemy gdy próby różnią się wyłącznie losową fluktuacja. Gdyby `obserwowana_roznica` była znacząco większa niż wartości z wektora różnice, to byłby to silny argument za tym, że różnica w średnich nie jest przypadkowa.

Porównajmy na wykresie wielkości różnic dla losowych fluktuacji (na szaro) z obserwowaną różnicą (na czerwono).

```{r, eval=FALSE}
hist(roznice, 50, col="grey", main="", las=1, border="white")
abline(v=obserwowana_roznica, col="red", lwd=5)
```

# Czy serial Friends jest lepszy niż serial Breaking Bed?

Wykres pomaga w zrozumieniu tego rozkładu, ale aby podjąć decyzje lepiej mieć jedną liczbę. Policzmy jaka część różnic dla losowych fluktuacji jest większa niż obserwowana różnica.

```{r, eval=FALSE}
mean(roznice > obserwowana_roznica) + 1/100000
```





















---

# Zadania

* Znajdź serial o najsilniej rosnącym trendzie dotyczącym ocen (ponieważ oceny są ograniczone z góry przez 10 to może nie być serial o najwyższej średniej ocenie)

* Znajdź serial o najsilniejszym trendzie spadkowym


