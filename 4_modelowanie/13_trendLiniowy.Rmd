---
title: "Trendy w danych"
author: "pogRomcy danych"
date: "sezon 2 / odcinek 13<br><br><a href='http://biecek.pl/'>Przemysław Biecek @ Uniwersytet Warszawski</a><br><br>Naciśnij `A` by zamienić slajdy na ciągły tekst. <br> Naciśnij `T` by wyświetlić spis treści."
output:
  slidy_presentation:
    includes:
      in_header: ../tracking.html
    highlight: default
    css: ../style.css
    font_adjustment: 0
    footer: "pogRomcy danych / modelowanie / trendy"
---

# O czym jest ten odcinek?


Analizując dane, często trafiamy na sytuację, gdy mamy sekwencje liczb i chcemy ocenić czy widać w niej trend.

Analizując zużycie energii możemy sprawdzać czy występuje rosnący trend zapotrzebowania na energię. Jeżeli pracujemy z danymi o sprzedaży biletów może interesować nas trend w liczbie sprzedanych biletów.

Jednak nawet gdy występuje widoczny trend, bardzo rzadko wartości układają się idealnie w linię prostą. Zazwyczaj trend jest zanurzony w dużych fluktuacjach. 

Jak więc oszacować z jakim trendem mamy do czynienia?

Tutaj pojawia się statystyka. Używając takich narzędzi jak regresja liniowa czy nieliniowa możemy ocenić jakie są parametry trendu. Dla uproszczenia w tym odcinku skupimy się na trendzie liniowym.

Oczywiście nie zawsze tendencje układają się w liniowy wzrost lub liniowy spadek. Potraktujemy więc prace z trendem liniowym jako pierwszy krok, zanim zaczniemy dopasowywać bardziej złożone zależności.

W tym odcinku, na przykładzie danych z serwisu IMDB (Internet Movie Database), pokażemy jak działa procedura wyznaczania trendu w danych.

---

# Baza danych o filmach i serialach

W bazie danych z informacjami o filmach IMDB (Internet Movie Database) znaleźć można dane o serialach. Wśród tych danych znajdują się średnie oceny internautów wystawione kolejnym odcinkom serialu.

Przykładowo, na stronie http://www.imdb.com/title/tt0903747/epdate?ref_=ttep_ql_4 znajdują się oceny serialu *Breaking Bad*.

Dane o ocenach zostały pobrane z Internetu i przygotowane tak, że teraz są dostępne w zbiorze danych `serialeIMDB` w pakiecie `PogromcyDanych`, który towarzyszy temu kursowi.

Na przykładzie tych danych poćwiczymy dopasowanie trendu liniowego do danych.

```{r, warning=FALSE, message=FALSE}
library(PogromcyDanych)
# pierwsze sześć wierszy ze zbioru danych serialeIMDB
head(serialeIMDB)
```

---

# Jak wygląda trend w serialach?

Mając taki zbiór danych, przyjrzyjmy się jak wyglądają oceny dla serialu *Breaking Bad*. 

Poniższy wykres przedstawia średnie oceny (na osi OY)  dla kolejnych odcinków (rozłożonych wzdłuż osi OX). 

Kolejne sezony są oznaczane różnymi kolorami. Czy patrząc na te wyniki widzimy jakąś globalną tendencję / trend?

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=7, fig.height=5}
library(dplyr)
library(ggvis)
serialeIMDB %>%
  filter(serial == "Breaking Bad") %>%
  mutate(sezon = droplevels(sezon)) %>%
    ggvis(x = ~id, y = ~ocena, fill = ~sezon) %>%
    # ewentualnie group_by(sezon)
    layer_text(text := ~nazwa, opacity=0, fontSize:=1) %>%
    layer_points(fillOpacity:=0.8) 
```

---

# Jak wygląda trend w serialach?

Dodajmy do wykresu linię trendu liniowego, najlepiej dopasowanego do danych. 

Patrząc na trend łatwiej zauważyć wzrostową tendencję ocen. Co więcej można odczytać tempo średniego wzrostu ocen.

Ale jak ta linia trendu została wyznaczona? Co to znaczy ,,najlepiej dopasowany do danych''?

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=7, fig.height=5}
  serialeIMDB %>%
  filter(serial == "Breaking Bad") %>%
  mutate(sezon = droplevels(sezon)) %>%
    ggvis(x = ~id, y = ~ocena, fill = ~sezon) %>%
    # ewentualnie group_by(sezon)
    layer_text(text := ~nazwa, opacity=0, fontSize:=1) %>%
    layer_points(fillOpacity:=0.8) %>%
    layer_model_predictions(model = "lm") 
```

---

# Jak szukać trendu liniowego?

Problem znajdowania trendu liniowego można przedstawić na wiele sposobów. Poniżej przedstawimy go jako zagadnienie optymalizacji.

Trend liniowy można przedstawić za pomocą równania liniowego $a_0 + a_1 * numerOdcinka$. 

Wartości $a_0$ i $a_1$ są nieznane i należy je wyznaczyć z danych.

*Ale jak je wyznaczyć?*

Chcielibyśmy, żeby linia trendu była jak najbliżej danych. 

*Ale co to znaczy jak najbliżej?* 

Jest wiele sposobów określania miary bliskości. Najczęściej używany jest następujący:

* Dla odcinka `i`, czyli punktu o współrzędnych ($i$, $ocena_i$) odległość od lini trendu liczymy jako 
$$
niedopasowanie_i(a_0, a_1) = (ocena_i - (a_0 + a_1 * i))^2
$$
* Niedopasowanie całej krzywej trendu (oznaczane zazwyczaj jako RSS, skrót od _Residual Sum of Squares_) liczymy jako sumę niedopasowań dla każdego punktu
$$
RSS(a_0, a_1) = \sum_i niedopasowanie_i = \sum_i (ocena_i - (a_0 + a_1 * i))^2
$$
* Oceny współczynników linii trendu $\hat a_0$ i $\hat a_1$ wyznacza się w ten sposób by minimalizowały niedopasowanie $RSS(a_0, a_1)$. 

Aby wyprowadzić wzór na te współczynniki dobrze znać przynajmniej rachunek różniczkowy. Wystarczy wtedy policzyć pochodne po $a_i$ i przyrównać je do zera (co nie jest trudne bo mamy do czynienia z wielomianem drugiego stopnia, przykładowe wyprowadzenie jest przedstawione na wikipedii http://en.wikipedia.org/wiki/Simple_linear_regression). 

Aby wyznaczyć wartości tych współczynników w programie R wystarczy wykorzystać funkcję `lm()`.

---

# Jak wyznaczyć współczynniki trendu liniowego w programie R

Przygotujmy zbiór danych `tylkoBreakingBad` w którym będą tylko wartości zmiennych `id` i `ocena` dla odcinków z serialu `Breaking Bad`.

Wykorzystamy funkcje `filter()` i `select()`, więcej o tym jak one działają można przeczytać w pierwszym sezonie Pogromców.

```{r}
# wybierz z danych tylko dwie kolumny i dla jednego wybranego serialu
tylkoBreakingBad <- serialeIMDB %>%
  filter(serial == "Breaking Bad") %>% 
  select(id, ocena)
```
Pierwsze 6 wierszy z nowo przygotowanego zbioru danych.
```{r}
head(tylkoBreakingBad)
```

---

# Jak wyznaczyć współczynniki trendu liniowego w programie R?

Do wyznaczenia trendu liniowego wykorzystujemy funkcję `lm()` (nazwa od *linear model* czyli model liniowy).

Funkcja `lm()` jako pierwszy argument przyjmuje formułę opisująca pomiędzy którymi zmiennymi chcemy wyznaczyć relację, a jako drugi argument wskazuje zbiór danych.

Centralnym symbolem w formule jest znak `~` (tylda). Po jego lewej stronie wskazuje się zmienną którą chcemy opisać (tak zwaną zmienną objaśnianą), a po prawej stronie podaje się zmienną objaśniającą. 

My chcemy opisać średnią ocenę jako funkcję numeru odcinka. Wybieramy tylko dane dla *Breaking Bad*.

```{r}
lm(ocena~id, tylkoBreakingBad)
```

Wynik funkcji `lm()` jest listą z wieloma polami. Współczynniki modelu znajdują się w elemencie o nazwie `coef`.

```{r}
lm(ocena~id, tylkoBreakingBad)$coef
```

Wartość `(Intercept)` to ocena współczynnika $a_0$ a `id` to ocena współczynnika $a_1$.

# Jaka to relacja?

Tak więc dla serialu `Breaking Bad` linia, która minimalizuje błąd RSS ma równanie
$$
ocena =  7.90222  +  0.01836 * id
$$

Jak czytać to równanie?

Za `id` należy podstawiać numer odcinka aby odczytać oszacowanie średniej oceny danego odcinka wynikającej z dopasowanego trendu liniowego.

Przykładowo, dla odcinka pierwszego `id=1`, a wiec oszacowanie startowej oceny z wykorzystaniem trendu liniowego to
$$
ocena_1 =  7.90222  +  0.01836 * 1 = 7.92058
$$

Zmienna $a_1$ opisuje średnią zmianę oceny co odcinek. Zgodnie z oszacowanymi wartościami, średnia zmiana oceny wynosi 0.01836. 

I tak po 62 odcinkach, dopasowany trend szacuje popularność końcówki sezonu na

$$
ocena_{62} =  7.90222  +  62*0.01836 = 9.04054
$$

Korzystając z tych średnich, musimy oczywiście mieć na uwadze, że linia prosta to pewne przybliżenie danych, ale niekoniecznie idealne. 

Jak dopasowywać bardziej złożone modele? O tym napiszemy w kolejnych odcinkach.

---

# Jak wygląda rozwój trendu w ocenach dla Twojego ulubionego serialu?

Używając poniższej aplikacji można przyjrzeć się ocenom kolejnych seriali i sprawdzić czy i jak wygląda trend w ich popularności.

Jeżeli aplikacja się wyłączyła (jest szara), to należy odświeżyć tę stronę w przeglądarce.

<center><iframe width="870" height="700" frameborder="0" src="http://beta.icm.edu.pl/IMDB/"></iframe></center>

# Podsumowanie instrukcji R

W tym odcinku omawialiśmy funkcje służące do wyznaczania trendu liniowego.

```{r, eval=FALSE}
# wykres z ocenami odcinków, pakiet ggvis
library(PogromcyDanych)
library(ggvis)
serialeIMDB %>%
  filter(serial == "Breaking Bad") %>%
  mutate(sezon = droplevels(sezon)) %>%
    ggvis(x = ~id, y = ~ocena, fill = ~sezon) %>%
    layer_text(text := ~nazwa, opacity=0, fontSize:=1) %>%
    layer_points(fillOpacity:=0.8) 

# wykres z trendem, pakiet ggvis
  serialeIMDB %>%
  filter(serial == "Breaking Bad") %>%
  mutate(sezon = droplevels(sezon)) %>%
    ggvis(x = ~id, y = ~ocena, fill = ~sezon) %>%
    # ewentualnie group_by(sezon)
    layer_text(text := ~nazwa, opacity=0, fontSize:=1) %>%
    layer_points(fillOpacity:=0.8) %>%
    layer_model_predictions(model = "lm") 

# wybierz tylko dwie kolumny i wiersze dla jednego serialu
tylkoBreakingBad <- serialeIMDB %>%
  filter(serial == "Breaking Bad") %>% 
  select(id, ocena)
# pierwsze 6 wierszy z nowo przygotowanego zbioru danych
head(tylkoBreakingBad)

# wyznacz trend liniowy dla serialu BreakingBad
lm(ocena~id, tylkoBreakingBad)

# odczytaj z trendu liniowego współczynniki trendu
lm(ocena~id, tylkoBreakingBad)$coef
```

# Zadania

* Znajdź serial o najsilniej rosnącym trendzie dotyczącym ocen (ponieważ oceny są ograniczone z góry przez 10 to może nie być serial o najwyższej średniej ocenie)

* Znajdź serial o najsilniejszym trendzie spadkowym


# Jak wygląda trend w serialach - Bonus

Do tego miejsca mogło się zrodzić wrażenie, że być może trend liniowy to nie jedyny a może nawet nie najlepszy wybór. 

Poniższa ilustracja prezentuje wyniki trendu liczonego w sposób bardziej lokalny, dzięki czemu, można zauważyć, że inna była zmiana ocen do około 30 odcinka (końca trzeciego sezonu), widać było lekką spadkową tendencję, a inna była zmiana po 30 odcinku (coraz to wyższe oceny).

Jak modelować takie, bardziej złożone zależności? 

Pokażemy w ostatnim odcinku tego sezonu ,,Co dalej?''.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=7, fig.height=4}
serialeIMDB %>%
  filter(serial == "Breaking Bad") %>%
  mutate(sezon = droplevels(sezon)) %>%
    ggvis(x = ~id, y = ~ocena, fill = ~sezon) %>%
    # ewentualnie group_by(sezon)
    layer_text(text := ~nazwa, opacity=0, fontSize:=1) %>%
    layer_points(fillOpacity:=0.8) %>%
    layer_smooths() 
```


