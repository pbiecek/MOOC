---
title: "Modelowanie / regresja multiplikatywna"
output:
  html_document:
    toc: yes
---

# Regresja liniowa - kontynuacja

Analizując rzeczywiste dane, często możemy spotkać sytuacje w których zależność pomiędzy zmiennymi nie wygląda na liniową.
Również w takich sytuacjach regresja jest użytecznym narzędziem, ponieważ często zależności można sprowadzić do liniowych 
wykonując transformacje zmiennych.

Jak? O tym poniżej.

W tej części będziemy bazować na przykładach dotyczących cen samochodów. Wczytajmy dane.

## Wczytanie danych

W naszym zbiorze danych znajdują się oferty sprzedaży bardzo różnych marek. 
Analizowanie ich wszystkich w jednym worku nie ma sensu. 
Dlatego dalsze analizy przeprowadzimy na podzbiorze danych dotyczącym marki Volkswagen.
Dlaczego tej? Jest ona najpopularniejsza w zebranych ogłoszeniach.

```{r, warning=FALSE, width=8, height=8}
library(SmarterPoland)      # w tym pakiecie znajduje się zbiór danych auta2012
volkswagen <- auta2012 %>%
  filter(Marka == "Volkswagen")
head(volkswagen, 2)
```

Każdy wiersz tego zbioru danych opisuje jedną ofertę sprzedaży auta. Każda kolumna opisuje jedną cechę / właściwość tej oferty.

## Jaka to zależność?

Zobaczmy jak wygląda zależność ceny of wieku volkswagena. 
W naszym zbiorze danych nie ma zmiennej wiek, jest jedynie wiek produkcji.
Wiedząc, że te oferty były zbierane w styczniu 2012 roku łatwo nam będzie wyznaczyć wiek auta.
Zacznijmy więc od wyznaczenia zmiennej wiek auta, a następnie usunięcia aut ponad 20 letnich 
(mało ich jest i będą nam przeszkadzać w modelowaniu).

```{r, warning=FALSE}
volkswagen <- volkswagen %>%
  mutate(Wiek = 2012 - Rok.produkcji) %>%
  filter(Wiek < 20)
```

Wykorzystamy funkcję `lm()`, którą poznaliśmy w poprzednim module, do wyznaczenia zależności pomiędzy 
ceną a wiekiem auta. 

Narysujemy też te dwie zmienne dorysowując do nich linię trendu liniowego.

```{r, warning=FALSE}
lm(Cena.w.PLN ~ Wiek, data=volkswagen)$coef

ggplot(volkswagen, aes(y=Cena.w.PLN, x = Wiek)) + 
  geom_point() + 
  geom_smooth(method="lm", col="red", size=2) +
  ylim(0,400000)
```

Gdyby bezrefleksyjnie przyjąć wyniki estymacji, okazałoby się, że zależność pomiędzy ceną a wiekiem opisana jest przez równanie
_Średnia cena = 67640.352 - 4236.639 * Wiek_

Nieufność powinna w nas wzbudzić obserwacja, że podstawiając do tego wzoru za wiek 16 lub więcej lat, okaże się, że otrzymujemy oszacowanie średniej ceny ujemne. Jest to jeden z sygnałów, że coś jest nie tak z naszym modelem.

### Zadania:
+ Czy Volkswagen jest wyjątkowy pod tym względem? Zobacz jak wygląda zależność pomiędzy ceną a wiekiem dla innych marek. Dziesięć najczęstszych marek w tym zbiorze danych to ```r paste(collapse=", ", names(head(rev(sort(table(auta2012$Marka))),10)))```

### Odpowiedzi:
```{r, warning=FALSE}
toyota <- auta2012 %>%
  filter(Marka == "Toyota") %>%
  mutate(Wiek = 2012 - Rok.produkcji) %>%
  filter(Wiek < 20)

lm(Cena.w.PLN ~ Wiek, data=toyota)$coef

ggplot(toyota, aes(y=Cena.w.PLN, x = Wiek)) + 
  geom_point() + 
  geom_smooth(method="lm", col="red", size=2) +
  ylim(0,400000)
```



## Jeżeli nie liniowa, to jaka?

Gdy się zastanowić, łatwo dojść do wniosku, że auta tracą na wartości najwięcej w pierwszych latach, gdy są najdroższe.
Starsze auta są już tańsze i mniej tracą na wartości. Nie dotyczy to antyków, ale analizowane volkswageny nie są antykami (dlatego mamy tylko auta młodsze niż 20 lat).

Model, który możemy rozważyć, to model w którym co roku auta tracą pewien procent swojej ceny.
Taką zależność można opisać jako

_Cena.w.roku.i+1 = Cena.w.roku.i * (1-procent) = Cena.w.roku.i * wsp_

i równoważnie 

_Cena.w.roku.i = Cena.w.roku.0 * (1-procent)^i = Cena.w.roku.0 * wsp^i_

Takie zależności nazywamy multiplikatywnymi. Można je sprowadzić co zależności liniowych logarytmując obie strony.
(Tak, logarytmy się przydają).

_log(Cena.w.roku.i) = log(Cena.w.roku.0) +  log(wsp) * i_

czyli zmieniając zapis

_log(Cena) = b0 + b1 * Wiek_

A to już wygląda jak model liniowy!

Zobaczmy najpierw, jak te dane wyglądać będą,
jeżeli ceny przedstawimy w skali logarytmicznej.

```{r, warning=FALSE}
ggplot(volkswagen, aes(y=Cena.w.PLN, x = Wiek)) + 
  geom_point() + 
  geom_smooth(size=2) + geom_smooth(method="lm", col="red", size=2) +
  scale_y_continuous(trans="log10")
```

Na rysunku ta zależność wygląda na liniową.

Zobaczmy jak wykonać model liniowy z użyciem funkcji `lm()`.
Wpierw musimy policzyć logarytm ceny.

```{r, warning=FALSE}
volkswagen <- volkswagen %>%
  mutate(logCena.w.PLN = log10(Cena.w.PLN))

(wsp = lm(logCena.w.PLN ~ Wiek, data=volkswagen)$coef)
```

Jeżeli przejść teraz ze skali logarytmicznej (logarytm dziesiętny) na oryginalną skalę, 
to okaże się, że średnia cena wyjściowa to `10^```r wsp[1]``` = ```r 10^wsp[1]````.

Drugi współczynnik wynosi ```r wsp[2]```, co oznacza, że cena w kolejnym roku to ```r 10^wsp[2]``` ceny z poprzedniego roku, 
czyli przecietnie, corocznie auto traci 15% swojej ceny.


### Zadania:
+ Wykonaj modelowanie z użyciem modelu multiplikatywnego dla innej marki. 
+ Jeżeli model multiplikatywny wygląda na uzasadniony, policz ile procent corocznie traci na cenie auto danej marki.

### Odpowiedzi:
```{r, warning=FALSE, fig.width=4, fig.height=4}
marki <- names(head(rev(sort(table(auta2012$Marka))),10))
sapply(marki, function(marka) {
  wybranamarka <- auta2012 %>%
    filter(Marka == marka) %>%
    mutate(Wiek = 2012 - Rok.produkcji) %>%
    filter(Wiek < 20) %>%
    mutate(logCena.w.PLN = log10(Cena.w.PLN))
  
  ggplot(wybranamarka, aes(y=Cena.w.PLN, x = Wiek)) + 
    geom_point() + 
    geom_smooth(method="lm", col="red", size=2) +
    ylim(0,400000) + ggtitle(marka)
  
  wsp <- lm(logCena.w.PLN ~ Wiek, data=wybranamarka)$coef
  procent <- 1- 10^(wsp[2])
  round(100*procent,1)
} )
```











## Przebieg a wiek auta



Przyjrzymy się jak modelować zależność pomiędzy dwoma zmiennymi, przebiegiem samochodu oraz jego wiekiem.


Przyjrzyjmy się zależności pomiędzy przebiegiem a rokiem produkcji

### Czyszczenie danych

Zanim rozpoczniemy jakiekolwiek modelowanie musimy wpierw przyjrzeć się danym.

W modelowaniu obowiązuje żelazna zasada _śmieci na wejściu — śmieci na wyjściu_ (ang. garbage in, garbage out). 
Bez względu na to jakie metody będziemy wykorzystywać, jeżeli w danych są błędy to nasze modelowanie prowadzić może do bezsensownych wniosków.

```{r, warning=FALSE}
library(ggplot2)
ggplot(auta2012, aes(y=Przebieg.w.km, x = Rok.produkcji)) + 
  geom_point()
```

Wszystkie oferty sprzedaży pochodzą z 2011 roku. Policzmy wiek auta, usuńmy auta o absurdalnym przebiedu ponad 1 milion kilometrów oraz usuńmy auta starsze niż 20 lat.

```{r, warning=FALSE}

library(dplyr)
auta2012wyczyszczone <- auta2012 %>%
  mutate(Wiek = 2012 - Rok.produkcji) %>%
  filter(Przebieg.w.km < 1000000,
         Rok.produkcji > 1990,
         Marka == "Volkswagen")

ggplot(auta2012wyczyszczone, aes(y=Przebieg.w.km, x = Wiek)) + 
  geom_smooth(size=2) + geom_smooth(method="lm", col="red", size=2) 

```

Konkurencyjne modele

```{r, warning=FALSE}

summary(lm(Przebieg.w.km ~ Wiek - 1, data=auta2012wyczyszczone))
summary(lm(Przebieg.w.km ~ Wiek, data=auta2012wyczyszczone))

auta2012wyczyszczone <- auta2012wyczyszczone %>%
  mutate(Wiekponizej5 = ifelse(Wiek < 5, Wiek, 5),
         Wiekpowyzej5 = ifelse(Wiek >= 5, Wiek, 0))

summary(lm(Przebieg.w.km ~ Wiekponizej5 + Wiekpowyzej5, data=auta2012wyczyszczone))
M <- summary(lm(Przebieg.w.km ~ Wiekponizej5 + Wiekpowyzej5 - 1, data=auta2012wyczyszczone))

pred <- data.frame(Wiek = c(0,5,20), Przebieg.w.km = c(0,5*M$coefficients[1,1],20*M$coefficients[2,1]+5*M$coefficients[1,1]))

ggplot(auta2012wyczyszczone, aes(y=Przebieg.w.km, x = Wiek)) + 
  geom_point() + 
  geom_smooth(size=2) + geom_smooth(method="lm", col="red", size=2) +
  geom_line(data= pred, aes(y=Przebieg.w.km, x = Wiek), size=2, col="green")

```


### Zadania:
+ 

### Odpowiedzi:
+ 

