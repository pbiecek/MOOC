---
title: "Modelowanie / regresja multiplikatywna"
output:
  html_document:
    toc: yes
---

# Regresja liniowa - kontynuacja

Analizując rzeczywiste dane, często możemy spotkać sytuacje w których zależność pomiędzy zmiennymi nie wygląda na liniową.
Również w takich sytuacjach regresja jest użytecznym narzędziem, ponieważ często zależności można sprowadzić do liniowych 
wykonując transformacje zmiennych.

Jak? O tym poniżej.

W tej części będziemy bazować na przykładach dotyczących cen samochodów. Wczytajmy dane.

## Wczytanie danych

W naszym zbiorze danych znajdują się oferty sprzedaży bardzo różnych marek. 
Analizowanie ich wszystkich w jednym worku nie ma sensu. 
Dlatego dalsze analizy przeprowadzimy na podzbiorze danych dotyczącym marki Volkswagen.
Dlaczego tej? Jest ona najpopularniejsza w zebranych ogłoszeniach.

```{r, warning=FALSE, width=8, height=8}
library(SmarterPoland)      # w tym pakiecie znajduje się zbiór danych auta2012
volkswagen <- auta2012 %>%
  filter(Marka == "Volkswagen")
head(volkswagen, 2)
```

Każdy wiersz tego zbioru danych opisuje jedną ofertę sprzedaży auta. Każda kolumna opisuje jedną cechę / właściwość tej oferty.

## Jaka to zależność?

Zobaczmy jak wygląda zależność ceny of wieku volkswagena. 
W naszym zbiorze danych nie ma zmiennej wiek, jest jedynie wiek produkcji.
Wiedząc, że te oferty były zbierane w styczniu 2012 roku łatwo nam będzie wyznaczyć wiek auta.
Zacznijmy więc od wyznaczenia zmiennej wiek auta, a następnie usunięcia aut ponad 20 letnich 
(mało ich jest i będą nam przeszkadzać w modelowaniu).

```{r, warning=FALSE}
volkswagen <- volkswagen %>%
  mutate(Wiek = 2012 - Rok.produkcji) %>%
  filter(Wiek < 20)
```

Wykorzystamy funkcję `lm()`, którą poznaliśmy w poprzednim module, do wyznaczenia zależności pomiędzy 
ceną a wiekiem auta. 

Narysujemy też te dwie zmienne dorysowując do nich linię trendu liniowego.

```{r, warning=FALSE}
lm(Cena.w.PLN ~ Wiek, data=volkswagen)$coef

ggplot(volkswagen, aes(y=Cena.w.PLN, x = Wiek)) + 
  geom_point() + 
  geom_smooth(method="lm", col="red", size=2) +
  ylim(0,400000)
```

Gdyby bezrefleksyjnie przyjąć wyniki estymacji, okazałoby się, że zależność pomiędzy ceną a wiekiem opisana jest przez równanie
_Średnia cena = 67640.352 - 4236.639 * Wiek_

Nieufność powinna w nas wzbudzić obserwacja, że podstawiając do tego wzoru za wiek 16 lub więcej lat, okaże się, że otrzymujemy oszacowanie średniej ceny ujemne. Jest to jeden z sygnałów, że coś jest nie tak z naszym modelem.

### Zadania:
+ Czy Volkswagen jest wyjątkowy pod tym względem? Zobacz jak wygląda zależność pomiędzy ceną a wiekiem dla innych marek. Dziesięć najczęstszych marek w tym zbiorze danych to ```r paste(collapse=", ", names(head(rev(sort(table(auta2012$Marka))),10)))```

### Odpowiedzi:
```{r, warning=FALSE}
toyota <- auta2012 %>%
  filter(Marka == "Toyota") %>%
  mutate(Wiek = 2012 - Rok.produkcji) %>%
  filter(Wiek < 20)

lm(Cena.w.PLN ~ Wiek, data=toyota)$coef

ggplot(toyota, aes(y=Cena.w.PLN, x = Wiek)) + 
  geom_point() + 
  geom_smooth(method="lm", col="red", size=2) +
  ylim(0,400000)
```



## Jeżeli nie liniowa, to jaka?

Gdy się zastanowić, łatwo dojść do wniosku, że auta tracą na wartości najwięcej w pierwszych latach, gdy są najdroższe.
Starsze auta są już tańsze i mniej tracą na wartości. Nie dotyczy to antyków, ale analizowane volkswageny nie są antykami (dlatego mamy tylko auta młodsze niż 20 lat).

Model, który możemy rozważyć, to model w którym co roku auta tracą pewien procent swojej ceny.
Taką zależność można opisać jako

_Cena.w.roku.i+1 = Cena.w.roku.i * (1-procent) = Cena.w.roku.i * wsp_

i równoważnie 

_Cena.w.roku.i = Cena.w.roku.0 * (1-procent)^i = Cena.w.roku.0 * wsp^i_

Takie zależności nazywamy multiplikatywnymi. Można je sprowadzić co zależności liniowych logarytmując obie strony.
(Tak, logarytmy się przydają).

_log(Cena.w.roku.i) = log(Cena.w.roku.0) +  log(wsp) * i_

czyli zmieniając zapis

_log(Cena) = b0 + b1 * Wiek_

A to już wygląda jak model liniowy!

Zobaczmy najpierw, jak te dane wyglądać będą,
jeżeli ceny przedstawimy w skali logarytmicznej.

```{r, warning=FALSE}
ggplot(volkswagen, aes(y=Cena.w.PLN, x = Wiek)) + 
  geom_point() + 
  geom_smooth(size=2) + geom_smooth(method="lm", col="red", size=2) +
  scale_y_continuous(trans="log10")
```

Na rysunku ta zależność wygląda na liniową.

Zobaczmy jak wykonać model liniowy z użyciem funkcji `lm()`.
Wpierw musimy policzyć logarytm ceny.

```{r, warning=FALSE}
volkswagen <- volkswagen %>%
  mutate(logCena.w.PLN = log10(Cena.w.PLN))

(wsp = lm(logCena.w.PLN ~ Wiek, data=volkswagen)$coef)
```

Jeżeli przejść teraz ze skali logarytmicznej (logarytm dziesiętny) na oryginalną skalę, 
to okaże się, że średnia cena wyjściowa to `10^```r wsp[1]``` = ```r 10^wsp[1]````.

Drugi współczynnik wynosi ```r wsp[2]```, co oznacza, że cena w kolejnym roku to ```r 10^wsp[2]``` ceny z poprzedniego roku, 
czyli przecietnie, corocznie auto traci 15% swojej ceny.


### Zadania:
+ Wykonaj modelowanie z użyciem modelu multiplikatywnego dla innej marki. 
+ Jeżeli model multiplikatywny wygląda na uzasadniony, policz ile procent corocznie traci na cenie auto danej marki.

### Odpowiedzi:
```{r, warning=FALSE, fig.width=4, fig.height=4}
marki <- names(head(rev(sort(table(auta2012$Marka))),10))
sapply(marki, function(marka) {
  wybranamarka <- auta2012 %>%
    filter(Marka == marka) %>%
    mutate(Wiek = 2012 - Rok.produkcji) %>%
    filter(Wiek < 20) %>%
    mutate(logCena.w.PLN = log10(Cena.w.PLN))
  
  plot(ggplot(wybranamarka, aes(y=Cena.w.PLN, x = Wiek)) + 
    geom_point() + 
    geom_smooth(method="lm", col="red", size=2) +
    ggtitle(marka) + scale_y_continuous(trans="log10"))
  
  wsp <- lm(logCena.w.PLN ~ Wiek, data=wybranamarka)$coef
  procent <- 1- 10^(wsp[2])
  round(100*procent,1)
} )
```



## Zależność kawałkami prosta

Są sytuacje, w których zależność pomiędzy dwiema zmiennymi można opisać nie tyle przez linię prosta co przez łamaną. 

Za przykład takiej zależności posłuży nam zależność pomiędzy przebiegiem a wiekiem auta.

### Czyszczenie danych

Zanim rozpoczniemy jakiekolwiek modelowanie musimy wpierw przyjrzeć się danym.

W modelowaniu obowiązuje żelazna zasada _śmieci na wejściu — śmieci na wyjściu_ (ang. garbage in, garbage out). 
Bez względu na to jakie metody będziemy wykorzystywać, jeżeli w danych są błędy to nasze modelowanie prowadzić może do bezsensownych wniosków.

```{r, warning=FALSE}
ggplot(volkswagen, aes(y=Przebieg.w.km, x = Wiek)) + 
  geom_point()
```

Okazuje się, że są wśród naszych ofert auta o absurdalnym przebiegu ponad 15 milionów kilometrów. Usuńmy wszystkie, których przebieg przekracza czterysta tysięcy kilometrów.

```{r, warning=FALSE}
volkswagen <- volkswagen %>%
  filter(Przebieg.w.km < 400000)

ggplot(volkswagen, aes(y=Przebieg.w.km, x = Wiek)) + 
  geom_point()+
  geom_smooth(size=2) + geom_smooth(method="lm", col="red", size=2) 
```

Kolorem czerwonym zaznaczono krzywą liniowej zależności pomiędzy zmiennymi. Jak widać odstaje ona znacznie dla kilkuletnich aut.

Niebieska linia, to linia wygładzonego trendu, lokalnie przybliżającego dane. Gdy się jej przyjrzeć, okazuje się, że ma ona bardzo ciekawe zachowanie. 

Przez pierwsze pięć lat auta gwałtownie przybierają na liczniku, a po piątym roku to tempo znacząco spada.

Czy volkswagenami starszymi niż 5 lat mniej się jeździ? Jest to jakieś wytłumaczenie, ale inne, badziej prawdopodobne, jest takie że starsze auta rzadziej są serwisowane, a przez to ich przebiegi często są wartościami deklarowanymi.

W jaki sposób zamodelować taką łamaną krzywą?
Potrzebujemy modelu, który będzie miał inną krzywą nachylenia w przedziale do 5 lat i ponad 5 lat.

Można taki model zbudować w następujący sposób

_Średni przebieg = b0 + b1 * wiek[0+] + b2 * wiek[5+]_

gdzie _wiek[5+]_ to zmienna przyjmująca wartość _0_, jeżeli wiek jest mniejszy niż 5 oraz wartość _wiek-5_ gdy wiek jest większy niż 5.

Stosując taką dodatkową zmienną, zależność pomiędzy wiekiem a przebiegiem będzie opisana przez współczynnik _b1_ gdy wiek jest w przedziale 0-5 lat oraz przez współczynnik _b1 + b2_ gdy wiek jest wyższy niż 5 lat.

```{r, warning=FALSE}
volkswagen <- volkswagen %>%
  mutate(Wiek0 = ifelse(Wiek >= 0, Wiek, 0),
         Wiek5 = ifelse(Wiek >= 5, Wiek - 5, 0))

(M1 = lm(Przebieg.w.km ~ Wiek0 + Wiek5, data=volkswagen))
```

Zauważmy, że powyższy model szacuje przebieg dla nowych aut na _b0_.
Bardziej naturalnym modelem jest taki, który dla nowych aut będzie 
prognozował przebieg zero. Można to osiągnąć usuwając wyraz wolny.

_Średni przebieg = b1 * wiek[0+] + b2 * wiek[5+]_

Co w formule R można zapisać jako

```{r, warning=FALSE}
(M2 = lm(Przebieg.w.km ~ Wiek0 + Wiek5 - 1, data=volkswagen))
```

Przedstawmy te modele graficznie.
Wykorzystamy do tego funkcję predict, która wyznacza średni przebieg dla zadanego wieku.

```{r, warning=FALSE}
topred = data.frame(Wiek0 = c(0,5,20), Wiek5 = c(0, 0, 15))
topred$M1 = predict(M1, newdata = topred)
topred$M2 = predict(M2, newdata = topred)

ggplot(volkswagen, aes(y=Przebieg.w.km, x = Wiek)) + 
  geom_point() + 
  geom_smooth(method="lm", col="red", size=2) +
  geom_line(data= topred, aes(y=M1, x = Wiek0), size=2, col="green") + 
  geom_line(data= topred, aes(y=M2, x = Wiek0), size=2, col="blue")

```

### Zadania:
+ 

### Odpowiedzi:
+ 

