---
title: "Modelowanie / regresja prosta"
output:
  html_document:
    toc: yes
---

## Kim był Francis Galton?

Podstawy matematyczne liniowych metod analizy danych powstały na przełomie XVIII i XIX
wieku. Metody te były z początku wykorzystywane w nawigacji oraz astronomii.

!["Francis Galton 1850". Domena publiczna via Wikimedia Commons](Francis_Galton.jpg)

Termin regresja został użyty po raz pierwszy przez Sir Francisa Galtona jeszcze
w XIX wieku. Francis Galton był człowiekiem renesansu, zajmującym się zarówno
antropologią, statystyką, jak i wieloma innymi naukami. W 1886 roku opublikował
pracę ,,Regression towards mediocrity in hereditary stature'' w The Journal of
the Anthropological Institute of Great Britain and Ireland, w której
przedstawił wyniki badań nad dziedziczeniem wzrostu. Galton zauważył, że synowie
bardzo wysokich ojców są średnio wyżsi niż synowie niższych ojców, ale ich
średni wzrost jest niższy niż średni wzrost ojców. Podobnie wzrost synów niskich
ojców jest bliższy średniej w populacji. To zjawisko nazwał ,,dążeniem do przeciętności''
lub ,,tendencją do przeciętności'' (w języku angielskim ten współczynnik
nazywa się ang. regression toward the mean). Galton zaproponował równanie
opisujące zależność między wzrostem synów i ojców lub równoważnie opisujące
regresję wzrostu z pokolenia na pokolenie w kierunku wartości przeciętnej (dziś
nazwalibyśmy to równanie równaniem regresji). 

## Czy wzrost rodziców się liczy?

Naszą przygodę z regresją liniową również rozpoczniemy od danych zebranych przez Galtona.
Zbiór danych nazywa się `galton`, zobaczmy kilka pierwszych obserwacji z tego zbioru.

```{r, warning=FALSE, width=8, height=8, message=FALSE}
library(UsingR)      # w tym pakiecie znajduje się zbiór danych galton
library(ggplot2)     # ten pakiet wykorzystamy do wizualizacji
library(dplyr)       # ten pakiet wykorzystamy do przetwarzania danych

head(galton)
```

TODO: może warto przeliczyć z cali na cm?

W kolumnie `parent` przedstawiona jest średni ważony wzrost rodziców (średnia wzrostu
ojca i 1,08 wzrostu matki), a w drugiej kolumnie wzrost dorosłego syna. Dane są w calach.

Pytanie, które interesowało Galtona jak również interesuje nas, to czy jest zależność pomiędzy wzrostem rodziców a dziecka.
Modelowanie zawsze rozpoczyna się od wykresu, zobaczmy jak ta zależność wygląda graficznie.

```{r, warning=FALSE, width=8, height=8}
ggplot(galton, aes(x=parent, y=child)) + 
  geom_point() 
```

Ponieważ dane są zbierane z dokładnością do połowy cala, punkty dla różnych wierszy pokrywają się. 
Rysując takie dane warto zaburzyć je małym zastrzykiem szumu.
Zrobimy to argumentem `position = "jitter"`.

```{r, warning=FALSE, width=8, height=8}
ggplot(galton, aes(x=parent, y=child)) + 
  geom_point(position = "jitter") 
```

## Jaka to zależność?

Wygląda na to, że jakaś zależność występuje, ale jaka?
Jedną z możliwości jest policzenie średniego wzrostu dziecka dla każdej grupy średniego wzrostu rodziców.

```{r, warning=FALSE, width=8, height=8}
(srednie = galton %>%
  group_by(parent) %>%
  summarise(srednia = mean(child)))

#
# poniższa funkcja dorysowuje średnie w grupach
ggplot(galton, aes(x=parent, y=child)) + 
  geom_point(position = "jitter") +
  geom_line(data=srednie, aes(x=parent, y=srednia), size=2, color = "blue") + 
  geom_point(data=srednie, aes(x=parent, y=srednia), size=5, color = "blue") 
```

Pięknie, widzimy, że im wyżsi rodzice tym średnio wyższe dzieci. 
Jednak posługiwanie się samymi średnimi jest dosyć niewygodne.
Aby opisać tą zależność należy pamiętać średnią dla każdego wzrostu rodziców.
Co więcej średnie w grupach bardzo wysokich lub bardzo niskich rodziców wyznaczane są na bazie tylko kilku obserwacji, a więc wyznaczane są niedokładnie.

### Zadania:
+ Dla każdego wzrostu rodzica wyznacz o ile średnio niższe są dzieci od rodziców

### Odpowiedzi:
```{r, warning=FALSE, width=8, height=8}
srednie %>%
  mutate(roznica = srednia - parent)
```


## Model liniowy

Wygodniej by było opisać zależność pomiędzy wzrostem rodzica a średnim wzrostem dziecka za pomocą mniejszej liczby parametrów.

Załóżmy, że można tę zależność opisać zależnością liniową, a więc zależnością

_średni.wzrost.dziecka = b0 + wzrost.rodziców * b1_

gdzie _b0_ i _b1_ to pewne nieznane wartości. 

Metoda regresji liniowej pozwala wyznaczyć te nieznane wartości.
Dokładny opis algorytmu wyznaczania tych wartości jest opisany w kolejnym punkcie,
przyjrzyjmy się, jak można to zrobić w programie R.

## Estymacja współczynników

Proces wyznaczania nieznanych wartości w oparciu o model i dane nazywa się estymacją.
W programie R, do estymacji można wykorzystać funkcję `lm()` (skrót od ang. linear model).

Dla modelu 
_średni.wzrost.dziecka = b0 + wzrost.rodziców * b1_

lub używając nazw zmiennych z naszego zbioru danych
_child = b0 + parent * b1_

Funkcja estymująca parametry wygląda następująco.

```{r, warning=FALSE, width=8, height=8}
lm(child~1 + parent, data=galton)
```

Funkcja `lm()` przyjmuje dwa argumenty, pierwszy to formuła opisująca przyjęty model, drugi argument wskazuje zbiór danych.

Formuła składa się z lewej strony i prawej, rozdzielonej znakiem `~`. Lewa strona opisuje zmienną, którą chcemy opisać, tzw. zmienną objaśnianą, a prawa strona składa się z zmiennych, które wykorzystujemy do opisania lewej strony, czyli zmiennych objaśniających. Zapis `1 + parent` oznacza, że średni wzrost dziecka chcemy opisać za pomocą wyrażenia _1 * b0 + parent * b1_,
w którym należy wyznaczyć _b0_ i _b1_.

Wynikiem funkcji `lm()` jest szczegółowy opis dopasowanego modelu, jeżeli interesują nas jedynie oceny  _b0_ i _b1_, możemy się odwołać do tych ocen przez właściwość `coef` wyniku.

```{r, warning=FALSE, width=8, height=8}
lm(child~1 + parent, data=galton)$coef
```

_średni.wzrost.dziecka = 23.9415 + wzrost.rodzica * 0.6462906_

W formule możemy pominąć człon `1+`, jest on domyślnie dodawany do formuły, dlatego taki sam wynik otrzymamy stosując następującą instrukcję.

```{r, warning=FALSE, width=8, height=8}
lm(child~parent, data=galton)$coef
```

### Zadania:
+ Mając wyznaczone parametry _b0_ i _b1_ policz oceny średniego wzrostu dziecka dla każdego średniego wzrostu rodzica
+ Wyznacz różnice pomiędzy ocenami z modelu liniowego a średnimi liczonymi osobno dla każdej grupy rodziców

### Odpowiedzi:
```{r, warning=FALSE, width=8, height=8}
(wspolczynniki = lm(child~parent, data=galton)$coef)
srednie %>%
  mutate(m.liniowy = wspolczynniki[1] + parent*wspolczynniki[2],
         roznica = srednia - m.liniowy)
```

## Jak wygląda ta zależność

W powyższym toku rozumowania rozważaliśmy kilka alternatywnych modeli. Podsumujmy je tutaj. 

1. Model, w którym średni wzrost dziecka jest równy wzrostowi rodzica,
_średni.wzrost.dziecka = wzrost.rodziców_

2. Model, w którym nie ma zależności pomiędzy wzrostem rodziców a dzieci, a więc, że dla każdego wzrostu rodziców, średni wzrost dzieci jest taki sam,
_średni.wzrost.dziecka = b0_

3. Model, w którym wzrost dziecka jest liniowo zależny od wzrostu rodziców
_średni.wzrost.dziecka = b0 + wzrost.rodziców * b1_

4. Model, w średni wzrost dziecka jest różny dla każdego wzrostu rodzica.

Modele te zostały uporządkowane ze względu na liczbę nieznanych parametrów. Pierwszy z powyższych modeli nie ma żadnego parametru, kolejny ma jeden parametr, kolejny dwa a ostatni 11 parametrów.

### Zadania:
+ Poniższy wykres przedstawia wszystkie rozważane modele. Wskaż który kolor odpowiada któremu modelowi

```{r, warning=FALSE, width=8, height=8}
ggplot(galton, aes(x=parent, y=child)) + 
  geom_point(position = "jitter")+
  geom_line(data=srednie, aes(x=parent, y=srednia), size=2, color = "blue") + 
  geom_point(data=srednie, aes(x=parent, y=srednia), size=5, color = "blue")  + 
  geom_smooth(method="lm", se=FALSE, size=3, color="red") +
  geom_abline(size=2, color="gold3")+
  geom_abline(size=2, slope=0, intercept=mean(galton$child))
```

### Odpowiedzi:
+ Pierwszy to kolor złoty, drugi - czarny, trzeci - czerwony, czwarty - niebieski.


