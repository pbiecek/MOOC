---
title: "Modelowanie / regresja prosta"
output:
  html_document:
    toc: yes
---

## Kim był Francis Galton?

Podstawy matematyczne liniowych metod analizy danych powstały na przełomie XVIII i XIX
wieku. Metody te były z początku wykorzystywane w nawigacji oraz astronomii.

!["Francis Galton 1850". Domena publiczna via Wikimedia Commons](Francis_Galton.jpg)

Termin regresja został użyty po raz pierwszy przez Sir Francisa Galtona jeszcze
w XIX wieku. Francis Galton był człowiekiem renesansu, zajmującym się zarówno
antropologią, statystyką, jak i wieloma innymi naukami. W 1886 roku opublikował
pracę ,,Regression towards mediocrity in hereditary stature'' w The Journal of
the Anthropological Institute of Great Britain and Ireland, w której
przedstawił wyniki badań nad dziedziczeniem wzrostu. Galton zauważył, że synowie
bardzo wysokich ojców są średnio wyżsi niż synowie niższych ojców, ale ich
średni wzrost jest niższy niż średni wzrost ojców. Podobnie wzrost synów niskich
ojców jest bliższy średniej w populacji. To zjawisko nazwał ,,dążeniem do przeciętności''
lub ,,tendencją do przeciętności'' (w języku angielskim ten współczynnik
nazywa się ang. regression toward the mean). Galton zaproponował równanie
opisujące zależność między wzrostem synów i ojców lub równoważnie opisujące
regresję wzrostu z pokolenia na pokolenie w kierunku wartości przeciętnej (dziś
nazwalibyśmy to równanie równaniem regresji). 

## Czy wzrost rodziców się liczy?

Naszą przygodę z regresją liniową również rozpoczniemy od danych zebranych przez Galtona.
Zbiór danych nazywa się `galton`, zobaczmy kilka pierwszych obserwacji z tego zbioru.

```{r, warning=FALSE, width=8, height=8, message=FALSE}
library(SmarterPoland)      # w tym pakiecie znajduje się zbiór danych galton

head(galton)
```
**PCH: Znajduje się, ale tylko w wersji bieżącej wersji na githubie. Tam jednak
znajduje się też zbiór auto2012!**

W kolumnie `rodzic` przedstawiona jest średni ważony wzrost rodziców (średnia wzrostu
ojca i 1,08 wzrostu matki), a w kolumnie `syn` wzrost dorosłego syna. Dane są w calach.

*PCH: Jak w calach, to chyba suma wzrostu obu rodziców i babci ;) Stawiałbym jednak na
centrymetry**

Pytanie, które interesowało Galtona jak również interesuje nas, to czy jest zależność pomiędzy wzrostem rodziców a dziecka.
Modelowanie zawsze rozpoczyna się od wykresu, zobaczmy jak ta zależność wygląda graficznie.

```{r, warning=FALSE, width=8, height=8}
ggplot(galton, aes(x=rodzic, y=syn)) + 
  geom_point() 
```

**PCH: Panie, a co to ten ggplot? Może jakieś słowo wyjaśnienia? No bo jak na.rm znaczy 
usuń NA, to ktoś jest gotowy pomyśleć, że `ggplot()` to funkcja do rysowania
wykresów typu Galton-Galton ;)**

Ponieważ dane są zbierane z dokładnością do połowy cala, punkty dla różnych wierszy pokrywają się. 
Rysując takie dane warto zaburzyć je małym zastrzykiem szumu.
Zrobimy to argumentem `position = "jitter"`.

```{r, warning=FALSE, width=8, height=8}
ggplot(galton, aes(x=rodzic, y=syn)) + 
  geom_point(position = "jitter") 
```

## Jaka to zależność?

Wygląda na to, że jakaś zależność występuje, ale jaka?
Jedną z możliwości jest policzenie średniego wzrostu dziecka dla każdej grupy średniego wzrostu rodziców.

```{r, warning=FALSE, width=8, height=8}
(srednie = galton %>%
  group_by(rodzic) %>%
  summarise(srednia = mean(syn)))

#
# poniższa funkcja dorysowuje średnie w grupach
ggplot(galton, aes(x=rodzic, y=syn)) + 
  geom_point(position = "jitter") +
  geom_line(data=srednie, aes(x=rodzic, y=srednia), size=2, color = "blue") + 
  geom_point(data=srednie, aes(x=rodzic, y=srednia), size=5, color = "blue") 
```

**PCH: No dobra, powinienem był to napisać już wcześniej, ale i tak tego nie unikniemy.
Moim zdaniem używanie `dplyr` jak gdyby to była najbardziej typowa konstrukcja w R
nie pomoże osobom robiącym kurs. Zaczną zaraz - naśladując - używać tak wszystkich
funkcji. Zwłaszcza, że najpierw pokazujesz jak używać mean, median, quantile,
a potem sam napierasz dplyrem i to bez słowa komentarza. Czyli albo chociaż
przedstawienie sensu i składni dplyra (jakby wszyscy pisali potoki w shellu :/),
albo robimy to w 'czystym' R. Sprawa nr 2. Daruj ludziom na tym etapie wyświetlanie 
za pomocą nawiasów. Pisz srednia = ..., a potem print(srednia). Liczba nawiasów
powoduje, że kod bardziej przypomina już LISPa niż R ;). No i ten ggplot znowu 
skomplikowany. Napisz co robisz w poszczególnych liniach - wtedy ludzie być może
będą mogli próbować modyfikować te wykresy w ramach ćwiczeń.**


Pięknie, widzimy, że im wyżsi rodzice tym średnio wyższe dzieci. 
Jednak posługiwanie się samymi średnimi jest dosyć niewygodne.
Aby opisać tą zależność należy pamiętać średnią dla każdego wzrostu rodziców.
Co więcej średnie w grupach bardzo wysokich lub bardzo niskich rodziców wyznaczane są na bazie tylko kilku obserwacji, a więc wyznaczane są niedokładnie.

### Zadania:
+ Dla każdego wzrostu rodzica wyznacz o ile średnio niższe są dzieci od rodziców

### Odpowiedzi:
```{r, warning=FALSE, width=8, height=8}
srednie %>%
  mutate(roznica = srednia - rodzic)
```

**PCH: Czy mi się wydaje, czy zakładasz, że osobom, którym tłumaczysz kilka 'zajęć' wcześniej
co znaczy 'na.rm' będzie znane i naturalne w tej sytuacji użycie `dplyr::mutate`?**

## Model liniowy

Wygodniej by było opisać zależność pomiędzy wzrostem rodzica a średnim wzrostem dziecka za pomocą mniejszej liczby parametrów.

Załóżmy, że można tę zależność opisać zależnością liniową, a więc zależnością

_średni.wzrost.dziecka = b0 + wzrost.rodziców * b1_

gdzie _b0_ i _b1_ to pewne nieznane wartości. 

Metoda regresji liniowej pozwala wyznaczyć te nieznane wartości.
Dokładny opis algorytmu wyznaczania tych wartości jest opisany w kolejnym punkcie,
przyjrzyjmy się, jak można to zrobić w programie R.

## Estymacja współczynników

Proces wyznaczania nieznanych wartości w oparciu o model i dane nazywa się estymacją.
W programie R, do estymacji można wykorzystać funkcję `lm()` (skrót od ang. linear model).

Dla modelu 
_średni.wzrost.dziecka = b0 + wzrost.rodziców * b1_

lub używając nazw zmiennych z naszego zbioru danych
_syn = b0 + rodzic * b1_

Funkcja estymująca parametry wygląda następująco.

```{r, warning = FALSE, width = 8, height = 8}
lm(syn ~ 1 + rodzic, data = galton)
```

**PCH: po takim wstępie to ja bym raczej próbował `galton %>% lm(syn ~ 1 + rodzic)` :D**

Funkcja `lm()` przyjmuje dwa argumenty, pierwszy to formuła opisująca przyjęty model, drugi argument wskazuje zbiór danych.

Formuła składa się z lewej strony i prawej, rozdzielonej znakiem `~`. Lewa strona opisuje zmienną, którą chcemy opisać, tzw. zmienną objaśnianą, a prawa strona składa się z zmiennych, które wykorzystujemy do opisania lewej strony, czyli zmiennych objaśniających. Zapis `1 + parent` oznacza, że średni wzrost dziecka chcemy opisać za pomocą wyrażenia _1 * b0 + parent * b1_,
w którym należy wyznaczyć _b0_ i _b1_.

Wynikiem funkcji `lm()` jest szczegółowy opis dopasowanego modelu, jeżeli interesują nas jedynie oceny  _b0_ i _b1_, możemy się odwołać do tych ocen przez właściwość `coef` wyniku.

```{r, warning=FALSE, width=8, height=8}
lm(syn~1 + rodzic, data=galton)$coef
```

**PCH: Ja bym ludziom darował właściwości, czy też atrybytu na tym etapie. Raczej
poszedłbym w kierunku:**

```
> model <- lm(syn ~ 1 + rodzic, data = galton)
> coef(model)
(Intercept)      rodzic 
  60.812990    0.646291 
```

_średni.wzrost.dziecka = 23.9415 + wzrost.rodzica * 0.6462906_

**PCH: Skąd powyżej wartość 23.9415 ?**

W formule możemy pominąć człon `1+`, jest on domyślnie dodawany do formuły, dlatego taki sam wynik otrzymamy stosując następującą instrukcję.

```{r, warning=FALSE, width=8, height=8}
lm(syn~rodzic, data=galton)$coef
```

**PCH: Jak wyżej, tzn.:**

```
> model <- lm(syn ~ rodzic, data = galton)
> coef(model)
(Intercept)      rodzic 
  60.812990    0.646291 
```


### Zadania:
+ Mając wyznaczone parametry _b0_ i _b1_ policz oceny średniego wzrostu dziecka dla każdego średniego wzrostu rodzica
+ Wyznacz różnice pomiędzy ocenami z modelu liniowego a średnimi liczonymi osobno dla każdej grupy rodziców

### Odpowiedzi:
```{r, warning=FALSE, width=8, height=8}
(wspolczynniki = lm(syn~rodzic, data=galton)$coef)
srednie %>%
  mutate(m.liniowy = wspolczynniki[1] + rodzic*wspolczynniki[2],
         roznica = srednia - m.liniowy)
```

**PCH: Zaraz, zaraz. Jeszcze nie było ani słowa o indeksowaniu, no to skąd 
wspolczynniki[1]!? Ani słowa również o mutate!!!**

## Jak wygląda ta zależność

W powyższym toku rozumowania rozważaliśmy kilka alternatywnych modeli. Podsumujmy je tutaj. 

1. Model, w którym średni wzrost dziecka jest równy wzrostowi rodzica,
_średni.wzrost.dziecka = wzrost.rodziców_

2. Model, w którym nie ma zależności pomiędzy wzrostem rodziców a dzieci, a więc, że dla każdego wzrostu rodziców, średni wzrost dzieci jest taki sam,
_średni.wzrost.dziecka = b0_

3. Model, w którym wzrost dziecka jest liniowo zależny od wzrostu rodziców
_średni.wzrost.dziecka = b0 + wzrost.rodziców * b1_

4. Model, w średni wzrost dziecka jest różny dla każdego wzrostu rodzica.

**PCH: Ja nie zauważyłem rozważań nad wszystkimi? Tylko 3 i 4, chyba że coś pomyliłem?**

Modele te zostały uporządkowane ze względu na liczbę nieznanych parametrów. Pierwszy z powyższych modeli nie ma żadnego parametru, kolejny ma jeden parametr, kolejny dwa a ostatni 11 parametrów.

### Zadania:
+ Poniższy wykres przedstawia wszystkie rozważane modele. Wskaż który kolor odpowiada któremu modelowi

```{r, warning=FALSE, width=8, height=8}
ggplot(galton, aes(x=rodzic, y=syn)) + 
  geom_point(position = "jitter")+
  geom_line(data=srednie, aes(x=rodzic, y=srednia), size=2, color = "blue") + 
  geom_point(data=srednie, aes(x=rodzic, y=srednia), size=5, color = "blue")  + 
  geom_smooth(method="lm", se=FALSE, size=3, color="red") +
  geom_abline(size=2, color="gold3")+
  geom_abline(size=2, slope=0, intercept=mean(galton$syn))
```

### Odpowiedzi:
+ Pierwszy to kolor złoty, drugi - czarny, trzeci - czerwony, czwarty - niebieski.


## Projekt
W pakiecie `SmarterPoland` udostępniony jest również zbiór danych `pearson` zebrany przez Pearsona. W tym zbiorze danych zebrane są wzrosty ojców i synów.

Dla tego zbioru danych wyznacz model regresji liniowej oraz narysuj zbiór danych z zaznaczoną krzywą regresji liniowej.

Czy parametry regresji liniowej w zbiorze pearsona (z wysokością ojca) różnią się od parametrów ze zbioru galtona (ze średnią wysokością rodziców)?

Przygotuj dokument knitra z opisem zależności liniowej pomiędzy wzrostem syna a ojca.

**PCH: knitra? Już? A może najpierw indeksowanie, czy coś w tym stylu? Może łatwiej
byłoby ludziom, gdyby im zasugerować RStudio? A czy to nie są przypadkiem
te same biedne istoty, którym nie chcesz utrudniać życia tłumacząc jak załadować 
dane z pliku na dysku lokalnym i wolisz już kazać ściągać im 70MB za każdym razem,
bo tak będzie łatwiej?**
