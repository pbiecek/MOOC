---
title: "Pętle"
author: "pogRomcy danych"
date: "sezon 1 / odcinek 8<br><br> <a href='http://biecek.pl/'>Przemysław Biecek @ Uniwersytet Warszawski</a><br><br><br>Naciśnij `A` by zamienić slajdy na ciągły tekst. <br> Naciśnij `T` by wyświetlić spis treści."
output:
  slidy_presentation:
    includes:
      in_header: ../tracking.html
    highlight: default
    css: ../style.css
    font_adjustment: 0
    footer: "pogRomcy danych / programowanie / pętle"

---

# O czym jest ten odcinek

Silną stroną komputerów jest to, że mogą bardzo szybko powtarzać określone operacje.
Nie są zbyt inteligentne (póki co), ale są bardzo szybkie i idealne do powtarzania, powtarzania, powtarzania, powtarzania...

Analizując dane bardzo często znajdziemy się w sytuacji, gdy określoną czynność będziemy chcieli powtórzyć. Wykonać ją dla każdej zmiennej, dla każdego analizowanego okresu czasu, dla każdego analizowanego zbioru danych.

Narzędziem pozwalającym na powtarzanie w kółko (w pętli) określonych operacji są właśnie... pętle.

W tym odcinku nauczymy się:

- jak i po co tworzyć pętle,
- jak korzystać z pętli `for()`,
- jak i po co tworzyć pętle w pętli.

Do ilustracji wykorzystamy zbiór danych `koty_ptaki` dostępny w pakiecie `PogromcyDanych`.

```{r, message=FALSE, warning=FALSE}
library(PogromcyDanych)
head(koty_ptaki, 3)
```

---

# Pętle - od 1 do 5

Pętle mogą być wykorzystywane, aby powtórzyć jakąś operację określoną liczbę razy.

Zacznijmy od przykładu, w którym wielokrotnie wyświetlimy pewien napis na ekranie.
W języku R jest kilka rodzajów pętli, które można do tego celu wykorzystać, ale najczęściej stosowana jest pętla `for` i to ją przedstawimy w pierwszej kolejności (znak `\n` powoduje przejście do nowej linii).

```{r}
odliczajDo <- 5

for (i in 1:odliczajDo) {
  cat("Wartość zmiennej i: ", i, "\n")
}
```

Ten sam efekt otrzymalibyśmy wpisując pięciokrotnie instrukcję `cat()` (która wyświetla swoje argumenty na ekranie). 

```{r, eval=FALSE}
cat("Wartość zmiennej i: 1\n")
cat("Wartość zmiennej i: 2\n")
cat("Wartość zmiennej i: 3\n")
cat("Wartość zmiennej i: 4\n")
cat("Wartość zmiennej i: 5\n")
```

Co jednak, gdybyśmy chcieli powtórzyć ją 10 000 razy? Z pewnością nikt z nas nie chciałby wpisywać przez kilka dni tych instrukcji, tym bardziej, że ten sam efekt można osiągnąć prostą pętlą.

---

# Pętle - schemat

Sposób użycia (tak zwana *składnia*) pętli `for` jest następująca:

```{r, eval=FALSE}
for (A in B) {
  C
}
```

W wyniku działania tej pętli wyrażenie `C` będzie wykonane dla każdej wartości z wektora `B`. Co więcej, aktualny krok pętli jest określony przez zmienną `A` i można z tej wartości korzystać wewnątrz wyrażenia `C`.

W przykładzie z poprzedniego slajdu wyrażenie `cat("Wartość zmiennej i: ", i, "\n")` jest wykonywane dla każdego elementu wektora `1:odliczajDo`. W każdym kroku pętli zmienna `i` przyjmuje kolejną wartość z wektora `1:odliczajDo`.

```{r, eval=FALSE}
for (i in 1:odliczajDo) {
  cat("Wartość zmiennej i: ", i, "\n")
}
```

---

# Pętle - schemat

Poniższy schemat ilustruje sposób działania pętli for.

<center><img width="1000" src="figs/schematFOR.png" /></center>

---

# Pętle - koszty napraw

W poprzednim przykładzie łatwo było przewidzieć wynik całej pętli. Wyświetlała ona pięć kolejnych liczb od 1 do 5. 

Pokażemy teraz bardziej złożony przykład, który symuluje tak zwany proces szkodowy. Załóżmy, że mamy flotę samochodów, w której w ciągu roku zdarzyć się może X stłuczek (X będziemy losować). Naprawa każdej stłuczki kosztować będzie od 0 do 10 000 PLN. 

```{r, message=FALSE, warning=FALSE}
# losujemy liczbę stłuczek
liczbaStluczek <- round(runif(n = 1, min = 1, max = 10))
# dla każdej losujemy wartość szkody
for (i in 1:liczbaStluczek) {
  cat("Stłuczka ", i,", a jej koszt naprawy to ", 
      runif(n = 1, min=0, max=10000), " PLN\n", sep = '')
}
```

W tym przykładzie funkcja `runif()` służy do losowania `n` liczb z przedziału od `min` do `max`. W pierwszej linii wykorzystujemy ją do wylosowania liczby stłuczek z przedziału 1 do 10. Funkcja `round()` służy do zaokrąglania wyniku do liczby całkowitej.

W każdym kroku pętli losowana jest kolejna wartość, oraz wypisywana jest na ekranie.
Choć ta pętla wygląda na prostą i niewinną, podobny sposób losowania wielkości szkody jest w rzeczywistości wykorzystywany do zarządzania niepewnością dotyczącego tego, jak duże szkody z tytułu stłuczek lub innych losowych wypadków mogą wystąpić w firmach.

---

# Pętle - koszty napraw

W pętli z poprzedniego przykładu wyświetlaliśmy na ekranie kolejne koszty.
A co trzeba zrobić by te wszystkie koszty zliczyć?

Wewnątrz pętli możemy wykonywać operacje na liczbach.
Przykładowo możemy te koszty zsumować.

Wewnątrz pętli w poniższym przykładzie co krok zmienia się wartość `sumaKosztow`. Instrukcja `sumaKosztow <- sumaKosztow + koszt` powoduje, że wartość zmiennej `sumaKosztow` zostanie zastąpiona sumą `sumaKosztow` i `koszt`.

```{r, message=FALSE, warning=FALSE}
# losujemy liczbę stłuczek
liczbaStluczek <- round(runif(n = 1, min = 1, max = 10))
sumaKosztow <- 0
# dla każdej losujemy wartość szkody
for (i in 1:liczbaStluczek) {
  koszt <- runif(n = 1, min=0, max=10000)
  sumaKosztow <- sumaKosztow + koszt
  cat("Stłuczka ", i,", a jej koszt naprawy to ",  koszt, " PLN\n", sep = '')
  cat("Suma dotychczasowych kosztów to ",  sumaKosztow, " PLN\n", sep = '')
}
sumaKosztow
```

---

# Pętle - wartości w sekwencji

Przedstawione jak dotąd pętle przechodziły po wartościach od 1 do okreśonej liczby. 
Jest tak bardzo często, ale nie zawsze. 

Indeksy pętli mogą być dowolnymi wartościami, np liczbami z krokiem co 3. Pokażmy na przykładzie, w którym wyświetlimy co trzecią nazwę zwierzęcia z tabeli `koty_ptaki`.

```{r, message=FALSE, warning=FALSE}
coTrzeci <- seq(1, nrow(koty_ptaki), 3)
coTrzeci
for (i in coTrzeci) {
  # aby się dobrze wyświetlała, i-tą wartość z kolumny `gatunek` musimy zamienić na napis
  nazwa <- as.character(koty_ptaki[i, "gatunek"])
  cat("Zwierzak ", i," to ",  nazwa, "\n", sep = '')
}
```

---

# Pętle - nazwy kolumn

Jak widzieliśmy w poprzednim przypadku, liczba powtórzeń pętli nie musi być z góry określona, może zależeć od np. liczby wierszy lub liczby kolumn w ramce danych. 

W poniższym przykładzie dla każdej kolumny z ramki danych `koty_ptaki` wyświetlamy listę różnych wartości, które występują w tej kolumnie. Na kolejnym slajdzie wyjaśnimy krok po kroku co dzieje się w poniższym kodzie.

```{r, message=FALSE, warning=FALSE}
# wektor z nazwami kolumn
kolumny <- colnames(koty_ptaki)
kolumny
# pętla, która dla każdej kolumny wyświetla różne wartości w niej występujące
for (i in kolumny) {
  wartosciWKolumnie <- unique(as.character(koty_ptaki[,i]))
  cat("Kolumna", i, "\n")
  cat("   ", length(wartosciWKolumnie), "różnych wartości:", wartosciWKolumnie, "\n")
}
```


---

# Pętle - nazwy kolumn

Przyjrzyjmy się pętli z poprzedniego slajdu linia po linii.

Pierwsza instrukcja wykorzystuje funkcję `colnames()` do wyznaczenia nazw kolumn. Te nazwy zostaną przypisane do wektora `kolumny`, który następnie zostanie wyświetlony.

```{r, eval=FALSE}
# wektor z nazwami kolumn
kolumny <- colnames(koty_ptaki)
kolumny
```
Instrukcja `for()` rozpoczyna pętle. Tym razem zmienna `i` będzie przebiegała po nazwach kolumn. Dla każdej nazwy kolumny wykona się ciało pętli.
```{r, eval=FALSE}
# pętla, która dla każdej kolumny wyświetla różne wartości występujące w tej kolumnie
for (i in kolumny) {
```
Wewnątrz pętli wyznaczany jest wektor różnych wartości. Jest to wykonywane w jednej linii, choć potrzebne do tego jest kilka instrukcji. Punktem wyjściowym jest wektor `koty_ptaki[,i]`. Używając funkcji `as.character()` wartości te (dla niektórych kolumn liczby dla innych napisy) są przekształcane na napisy. Następnie funkcja `unique()` usuwa powtarzające się elementy.
```{r, eval=FALSE}
  wartosciWKolumnie <- unique(as.character(koty_ptaki[,i]))
```
Dwie kolejne instrukcje `cat()` wyświetlają na ekranie w pierwszej linii nazwę kolumny, a w drugiej liczbę różnych wartości (długość wektora `wartosciWKolumnie` wyznaczana jest funkcją `length()`) oraz wszystkie różne wartości.
```{r, eval=FALSE}
  cat("Kolumna", i, "\n")
  cat("   ", length(wartosciWKolumnie), "różnych wartości:", wartosciWKolumnie, "\n")
}
```

---

# Pętle - iteracja po wierszu / kolumnie

Typowe zastosowania pętli to wykonanie pewnej operacji dla każdego wiersza lub każdej kolumny zbioru danych. 

Pokażmy teraz przykład wykorzystania pętli dla każdego wiersza, a na początek dla wiersza o indeksie `1`. Przy czym tę wartość przypiszemy do zmiennej o nazwie `i` (może być też dowolna inna nazwa), a następnie wykorzystamy tą zmienną do indeksowania zbioru `koty_ptaki`.

W poniższym przykłądzie będziemy chcieli wyświetlić informację do jakiej wagi dochodzą przedstawiciele danego gatunku.

```{r, message=FALSE, warning=FALSE}
# Zamiana zmiennej factor na zmienną napisową, po to by była dobrze wyświetlana
koty_ptaki$gatunek <- as.character(koty_ptaki$gatunek)

# wykonamy instrukcję dla pierwszego wiersza, indeks wiersza zapiszemy w zmiennej i
i <- 1                                                          
cat(koty_ptaki[i, "gatunek"], "może ważyć do", koty_ptaki[i, "waga"], "kg\n")
```

---

# Pętle - iteracja po wierszu / kolumnie

Powtórzmy tę operację dla każdego wiersza. Liczbę wierszy w ramce danych można odczytać poleceniem `nrow()` (od *number of rows*).

Sekwencja `1:nrow(koty_ptaki)` tworzy wektor liczb od 1 do 13 (tyle jest wierszy). Dla każdego wiersza uruchamiamy instrukcję z poprzedniego slajdu, wypisującą wagę kolejnego gatunku.

```{r, message=FALSE, warning=FALSE}
for (i in 1:nrow(koty_ptaki)) {
  cat(koty_ptaki[i,"gatunek"], "może ważyć do", koty_ptaki[i,"waga"], "kg\n")
}
```

---

# Wektoryzacja

Bardzo często pętli można uniknąć, ponieważ program R w naturalny sposób pracuje na wektorach.

Przykładowo, efekt identyczny do pętli z poprzedniego slajdu można uzyskać pracując bezpośrednio na wektorach kolumnowych. Zarówno `koty_ptaki[,"gatunek"]` jak i `koty_ptaki[,"waga"]` to wektory, funkcja `paste()` połączy je w wektor napisów a funkcja `cat()` wypisze wszystkie elementy tego wektora.

```{r, message=FALSE, warning=FALSE}
cat(paste(koty_ptaki[,"gatunek"], "może ważyć do", koty_ptaki[,"waga"], "kg\n"))
```

W języku R, jak i w każdym dojrzałym języku programowania, ten sam efekt można uzyskać na wiele sposobów. 


---

# Pętla w pętli

Pętle można zanurzać w innych pętlach. Na pierwszy rzut oka może wyglądać to dziwnie, ale jest to dosyć popularna praktyka.

Przypuśćmy, że chcemy policzyć coś, np. korelację, podobieństwo lub różnice, dla każdej pary kolumn. Jak to zrobić? Najłatwiej użyć dwóch pętli - jednej w drugiej.

```{r, eval=FALSE}
for (i in colnames(koty_ptaki)) {
  for (j in colnames(koty_ptaki)) {
# poniższa instrukcja wykona się dla każdej kombinacji nazw kolumn i i j
    cat("Kolumna '", i, "' i kolumna '", j, "' mają w sumie", nchar(i)+nchar(j), "znaków.\n")
  }
}
```


---

# Pętla w pętli

Wykorzystajmy możliwość tworzenia pętli w pętli do tekstowej wizualizacji danych o prędkości zwierząt.

Zacznijmy od jednej pętli, która przedstawi prędkość za pomocą kropek. Im większa prędkość, tym więcej kropek. 
Każde 5 km/h przedstawmy za pomocą kropki na ekranie. 

Pierwszy wiersz w danych `koty_ptaki` opisuje prędkość Sokoła norweskiego. Odczytajmy ją (polecenie `koty_ptaki[i,"predkosc"]`), policzmy ile kropek jest potrzebnych by ją przedstawić (w tym celu dzielimy na 5) i narysujmy te kropki w pętli używając instrukcji `cat()`.

```{r, message=FALSE, warning=FALSE}
# używamy pętli by rysować koty_ptaki[i,"predkosc"] / 5 kropek
i <- 1
n_kropek <- koty_ptaki[i,"predkosc"] / 5
for (i in 1:n_kropek) {
  cat(".")
}
```

---

# Pętla w pętli

Powtórzmy tę pętlę dla każdego wiersza danych `koty_ptaki`, a więc różnych gatunków.

Powtórzmy powyższą pętle przedstawiającą prędkość pierwszego gatunku, ale tym razem dla każdego wiersza osobno. Kropkami przedstawmy prędkość na końcu dopisując nazwę gatunku.

```{r, message=FALSE, warning=FALSE}
# Dla każdego wiersza w tabeli `koty_ptaki`
for (i in 1:nrow(koty_ptaki)) {
  n_kropek <- koty_ptaki[i,"predkosc"] / 5
  # rysowanie kropek
  for (j in 1:n_kropek) {
    cat(".")
  }
  # nazwa gatunku
  cat(" ", koty_ptaki[i,"gatunek"], "\n")
}
```

---

# Podsumowanie instrukcji R

W tym odcinku omawialiśmy pętlę `for`. Jest to najpopularniejsza z pętli. Po poznaniu funkcji w odcinku 10 poznamy też inne pętle o podobnym możliwościach co `for()` ale krótszym / wygodniejszym zapisie.

Poniżej znajduje się zestawienie wszystkich wykorzystanych w tym odcinku instrukcji.

```{r, eval=FALSE}
# pętla odliczająca od 1 do 5
odliczajDo <- 5
for (i in 1:odliczajDo) {
  cat("Wartość zmiennej i: ", i, "\n")
}

# pętla losująca wartości stłuczek dla losowej liczby stłuczek
liczbaStluczek <- round(runif(n = 1, min = 1, max = 10))
# dla każdej losujemy wartość szkody
for (i in 1:liczbaStluczek) {
  cat("Stłuczka ", i," a jej koszt naprawy to", runif(n = 1, min=0, max=10000), "PLN\n")
}

# pętla wypisująca liczbę różnych wartości i listująca te wartości dla każdej kolumny
kolumny <- colnames(koty_ptaki)
for (i in kolumny) {
  wartosciWKolumnie <- unique(as.character(koty_ptaki[,i]))
  cat("Kolumna", i, "\n")
  cat("   ", length(wartosciWKolumnie), "różnych wartości:", wartosciWKolumnie, "\n")
}
```

---

# Podsumowanie instrukcji R

Poniżej znajduje się zestawienie wszystkich wykorzystanych w tym odcinku instrukcji.

```{r, eval=FALSE}
# pętla wypisująca dla każdego wiersza ciężar zwierzaka
for (i in 1:nrow(koty_ptaki)) {
  cat(koty_ptaki[i,"gatunek"], "może ważyć do", koty_ptaki[i,"waga"], "kg\n")
}

# używając operacji na wektorach czasem można uniknąć pisania pętli
cat(paste(koty_ptaki[,"gatunek"], "może ważyć do", koty_ptaki[,"waga"], "kg\n"))

# pętla w pętli pozwala na wykonanie pewnej instrukcji dla każdej pary kolumn
for (i in colnames(koty_ptaki)) {
  for (j in colnames(koty_ptaki)) {
    cat("Kolumna '", i, "' i kolumna '", j, "' mają w sumie", nchar(i)+nchar(j), "znaków.\n")
  }
}

# używając pętli w pętli możemy też stworzyć tekstową wizualizację danych
for (i in 1:nrow(koty_ptaki)) {
  n_kropek <- koty_ptaki[i,"predkosc"] / 5
  # rysowanie kropek
  for (j in 1:n_kropek) {
    cat(".")
  }
  # nazwa gatunku
  cat(" ", koty_ptaki[i,"gatunek"], "\n")
}
```

---

# Zadania

* Napisz pętlę, która dla każdego wiersza z tabeli `koty_ptaki` wypisze żywotność określonego gatunku.

* Napisz pętlę, która przedstawi żywotność za pomocą wykresu, na którym każdy rok przedstawiony jest jako jeden `#`.

* Napisz pętlę, która narysuje wykres z żywotnością, ale z nazwami gatunku po lewej stronie. Co więcej, przed każdą nazwą gatunku należy dodać tyle znaków spacja, aby nazwy były wyrównane do prawej strony. Długość napisu, mierzoną w liczbie znaków można odczytać funkcją `nchar()`.

Przykładowe odpowiedzi znajdują się na stronie http://pogromcydanych.icm.edu.pl/materials/1_przetwarzanie/9_zadania.html

