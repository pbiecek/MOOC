---
title: "Pętle"
author: "pogRomcy danych"
date: "sezon 1 / odcinek 8 <br><br><br><br>Naciśnij `A` by zamienić slajdy na ciągły tekst. <br> Naciśnij `T` by wyświetlić spis treści."
output:
  slidy_presentation:
    includes:
      in_header: ../tracking.html
    highlight: default
    css: ../style.css
    font_adjustment: 0
    footer: "pogRomcy danych / programowanie / pętle"

---

# O czym jest ten odcinek

Silną stroną komputerów jest to, że mogą bardzo szybko powtarzać określone operacje.
Nie są zbyt inteligentne (póki co) ale są bardzo szybie i idealne do powtarzania, powtarzania, powtarzania, powtarzania.

Analizując dane bardzo często znajdziemy się w sytuacji, gdy określoną czynność będziemy chcieli powtórzyć. Wykonać ją dla każdej zmiennej, dla każdego analizowanego dnia, dla każdego analizowanego zbioru danych.

Narzędziem, pozwalającym na powtarzanie w kółko (w pętli) określonych operacji są pętle.

W tym odcinku nauczymy się

- Jak i po co tworzyć pętle?
- Jak korzystać z pętli `for()`?
- Jak korzystać z pętli `sapply()`?
- Jak korzystać z pętli `apply()`?
- Jak i po co tworzyć pętle w pętli?

Do ilustracji wykorzystamy zbiór danych to `koty_ptaki` dostępny w pakiecie `SmarterPoland`.

```{r, message=FALSE, warning=FALSE}
library(SmarterPoland)
head(koty_ptaki, 3)
```

---

# Pętle

Pętle mogą być wykorzystywane aby powtórzyć jakąś operację określoną liczbę razy.

Zacznijmy od przykładu, w którym określoną liczbę razy wyświetlimy pewien napis na ekranie.
W języku R jest kilka rodzajów pętli, które można do tego celu wykorzystać, ale najczęściej stosowana jest pętla `for` i to ją przedstawimy w pierwszej kolejności.

```{r}
odliczajDo <- 5

for (i in 1:odliczajDo) {
  cat("Wartość zmiennej i: ", i, "\n")
}
```

Ten sam efekt otrzymalibyśmy wpisując pięciokrotnie instrukcję `cat()` (która wyświetla swoje argumenty na ekranie). 

```{r, eval=FALSE}
cat("Wartość zmiennej i: 5\n")
cat("Wartość zmiennej i: 4\n")
cat("Wartość zmiennej i: 3\n")
cat("Wartość zmiennej i: 2\n")
cat("Wartość zmiennej i: 1\n")
```

Co jednak, gdybyśmy chcieli powtórzyć ją 10 000 razy? Z pewnoscią nikt z nas nie chciałby wpisywać przez kilka dni tych instrukcji, tym bardziej, że ten sam efekt możnaby osiągnąć prostą pętlą.

---

# Pętle

Sposób użycia (tak zwana *składnia*) pętli `for` jest następujący. 

```{r, eval=FALSE}
for (A in B) C
```

W wyniku działania tej pętli wyrażenie `C` będzie wykonane dla każdej wartości z wektora `B`. Co więcej, aktualny krok pętli jest określony przez zmienną `A` i można z tej wartości korzystać wewnątrz wyrażenia `C`.

W przykładzie z poprzedniego slajdu wyrażnie `cat("Wartość zmiennej i: ", i, "\n")` jest wykonywane dla każdego elementu wektora `1:odliczajDo`. W kazdym kroku pętli zmienna `i` przyjmuje kolejną wartość z wektora `1:odliczajDo`.

```{r, eval=FALSE}
for (i in 1:odliczajDo) {
  cat("Wartość zmiennej i: ", i, "\n")
}
```

---

# Pętle

W poprzednim przykładzie łątwo było przewidzieć wynik całej pętli. Wyświetlała ona pięć kolejnych liczb od 1 do 5. 

Pokażemy teraz bardziej złożony przykład, który symuluje tak zwany proces szkodowy. Załóżmy, że mamy flotę samochodów w której w ciągu roku zdarzyć się może X stłuczek (X będziemy losować). Naprawa każdej stłuczki kosztować będzie od 0 do 10 000 PLN. 

```{r, message=FALSE, warning=FALSE}
# losujemy liczbę stłuczek
liczbaStłuczek <- round(runif(n = 1, min = 1, max = 10))
# dla każdej losujemy wartość szkody
for (i in 1:liczbaStłuczek) {
  cat("Stłuczka ", i," a jej koszt naprawy to", runif(n = 1, min=0, max=10000), "PLN\n")
}
```

W tym przykładzie, funkcja `runif()` służy do losowania `n` liczb z przedziału od `min` do `max`. W pierwszej linii wykorzystujemy ją do wylosowania liczby stłuczek z przedziału 1 do 10. Funkcja `round()` służy do zaokrąglania wyniki do liczby całkowitej.

W każdym kroku pętli losowana jest kolejna wartość, oraz wypisywana jest na ekranie.
Choć ta pętla wygląda na prostą i niewinną, podobny sposób losowania wielkości szkody jest w rzeczywistości wykorzystywany do zarządzania niepewnością dotyczące tego jak duże szkody z tytułu stłuczek lub innych losowych wypadków mogą wystąpić w firmach.

---

# Pętle

Jak widzieliśmy w poprzednim przypadku, liczba powtórzeń pętli nie musi być z góry określona, może zależeć od np. liczby wierszy lub liczbie kolumn w ramce danych. 

W poniższym przykładzie dla każdej kolumny z ramki danych `koty_ptaki` wyświetlamy listę różnych wartości, które występują w tej kolumnie. Na kolejnym skadzie wyjaśnimy krok po kroku co się dzieje w tej funkcji.

```{r, message=FALSE, warning=FALSE}
# wektor z nazwami kolumn
kolumny <- colnames(koty_ptaki)
kolumny
# pętla, która dla każdej kolumny wyświetla różne wartości występujące w tej kolumnie
for (i in kolumny) {
  wartosciWKolumnie <- unique(as.character(koty_ptaki[,i]))
  cat("Kolumna", i, "\n")
  cat("   ", length(wartosciWKolumnie), "różnych wartości:", wartosciWKolumnie, "\n")
}
```


---

# Pętle

Przyjrzyjmy się pętli z poprzedniego slajdu linia po linii.

Pierwsza instrukcja wykorzystuje funkcje `colnames()` do wyznaczenia nazw kolumn. Te nazwy zostaną przypisane do wektora `kolumny`, który nastepnie zostanie wyświetlony.

```{r, eval=FALSE}
# wektor z nazwami kolumn
kolumny <- colnames(koty_ptaki)
kolumny
```
Instrukcja `for()` rozpoczyna pętle. Tym razem zmienna `i` będzie przebiegała po nazwach kolumn. Dla każdej nazwy kolumny wykona się ciało pętli.
```{r, eval=FALSE}
# pętla, która dla każdej kolumny wyświetla różne wartości występujące w tej kolumnie
for (i in kolumny) {
```
Wewnątrz pętli wyznaczany jest wektor różnych wartości. Jest to wykonywane w jednej linii, choć potrzebne do tego jest kilka instrukcji. Punktem wyjściowym jest wektor `koty_ptaki[,i]`. Używając funkcji `as.character()` wartości te (dla niektórych kolumn liczby dla innych napisy) są przekształcane na napisy. Następnie funkcja `unique()` usuwa powtarzające się elementy.
```{r, eval=FALSE}
  wartosciWKolumnie <- unique(as.character(koty_ptaki[,i]))
```
Dwie kolejne instrukcje `cat()` wyświetlają na ekranie w pierwszej linii nazwę kolumny a w drugiej linii liczbę różnych wartości (długość wektora `wartosciWKolumnie` wyznaczana jest funkcją `length()`) oraz wszystkie różne wartości.
```{r, eval=FALSE}
  cat("Kolumna", i, "\n")
  cat("   ", length(wartosciWKolumnie), "różnych wartości:", wartosciWKolumnie, "\n")
}
```

---

# Pętle

Typowe zastosowania pętli to wykonanie pewnej operacji dla każdego wiersza lub każdej kolumny. 

Dla każdej kolumny (a na początek dla kolumny o indeksie `i=1`) będziemy chcieli wyświetlić informację do jakiej wagi dochodzą przedstawiciele danego gatunku.

```{r, message=FALSE, warning=FALSE}
# Zamiana zmiennej factor na zmienną napisową, po to by była dobrze wyświetlana
koty_ptaki$gatunek <- as.character(koty_ptaki$gatunek)

i = 1
cat(koty_ptaki[i,"gatunek"], "może ważyć do", koty_ptaki[i,"waga"], "kg\n")
```

---

# Pętle

Powtórzmy tę operację dla każdego wiersza. Liczbę wierszy w ramce danych można odczytać poleceniem `nrow()` (od *number of rows*).

```{r, message=FALSE, warning=FALSE}
for (i in 1:nrow(koty_ptaki)) {
  cat(koty_ptaki[i,"gatunek"], "może ważyć do", koty_ptaki[i,"waga"], "kg\n")
}
```

---

# Wektoryzacja

Wiele pętli można uprościć do jednego wyrażenia, korzystając z mechanizmu wektoryzacji, a więc operowania w naturalny sposób na wektorach.

Przykładowo, podobny efekt do opisanego powyżej możemy uzyskać poleceniem.

```{r, message=FALSE, warning=FALSE}
cat(paste(koty_ptaki[,"gatunek"], "może ważyć do", koty_ptaki[,"waga"], "kg\n"))
```


---

# Pętla w pętli

Pętle można zanurzać w innych pętlach. 

Przedstawimy tę możliwość na przykładzie tekstowego przedstawiania informacji o prędkości.

Każde 5 km/h przedstawmy za pomocą kropki na ekranie. Pierwszy wiersz opisuje prędkość Sokoła norweskiego. odczytajmy ją, policzmy ile kropek jest potrzebnych by ją przedstawić i narysujmy te kropki używając instrukcji `cat()`.

```{r, message=FALSE, warning=FALSE}
i <- 1
n_kropek <- koty_ptaki[i,"predkosc"] / 5
for (i in 1:n_kropek) {
  cat(".")
}
```

---

# Pętla w pętli

Powtórzmy powyższa pętle przedstawiającą prędkość pierwszego organizmu dla każdego wiersza osobno.

```{r, message=FALSE, warning=FALSE}
# Dla każdego wiersza w tabeli `koty_ptaki`
for (i in 1:nrow(koty_ptaki)) {
  n_kropek <- koty_ptaki[i,"predkosc"] / 5
  # rysowanie kropek
  for (j in 1:n_kropek) {
    cat(".")
  }
  # nazwa gatunku
  cat(" ", koty_ptaki[i,"gatunek"], "\n")
}
```


---

# Podsumowanie instrukcji R

W tym odcinku omawialiśmy 


Poniżej znajduje się zestawienie wszystkich wykorzystanych w tym odcinku instrukcji.

```{r, eval=FALSE}
```


---

# Zadania

* Napisz pętlę, która dla każdego wiersza z tabeli `koty_ptaki` wypisze żywotność określonego gatunku.
* Napisz pętlę, która przedstawi żywotność za pomocą wykresu, na którym każdy rok przedstawiony jest jako jeden `#`.
* Napisz pętlę, która narysuje wykres z żywotnością, ale z nazwami gatunku po lewej stronie. Co więcej, przed każdą nazwą gatunku należy dodać tyle znaków spacja, aby nazwy były wyrównane do prawej strony. Długość napisu, mierzoną w liczbie znaków można odczytać funkcją `nchar()`.

