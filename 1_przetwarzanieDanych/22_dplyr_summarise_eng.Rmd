---
title: "Data aggregates [dplyr / summarise]"
author: "Data CruncheRs"
date: "season 1 / episode 22 <br><br> All rights reserved.<br> The use shall be subject
to prior consent of the author<br><br><br><br> Press `A` to see the plain text instead
of the slides <br> Press `T` to display the table of contents"
output:
  slidy_presentation:
    includes:
      in_header: ../tracking.html
    highlight: default
    css: ../style.css
    font_adjustment: 0
    footer: "Data CruncheRs / data processing / aggregates"

---

# What is this episode about

An overview of the whole data is possible only when the data is not too large. They fit on one or a few screens. 
For larger data sets, it is necessary to aggregate information from the level of single lines to the level of groups.

In order to effectively represent aggregates in groups we need a function for aggregating and a function defining the groups. For aggregation, it is easy to use the `summarise()` function from the `dplyr` packet, which we will present in this episode.


In this episode we will learn:

- how to determine the aggregates for whole data set
- what exemplary aggregates can be determined.

To illustrate those issues we'll use two data sets. First, small data set, is `koty_ptaki`, and the second, vastly larger, is `auta2012`. Both are available in the `PogromcyDanych` package.

---

# Birds vs. cats

Let's start with an example for a small data set. Seeing all the lines it will be easier to notice the relationship between the original data and the aggregates. This data set is provided along with the `PogromcyDanych` package.
 

```{r, message=FALSE}
library(PogromcyDanych)
koty_ptaki
```

---

# Aggregates

For the determination of aggregates / summaries we will use the `summarise()` function. As a first argument, it takes the data set (in the following example it is transferred by the `%>%` operator), subsequent arguments are declarations, how is the aggregate supposed to be counted, and what shall be the name of its corresponding column.

In the first line below we load the `dplyr` packet, and then we count the following statistics: the minimum and maximum speed, maximum, and average weight and something a bit more difficult, the maximum length of the name of the species.

Each of these values could be also calculated without the `summarise()` function, but the advantages of doing it that way will fully come to light in the next episode.


```{r, message=FALSE, warning=FALSE}
library(dplyr)

koty_ptaki %>%
  summarise(najszybszy = max(predkosc),
            najwolniejszy = min(predkosc),
            najciezszy = max(waga),
            srednia.waga = mean(waga),
            najdluzsza.nazwa = max(nchar(as.character(gatunek))))
```

---

# Aggregates in a wider perspective

Creating aggregates, we can base them on more than one variable. In the following examples, we calculate average and median momentum and maximum speed measured in numbers of body lengths per second. In each example, we calculate the statistics using two variables.

```{r, message=FALSE, warning=FALSE}
koty_ptaki %>%
  summarise(sredni.ped = mean(waga*predkosc),
            medianowy.ped = median(waga*predkosc),
            predkosc.w.dlugosciach.na.sek = max(predkosc * 1000 / dlugosc / 3600))
```


While creating the aggregates, we may use the aggregates calculated in the preceding step. In the following example, we calculate the average weight and then recalculate it into pounds.

```{r, message=FALSE, warning=FALSE}
koty_ptaki %>%
  summarise(srednia.waga = mean(waga),
            srednia.waga.w.funtach = srednia.waga / 0.453)
```


---

# Cars

Let's show an example of how the aggregates work on a larger data set of bidding prices of cars. We'll use few columns. Below, we only display the brand, model, price and mileage for the first 6 rows of the `auta2012` data set.


```{r, message=FALSE}
auta2012 %>%
  select(Marka, Model, Cena.w.PLN, Przebieg.w.km) %>%
  head()
```

---

# Aggregates

The `auta2012` data set includes detailed information on the characteristic of each sale bid. Often in such data sets, we are interested in some statistics which aggregate the information from the data set.

An example would be the average price, price dispersion measured by the standard deviation of prices, halved mileage, or what mileage is not exceeded by half of the cars.

Such aggregates can be determined with the `summarise()` function. As the first argument we indicate the the data set, an as further ones we indicate statistics / aggregates which we want to calculate for this data set. 

```{r, warning=FALSE}
auta2012 %>%
  summarise(sredniaCena = mean(Cena.w.PLN),
            sdCena = sqrt(var(Cena.w.PLN)),
            medianaPrzebiegu = median(Przebieg.w.km, na.rm=TRUE))
```

The `mean()` function determines the mean value, the `var()` function determines the variance (a square root of the variance is the standard deviation), the `median()` function determines the median of the observations within the group.

Not all of the values are indicated for all of the variables. If any value was not indicated, it is coded within the data set as NA - Not Available.

If the variable contains not available values, then the na.rm=TRUE argument assures that the result will be determined after the removal of not available values.

---

# Aggregates

Definition of the aggregate may be more complicated than one instruction. For example, to count the number or percentage of cars with air conditioning, in the first step we can use the `grepl()` function, to check wheter the car in the offer concerned has air conditioning, and then add up the results of this function to get the number of cars with air conditioning. 

When counting the percentage of cars with automatic transmission, in the first step we can create a logical variable indicating whether the `Skrzynia.biegow` variable assumes the `automatyczna` value, and then calculate the percentage with the `100*mean()` operation.

In creating the aggregates it is convenient to use the `n()` function, the result of which is the number of lines in the data set / group.

```{r, warning=FALSE}
auta2012 %>%
  summarise(liczba.aut.z.klimatyzacja = sum(grepl("klimatyzacja", Wyposazenie.dodatkowe)),
            procent.aut.z.klimatyzacja = 100*mean(grepl("klimatyzacja", Wyposazenie.dodatkowe)),
            procent.aut.z.automatem = 100*mean(Skrzynia.biegow == "automatyczna"),
            liczba.aut = n())
```

---

# Exercises

* Calculate the total mileage of all of the cars. Then, count the number of times the earth was circled taking into account all those mileages.
* Pick only the 'Rolls Royce' brand cars and calculate their average mileage and average price.

Sample answers are available on the website https://rawgit.com/pbiecek/MOOC/master/0_dane/9_zadania.html
