---
title: "Loops"
author: "Data CruncheRs"
date: season 1 / episode 8<br><br> All rights reserved.<br> Using without permission is prohibited <br><br><br><br>Press `A` to change slides into text <br> Press `T` to display table of contents.
output:
  slidy_presentation:
    css: ../style.css
    font_adjustment: 0
    footer: pogRomcy danych / programowanie / loops
    highlight: default
    includes:
      in_header: ../tracking.html
---

# What is this episode about?

Real strength of modern computers is their ability to repeat certain operations at a very high speed. Our computers are not very intelligent (as yet) but they are very fast and, what is more, they are great at repeating, repeating, repeating... 

When we analyze data we often want to repeat certain operations. We may for example want to repeat it for each variable, each day  or each data set undergoing analysis.

A tool which allows us to repeat certain operations again and again is a loop. 

In this episode you will learn:

- How to create loops?
- What are loops used for?
- How to use the loop `for()`?
- How to create a loop within the loop?
- What are loops in the loops used for?

As an illustration we will use the data set `koty_ptaki` available in the package `PogromcyDanych`. 

```{r, message=FALSE, warning=FALSE}
library(PogromcyDanych)
head(koty_ptaki, 3)
```

---

# Loops

You can use loops to repeat certain operations a given number of times. 

Let us start with an example in which we will display a certain text on the screen several times. R language contains a number of types of loops which can be used for that purpose but the most popular loop is the loop `for()`. I would like to present  this particular loop first.  

```{r}
odliczajDo <- 5

for (i in 1:odliczajDo) {
  cat("Value of i : ", i, "\n")
}
```

We would achieve the same desired effect, if we entered the command `cat()` (which displays its arguments on the screen) five times. 

```{r, eval=FALSE}
cat("Value of i: 1\n")
cat("Value of i: 2\n")
cat("Value of i: 3\n")
cat("Value of i: 4\n")
cat("Value of i: 5\n")
```

But what if we wanted to repeat that function 10 000 times? I am sure that none of us would like to keep entering these commands for several days. Especially so, if the same effect can be achieved with a simple loop. 

---

# Loops

Instructions for use (the so-called *syntax*) of the `for` loop are as follows:

```{r, eval=FALSE}
for (A in B) {
  C
}
```

As a result of that loop, the  command `C` will be performed for every value from the vector `B` . Moreover, the current loop interval is determined by the variable `A` and this value can be used inside the `C` command. 

In the example presented on the previous slide the command `cat("Value of i: ", i, "\n")` is performed for each element of the vector `1:odliczajDo`. The variable `i` assumed the subsequent value from the vector `1:odliczajDo` at every phase of the loop.   

```{r, eval=FALSE}
for (i in 1:odliczajDo) {
  cat("Value of i: ", i, "\n")
}
```

---

# Loops

This scheme illustrates how the loops `for` works.

<center><img width="1000" src="figs/schematFOR.png" /></center>

---

# Loops

It was easy to predict the result of the whole loop from the previous example. It displays five subsequent numbers from 1 to 5. 

Now I would like to present to you a more complex example which simulates the so-called damage process. Let us assume that we have a fleet of cars. This fleet may take part in X number of car accidents per year (we will select the number of X at random). Repair of damages caused by each bump will cost from 0 to PLN 10 000. 

```{r, message=FALSE, warning=FALSE}
# we draw the numer of bumps
liczbaStluczek <- round(runif(n = 1, min = 1, max = 10))
# for each bump we draw the cost of repair
for (i in 1:liczbaStluczek) {
  cat("Bump ", i,", repair cost: ", runif(n = 1, min=0, max=10000), " PLN\n", sep = '')
}
```

In this example the function `runif()` is used to draw `n` numbers from the range starting from `min` and ending at `max`. First, we use the function to draw the number of collisions within the range from 1 to 10. The function `round()` is used to round down the results to whole numbers. 

At each stage of the loop subsequent values are randomly chosen and displayed on the screen. Although this loop appears to be simple and quite innocent, a very similar manner of drawing the size of damage is really used in management of uncertainty concerning amount of damage resulting from car accidents or other accidental events which may concern real companies. 

---

# Loops

As you have seen in the previous case, the number of repetitions performed by the loop does not need to be predetermined. It may depend on e.g. number of rows or columns in a data frame. 

In the example presented below a list of various values from each column of the data frame `koty_ptaki` is displayed. The next slide will explain to you in detail what is going on in the code that you can see below. 

```{r, message=FALSE, warning=FALSE}
# vector of column names
kolumny <- colnames(koty_ptaki)
kolumny
# a loop, which prints, for each column, unique values it contains
for (i in kolumny) {
  wartosciWKolumnie <- unique(as.character(koty_ptaki[,i]))
  cat("Column", i, "\n")
  cat("   ", length(wartosciWKolumnie), "unique values:", wartosciWKolumnie, "\n")
}
```


---

# Loops

Let us discuss line by line the loop from the previous slide.

The first command uses the function `colnames()` to determine names of the columns.  These names will be attributed to the vector `kolumny`, which then will be displayed on the screen

```{r, eval=FALSE}
# vector of column names
kolumny <- colnames(koty_ptaki)
kolumny
```
The command `for()` begins the loop. This time the variable `i` will cover names of columns. Loop body for name of each column will be executed. 
```{r, eval=FALSE}
# a loop, which prints, for each column, unique values it contains
for (i in kolumny) {
```
A vector of various values is determined inside the loop. Although several commands are necessary to create such vector, they are included in one line. The starting point is the vector `koty_ptaki[,i]`. The function `as.character()` transforms all these values (for some columns values are numbers and for others text) into text. Next, the function `unique()` removes repeated elements. 
```{r, eval=FALSE}
  wartosciWKolumnie <- unique(as.character(koty_ptaki[,i]))
```
The next two commands `cat()` display on the screen the name of the column in the first line and the number of various values in the second line (length of the vector `wartosciWKolumnie` is specified by the function `lenght()`) as well as all the various values. 
```{r, eval=FALSE}
  cat("Column", i, "\n")
  cat("   ", length(wartosciWKolumnie), "unique values:", wartosciWKolumnie, "\n")
}
```

---

# Loops

The typical use of loop is repetition of a certain operation with reference to each row or each column of the data set. 

I would like to show you an example of use of the loop for each row of the data set. Our first example is a loop for a row with index `i=1`.

I want to display information on the maximum weight of the representatives of a given species. 

```{r, message=FALSE, warning=FALSE}
# Changing variable of factor type to character, so it is printed properly 
koty_ptaki$gatunek <- as.character(koty_ptaki$gatunek)

# we will execute the command for the first row, and save its index in the variable i 
i <- 1
cat(koty_ptaki[i, "gatunek"], "may weight up to:", koty_ptaki[i, "waga"], "kg\n")
```

---

# Loops

We will repeat that operation for each row. You can check the number of rows in the data frame with a command `nrow()` (from *number of rows*).

The sequence `1:nrow(koty_ptaki)` creates a vector of numbers from 1 to 13 (as there are 13 rows). For each row we need to activate the command from the previous slide, which displays weight of subsequent species. 


```{r, message=FALSE, warning=FALSE}
for (i in 1:nrow(koty_ptaki)) {
  cat(koty_ptaki[i,"gatunek"], "may weight up to", koty_ptaki[i,"waga"], "kg\n")
}
```

---

# Vectorization

Loops can be very often avoided as R works on vectors quite naturally. 

For example, you can achieve the same effect as the one presented in the previous slide directly using column vectors. Both `koty_ptaki[,'gatunek']` and `koty_ptaki[,'waga']` are vectors. The function `paste()` will combine them and make a text vector out of them, while the function `cat()` will display all the elements of that newly formed vector. 


```{r, message=FALSE, warning=FALSE}
cat(paste(koty_ptaki[,"gatunek"], "may weight up to", koty_ptaki[,"waga"], "kg\n"))
```

In R, as well as in any well developed programming language, the same effect can be achieved in many different ways. 


---

# A loop in a loop

Loops can be placed inside other loops. At first glance it might seem strange but it is a very common practice. 

Let us assume that we want to calculate something, e.g. a correlation, similarity or difference between each pair of columns. How to do it? The easiest way is to use two loops - one loop inside the other one. 

```{r, eval=FALSE}
for (i in colnames(koty_ptaki)) {
  for (j in colnames(koty_ptaki)) {
# this command will be executed for each combination of the column names i and j 
    cat("Column '", i, "' and column '", j, "' together contain", nchar(i)+nchar(j), "characters.\n")
  }
}
```


---

# A loop in a loop

We will use the possibility of placing one loop in another loop to visualize data on speed of animals. 

Let us start from one loop which will present speed with dots. The more dots, the higher the speed. 
Each dot on the screen will stand for 5 km/h. 

The first row in the data set `koty_ptaki` describes speed of the Gyrfalcon ("Sokol norweski"). We will read it (with the command `koty_ptaki[i,'predkosc']`; then we will calculate the number of dots which we need to use to present speed (by dividing by 5). At the end we will draw the dots using the command `cat()`.


```{r, message=FALSE, warning=FALSE}
# using loop to draw koty_ptaki[i,"predkosc"] / 5 dots
i <- 1
n_kropek <- koty_ptaki[i,"predkosc"] / 5
for (i in 1:n_kropek) {
  cat(".")
}
```

---

# A loop in a loop

Let us now repeat the loop for each row containing data in the data frame `koty_ptaki`, that is, let us repeat the loop for each different species. 

Now we will repeat the loop presenting speed of the first species, but this time the loop will apply to each row separately. Speed is presented by a series of dots followed by name of the given species.  

```{r, message=FALSE, warning=FALSE}
# for each row in the `koty_ptaki` 
for (i in 1:nrow(koty_ptaki)) {
  n_kropek <- koty_ptaki[i,"predkosc"] / 5
  # printing dots
  for (j in 1:n_kropek) {
    cat(".")
  }
  # name of the species
  cat(" ", koty_ptaki[i,"gatunek"], "\n")
}
```

---

# Summary of R commands

We have discussed the loop `for` in this episode. It is one of the most popular loops. When you master functions in the episode 10, you will be taught how to use also other loops which have similar properties as `for()` but are much shorter/easier to write. 

Below you can see a list of all the commands used in this episode.


```{r, eval=FALSE}
# a loop which runs from 1 to 5
odliczajDo <- 5
for (i in 1:odliczajDo) {
  cat("Value of i: ", i, "\n")
}

# we draw the numer of bumps
liczbaStluczek <- round(runif(n = 1, min = 1, max = 10))
# for each bump we draw the cost of repair
for (i in 1:liczbaStluczek) {
  cat("Bump ", i,", repair cost: ", runif(n = 1, min=0, max=10000), " PLN\n", sep = '')
}

# aloop that prints the number of unique values and lists them for each column 
kolumny <- colnames(koty_ptaki)
for (i in kolumny) {
  wartosciWKolumnie <- unique(as.character(koty_ptaki[,i]))
  cat("Column", i, "\n")
  cat("   ", length(wartosciWKolumnie), "unique values:", wartosciWKolumnie, "\n")
}


```

---

# Function summary

Below are samples of all R expressions used in this episode.

```{r, eval=FALSE}
# a loop that, for each row, prints the weight of an animal it describes
for (i in 1:nrow(koty_ptaki)) {
 cat(paste(koty_ptaki[,"gatunek"], "may weight up to", koty_ptaki[,"waga"], "kg\n"))
}

#  it is possible to avoid using loop, when you perform an operation on a vector
cat(paste(koty_ptaki[,"gatunek"], "may weight up to", koty_ptaki[,"waga"], "kg\n"))

for (i in colnames(koty_ptaki)) {
  for (j in colnames(koty_ptaki)) {
# this command will be executed for each combination of the column names i and j 
    cat("Column '", i, "' and column '", j, "' together contain", nchar(i)+nchar(j), "characters.\n")
  }
}

# with a loop you may create a simple text presentation of the data
for (i in 1:nrow(koty_ptaki)) {
  n_kropek <- koty_ptaki[i,"predkosc"] / 5
  # printing dots
  for (j in 1:n_kropek) {
    cat(".")
  }
  # name of the species
  cat(" ", koty_ptaki[i,"gatunek"], "\n")
}
```

---

# Exercises

* Write a loop which will display the lifespan of given species from each row of the table `koty_ptaki`

* Write a loop which will display lifespan as a diagram in which one year is presented as one `#`.

* Write a loop which will draw a diagram presenting lifespans and place names of species on the left-hand side. Moreover, before each name of the species insert spaces so that the names are aligned right. You can read the length of the name expressed in the number of characters with the function `nchar()`. 

Sample answers are available at https://rawgit.com/pbiecek/MOOC/master/0_dane/9_zadania.html
