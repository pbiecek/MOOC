---
title: "Agregaty danych [dplyr / summarise]"
author: "pogRomcy danych"
date: "sezon 1 / odcinek 22 <br><br> Wszelkie prawa zastrzeżone.<br> Wykorzystanie możliwe wyłącznie za zgodą autora.  <br><br><br><br>Naciśnij `A` by zamienić slajdy na ciągły tekst. <br> Naciśnij `T` by wyświetlić spis treści."
output:
  slidy_presentation:
    includes:
      in_header: ../tracking.html
    highlight: default
    css: ../style.css
    font_adjustment: 0
    footer: "pogRomcy danych / przetwarzanie / agregaty"

---

# O czym jest ten odcinek

Ogląd całych danych jest możliwy tylko gdy dane nie są zbyt duże. Mieszczą się na jednym lub kilku ekranach.
Dla większych zbiorów danych konieczne jest agregowanie informacji z poziomu pojedynczych wierszy na poziom grup.

Aby efektywnie przedstawiać agregaty w grupach potrzebujemy funkcji liczącej agregaty oraz funkcji definiującej grupy. 
Do agregacji wygodnie wykorzystać funkcję `summarise()` z pakietu `dplyr`, którą przedstawimy w tym odcinku.

W tym odcinku nauczymy się:

- jak dla całego zbioru danych wyznaczać agregaty,
- jakie przykładowe agregaty można wyznaczać.

Do ilustracji tych zagadnień wykorzystamy dwa zbiory danych. Pierwszy, mały zbiór danych, to `koty_ptaki` a drugi, 
znacznie większy, to `auta2012`. Oba dostępne w pakiecie `SmarterPoland`.

---

# Ptaki vs. koty

Rozpocznijmy od przykładu dla małego zbioru danych. Widząc wszystkie wiersze łatwiej będzie nam zauważyć zależność pomiędzy oryginalnymi danymi a agregatami. Ten zbiór danych jest dostarczany razem z pakietem `SmarterPoland`. 

```{r, message=FALSE}
library(SmarterPoland)
koty_ptaki
```

---

# Agregaty

Do wyznaczania agregatów / podsumowań wykorzystamy funkcję `summarise()`. Jako pierwszy argument przyjmuje ona zbiór danych (w poniższym przykładzie przesłany za pomocą operatora `%>%`), kolejne argumenty to deklaracje, jak liczony ma być agregat oraz jak ma się nazywać odpowiadająca mu kolumna.

W pierwszej linii wczytujemy potrzebny pakiet `dplyr` a następnie liczymy następujące statystyki: minimalne i maksymalne prędkości, maksymalną i średnią wagą oraz coś ciut trudniejszego, maksymalną długość nazwy gatunku. 

Każdą z tych wartości moglibyśmy policzyć również bez funkcji `summarise()`, zalety korzystania z niej w pełni objawią się w kolejnym odcinku.

```{r, message=FALSE, warning=FALSE}
library(dplyr)

koty_ptaki %>%
  summarise(najszybszy = max(predkosc),
            najwolniejszy = min(predkosc),
            najciezszy = max(waga),
            srednia.waga = mean(waga),
            najdluzsza.nazwa = max(nchar(as.character(gatunek))))
```

---

# Agregaty szerzej

Tworząc agregaty możemy je opierać na więcej niż jednej zmiennej.  W poniższych przykładach liczymy średni i medianowy pęd oraz maksymalną prędkość mierzoną w liczbach długości ciała na sekundę. W każdym przykładzie statystykę liczymy na dwóch zmiennych.

```{r, message=FALSE, warning=FALSE}
koty_ptaki %>%
  summarise(sredni.ped = mean(waga*predkosc),
            medianowy.ped = median(waga*predkosc),
            predkosc.w.dlugosciach.na.sek = max(predkosc * 1000 / dlugosc / 3600))
```

Tworząc agregaty możemy wykorzystywać agregaty policzone w poprzednim kroku. W poniższym przykładzie liczymy średnią wagę a później przeliczamy ją na funty.

```{r, message=FALSE, warning=FALSE}
koty_ptaki %>%
  summarise(srednia.waga = mean(waga),
            srednia.waga.w.funtach = srednia.waga / 0.453)
```


---

# Auta

Pokażmy jeszcze przykład działania agregatów na większym zbiorze danych o cenach ofertowych samochodów. Będziemy pracować na kilku kolumnach. Poniżej wyświetlamy tylko markę, model cenę i przebieg dla pierwszych 6 wierszy ze zbioru danych `auta2012`.

```{r, message=FALSE}
auta2012 %>%
  select(Marka, Model, Cena.w.PLN, Przebieg.w.km) %>%
  head()
```

---

# Agregaty

Zbiór danych `auta2012` zawiera szczegółowe informacje o parametrach każdej oferty sprzedaży. Często z takich zbiorów danych interesują nas pewne statystyki agregujące informacje ze zbioru danych. 

Przykładem może być średnia cena, rozrzut ceny, przykładowo mierzony przez odchylenie standardowe ceny,
połówkowy przebieg czy jakiego przebiegu nie przekracza połowa aut. 

Takie agregaty możemy wyznaczyć funkcją `summarise()`.
Jako pierwszy argument podajemy zbiór danych a jako kolejne wskazujemy statystyki / agregaty, które chcemy wyznaczyć z tego zbioru danych. 

```{r, warning=FALSE}
auta2012 %>%
  summarise(sredniaCena = mean(Cena.w.PLN),
            sdCena = sqrt(var(Cena.w.PLN)),
            medianaPrzebiegu = median(Przebieg.w.km, na.rm=TRUE))
```

Funkcja `mean()` wyznacza średnią, funkcja `var()` wyznacza wariancję (a pierwiastek z wariancji jest odchyleniem standardowym), funkcja `median()` wyznacza medianę obserwacji w grupie.

Nie wszystkie wartości są podane dla wszystkich zmiennych. Jeżeli jakaś wartość nie została podana, to w zbiorze danych jest ona zakodowana jako NA (ang. Not Available) - brakująca wartość.

Jeżeli w zmiennej są wartości brakujące, to argument `na.rm=TRUE` oznacza, że wynik ma być wyznaczony po usunięciu wartości brakujących.

---

# Agregaty

Definicja agregatu może być bardziej rozbudowana niż jedna instrukcja. Przykładowo aby policzyć liczbę lub procent aut z klimatyzacją w pierwszym kroku możemy użyć funkcji `grepl()`, aby sprawdzić czy auto w danej ofercie ma klimatyzację, a następnie zsumować wyniki tej funkcji, by otrzymać liczbę aut z klimatyzacją. 

Licząc procent aut z automatyczną skrzynią biegów w pierwszym kroku możemy stworzyć zmienną logiczną określającą czy zmienna `Skrzynia.biegow` przyjmuje wartość `automatyczna`, a następnie policzyć procent za pomocą operacji `100*mean()`

Tworząc agregaty wygodnie jest korzystać z funkcji `n()`, której wynikiem jest liczba wierszy w zbiorze danych / grupie.

```{r, warning=FALSE}
auta2012 %>%
  summarise(liczba.aut.z.klimatyzacja = sum(grepl("klimatyzacja", Wyposazenie.dodatkowe)),
            procent.aut.z.klimatyzacja = 100*mean(grepl("klimatyzacja", Wyposazenie.dodatkowe)),
            procent.aut.z.automatem = 100*mean(Skrzynia.biegow == "automatyczna"),
            liczba.aut = n())
```

---

# Zadania

* Policz sumaryczny przebieg wszystkich samochodów. Następnie policz ile razy okrążono kulę ziemską uwzględniając te wszystkie przebiegi.
* Wybierz tylko samochody marki 'Rolls-Royce' i policz ich średni przebieg oraz średnią cenę.

Przykładowe odpowiedzi znajdują się na stronie https://rawgit.com/pbiecek/MOOC/master/0_dane/9_zadania.html
