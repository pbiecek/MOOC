---
title: "Filtrowanie danych [dplyr / select]"
author: "pogRomcy danych"
date: "sezon 1 / odcinek 17 <br><br> Wszelkie prawa zastrzeżone.<br> Wykorzystanie możliwe wyłącznie za zgodą autora.  <br><br><br><br>Naciśnij `A` by zamienić slajdy na ciągły tekst. <br> Naciśnij `T` by wyświetlić spis treści."
output:
  slidy_presentation:
    includes:
      in_header: ../tracking.html
    highlight: default
    css: ../style.css
    font_adjustment: 0
    footer: "pogRomcy danych / przetwarzanie / filter"

---

# O czym jest ten odcinek

Bazy danych zawierają najczęściej znacznie więcej informacji niż jest nam potrzebne. Jedną z kluczowych operacji jest więc filtrowanie, wybieranie tylko tych wierszy, które nas interesują. Przy czym 'nas interesują' oznacza spełnianie pewnych kryteriów.

W procesie przygotowania danych takie filtrowanie jest niesamowicie częstą instrukcją. W odcinku 7 pokazaliśmy jak wybierać wiersze spełniające określone kryterium, używając operatora `[`. W codziennej pracy często i wygodniej i szybciej jest wykorzystać dedykowaną fukcję `filter()` z pakietu `dplyr`.

W tym odcinku nauczymy się

- jak ze zbioru danych wybierać tylko interesujące nas wiersze?
- jak tworzyć złożóne kryteria wyboru wierszy?

Do ilustracji tych zagadnień wykorzystamy dwa zbiory danych. Pierwszy, mały zbiór danych, to `koty_ptaki` a drugi, 
znacznie większy, to `auta2012`, oba dostępne w pakiecie `SmarterPoland`.

---

# Ptaki vs. koty

Rozpocznijmy przykład dla filrowania od zbioru danych o kotach i ptakach. Ten zbiór danych jest dostarczany razem z pakietem `SmarterPoland`. Jest on na tyle mały, że wynik operacji będzie można przedstawić na ekranie.

Pokażemy jak z tego zbioru danych wybierać wiersze, widząc cały zbiór danych łątwiej zrozumieć które wiersze zostały wyfiltrowane.

```{r, message=FALSE}
library(SmarterPoland)
koty_ptaki
```

---

# Filtrowanie danych

Funkcja **filter()** reduluje liczbę wierszy, zostawiając tylko te, które spełniają określony warunek (jeden lub kilka).
Pierwszym argumentem tej funkcji jest ramka danych lub tabela danych,
kolejne argumenty, a może być ich jeden lub więcej) to warunki logiczne.
Wynikiem jest ramka danych z wierszami, które spełniają jednocezśnie wszystkie wskazane warunki.

Przykładowo, aby zobaczyć, które zwierzaki przekraczają prędkość 100 km na godzinę możemy użyć następujących komend.
W pierwszej linii wczytujemy pakiet `dplyr`. 

```{r, message=FALSE}
library(dplyr)
filter(koty_ptaki,
       predkosc > 100)
```

---

# Dwa lub więcej warunków

Możemy określać jednocześnie więcej warunków dla filtrowania.
Każdy kolejny warunek można podać jako kolejny argument funkcji filter.

Poniższy przykład wybiera ze zbioru danych tylko te gatunki, które spełniają jednocześnie trzy warunki. 

Są to ptaki, które przekraczają prędkość 100 km na godzinę i występują na półkuli północnej. 

Operator `%in%` zwraca TRUE jeżeli określona wartość występuje w wektorze po prawej stronie.

```{r, warning=FALSE}
filter(koty_ptaki,
       predkosc > 100,
       druzyna == "Ptak",
       habitat %in% c("Polnoc", "Euroazja")
       )
```

---

# Auta

Operacje filtrowania przećwiczymy też na znacznie większym zbiorze danych, który juz nie sposób w całości wyświetlić na ekranie. Mianowicie na zbiorze danych o cenach ofertowych używanych samochodów.

Zbiór danych `auta2012` jest dostępny po wczytaniu pakietu `SmarterPoland`. Poniżęj przedstawiamy 6 pierwszych wierszy z tego zbioru danych. Szczegółowy opis tego zbioru znajduje się na stronie https://rawgithub.com/pbiecek/MOOC/master/0_dane/0_dane.html

```{r, message=FALSE}
head(auta2012)
```

---

# Tabele danych

W tym miejscu warto zaznaczyć, że funkcje z pakietu `dplyr` pracują nie tylko na ramkach danych, które już znamy i które mają klasę `data.frame`, ale również na tabelach danych, obiektach o klasie `tbl`.

Z użytkownego punktu widzenia, tabele danych od ramek danych różnią się sposobem wyświetlania na ekranie (nie wyświetlają się kolumny, nei mieszczące się w obecnej szerokości konsoli) ale też wewnętrzną reprezentacją, która pozwala na szybsze operowanie na danych w strukturze `tbl`. 

Jeżeli mamy więc dane duże, o dużej liczbie wierszy lub kolumn, często dobrym pomysłem jest przekształcenie je na postać tabeli danych.

Ramkę danych na tabelę można zamienić funkcją `tbl_df` a tabelę na ramkę danych funkcją `as.data.frame()`.

```{r, warning=FALSE}
auta2012 <- tbl_df(auta2012)
auta2012
```

---

## Filtrowanie danych

Przypuśćmy, że chcemy ograniczyć liste aut do jednej wybranej marki.


Przykładowo, jeżeli chcemy pozostawić tylko samochody marki Porsche, możemy użyć warunku `Marka == 'Porsche'`.

```{r, warning=FALSE}
tmp <- filter(auta2012,
        Marka == "Porsche")
head(tmp)
```

---

## Dwa warunki

Możemy określać jednocześnie więcej warunków.
Na przykład tylko samochody Audi o silnikach o liczbie koni mechanicznych przekraczających 300 możemy odfiltrować w następujący sposób.

```{r, warning=FALSE}
tylkoPorscheZDużymSilnikiem <- filter(auta2012,
         Marka == "Porsche",
         KM > 300)
head(tylkoPorscheZDużymSilnikiem)
```

---

## Zadania

+ Ze zbioru danych `auta2012` pozostaw tylko samochody o wieku do pięciu lat (czyli o roku produkcji > 2007). Nazwij ten wynikowy zbiór danych `mlodeAuta`
+ Z przed chwilą stworzonego zbioru danych `mlodeAuta` wybierz tylko Fiaty 500. Ile jest takich aut? 
(wymiary ramki danych możesz sprawdzić funkcją **dim()**)


