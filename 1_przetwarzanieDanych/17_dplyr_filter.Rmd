---
title: "Filtrowanie danych [dplyr / select]"
author: "pogRomcy danych"
date: "sezon 1 / odcinek 17 <br><br> Przemysław Biecek @ Uniwersytet Warszawski<br><br><br>Naciśnij `A` by zamienić slajdy na ciągły tekst. <br> Naciśnij `T` by wyświetlić spis treści."
output:
  slidy_presentation:
    includes:
      in_header: ../tracking.html
    highlight: default
    css: ../style.css
    font_adjustment: 0
    footer: "pogRomcy danych / przetwarzanie / filter"

---

# O czym jest ten odcinek

Bazy danych zawierają najczęściej znacznie więcej informacji niż jest nam potrzebne. Jedną z kluczowych operacji jest więc filtrowanie, 
wybieranie tylko tych wierszy, które nas interesują. Przy czym stwierdzenie 'interesują nas' oznacza spełnianie pewnych kryteriów.

W procesie przygotowania danych takie filtrowanie jest niesamowicie częstą instrukcją. W odcinku 7 pokazaliśmy jak wybierać wiersze spełniające 
określone kryterium, używając operatora `[`. W codziennej pracy nie tylko wygodniej, ale i szybciej jest wykorzystać dedykowaną funkcję `filter()` z pakietu `dplyr`.

W tym odcinku nauczymy się:

- jak ze zbioru danych wybierać tylko interesujące nas wiersze,
- jak tworzyć złożone kryteria wyboru wierszy.

Do ilustracji tych zagadnień wykorzystamy dwa zbiory danych. Pierwszy, mały zbiór danych, to `koty_ptaki`, a drugi, 
znacznie większy, to `auta2012`. Oba dostępne są w pakiecie `PogromcyDanych`.

---

# Ptaki vs. koty

Rozpocznijmy przykład filtrowania od zbioru danych o kotach i ptakach. Ten zbiór danych jest dostarczany razem z pakietem `PogromcyDanych`. 
Jest on na tyle mały, że wynik operacji będzie można przedstawić na ekranie.

Pokażemy jak z tego zbioru danych wybierać wiersze. Widząc cały zbiór danych łatwiej zrozumieć które wiersze zostały wyfiltrowane.

```{r, message=FALSE}
library(PogromcyDanych)
koty_ptaki
```

---

# Filtrowanie danych

Funkcja **filter()** redukuje liczbę wierszy, zostawiając tylko te, które spełniają określony warunek (jeden lub kilka).
Pierwszym argumentem tej funkcji jest ramka danych lub tabela danych,
kolejne argumenty (a może być ich jeden lub więcej) to warunki logiczne.
Wynikiem jest ramka danych z wierszami, które spełniają jednocześnie wszystkie wskazane warunki.

Przykładowo, aby zobaczyć, które zwierzaki przekraczają prędkość 100 km na godzinę możemy użyć następujących komend.
W pierwszej linii wczytujemy pakiet `dplyr`. 

```{r, message=FALSE}
library(dplyr)
filter(koty_ptaki,
       predkosc > 100)
```

---

# Dwa lub więcej warunków

Możemy określać jednocześnie więcej warunków dla filtrowania.
Każdy kolejny warunek można podać jako kolejny argument funkcji `filter()`.

Poniższy przykład wybiera ze zbioru danych tylko te gatunki, które spełniają jednocześnie trzy warunki. 

Są to ptaki, które przekraczają prędkość 100 km na godzinę i występują na półkuli północnej. 

Operator `%in%` zwraca TRUE jeżeli określona wartość występuje w wektorze po prawej stronie.

```{r, warning=FALSE}
filter(koty_ptaki,
       predkosc > 100,
       druzyna == "Ptak",
       habitat %in% c("Polnoc", "Euroazja")
       )
```

---

# Auta

Operacje filtrowania przećwiczymy też na znacznie większym zbiorze danych, który już nie sposób w całości wyświetlić na ekranie, 
a mianowicie na zbiorze danych o cenach ofertowych używanych samochodów.

Zbiór danych `auta2012` jest dostępny po wczytaniu pakietu `PogromcyDanych`. Poniżej przedstawiamy 6 pierwszych wierszy z tego zbioru danych. 
Szczegółowy opis tego zbioru znajduje się na stronie http://pogromcydanych.icm.edu.pl/materials/1_przetwarzanie/0_dane.html

```{r, message=FALSE}
head(auta2012)
```

---

# Tabele danych

W tym miejscu warto zaznaczyć, że funkcje z pakietu `dplyr` pracują nie tylko na ramkach danych, które już znamy i które mają klasę `data.frame`, 
ale również na tabelach danych - obiektach klasy `tbl`.

Z użytkowego punktu widzenia, tabele danych od ramek danych różnią się głównie sposobem wyświetlania na ekranie (nie wyświetlają się kolumny, 
nie mieszczące się w obecnej szerokości konsoli). W rzeczywistości różnią się także szeregiem innych właściwości, między innymi wewnętrzną 
reprezentacją, która pozwala na szybsze operowanie na danych w strukturze `tbl`. 

Jeżeli mamy więc dane duże, o dużej liczbie wierszy lub kolumn, często dobrym pomysłem jest przekształcenie je na postać tabeli danych.

Ramkę danych na tabelę można zamienić funkcją `tbl_df` a tabelę na ramkę danych funkcją `as.data.frame()`.

```{r, warning=FALSE}
auta2012 <- tbl_df(auta2012)
auta2012
```

---

## Filtrowanie danych

Przypuśćmy, że chcemy ograniczyć listę aut do jednej wybranej marki.


Przykładowo, jeżeli chcemy pozostawić tylko samochody marki Porsche, możemy użyć warunku `Marka == 'Porsche'`.

```{r, warning=FALSE}
tmp <- filter(auta2012,
        Marka == "Porsche")
head(tmp)
```

---

## Dwa warunki

Możemy określać jednocześnie więcej warunków.
Na przykład tylko samochody Porsche o silnikach o liczbie koni mechanicznych przekraczających 300 możemy odfiltrować w następujący sposób.

```{r, warning=FALSE}
tylkoPorscheZDuzymSilnikiem <- filter(auta2012,
         Marka == "Porsche",
         KM > 300)
head(tylkoPorscheZDuzymSilnikiem)
```

---

## Zadania

+ Ze zbioru danych `auta2012` pozostaw tylko samochody o wieku do pięciu lat (czyli o roku produkcji > 2007). Nazwij ten wynikowy zbiór danych `mlodeAuta`
+ Z przed chwilą stworzonego zbioru danych `mlodeAuta` wybierz tylko Fiaty 500. Ile jest takich aut? 
(wymiary ramki danych możesz sprawdzić funkcją **dim()**)

Przykładowe odpowiedzi znajdują się na stronie http://pogromcydanych.icm.edu.pl/materials/1_przetwarzanie/9_zadania.html

