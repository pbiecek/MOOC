---
title: "Data and Analysis Grouping [dplyr / group_by]"
author: "Data CruncheRs"
date: "Season 1 / Episode 23 <br><br> All rights reserved. <br> The use shall be subject to prior consent of the author.  <br><br><br><br>Press `A` to see the plain text instead of the slides. <br> Press `T` to display the table of contents."
output:
  slidy_presentation:
    includes:
      in_header: ../tracking.html
    highlight: default
    css: ../style.css
    font_adjustment: 0
    footer: "Data CruncheRs / processing / grouping"

---

# What Is This Episode About?

In the previous Episode we showed how to compute the statistics / aggregates on the data set. This option is even more useful if we compute these aggregates in the groups. With this, we can easily compare such groups later. To define the groups, we will use the function `group_by()` of the package `dplyr`.

In this Episode, we will learn:

- How to define one or more grouping variables,
- How to calculate the aggregates in the groups.

To illustrate these issues, we will use two sets of data. The first small set of data is `koty_ptaki` and the second, considerably bigger one is `auta2012`, both available in the `PogromcyDanych` package.

---

# Birds Vs Cats

Let’s start with the example of the small cats and birds data set. It is small enough to display the result of the operations on the screen.

The variable `druzyna` is excellently suitable for being a grouping variable.

```{r, message=FALSE}
library(PogromcyDanych)
koty_ptaki
```

# Birds Vs Cats

The function `group_by()` assumes the dataset to be the first argument, and the grouping variables (one or more) to be the next arguments. The function `group_by()` itself does not effect computation of the new values, but only indicates, which variables need to be used for grouping. Thus, the effect of the subsequent functions, such as `summarise()` will be different.

Let’s see how the use of the function `group_by()` to compare the maximum weight, speed, and vitality in the bird and cat group looks like.

The result is the data frame, the columns of which are first the grouping variables and then the aggregate results in the groups.

```{r, message=FALSE, warning=FALSE}
library(dplyr)

koty_ptaki %>%
  group_by(druzyna) %>%
  summarise(najszybszy = max(predkosc),
            najciezszy = max(waga),
            najzywotniejszy = max(zywotnosc),
            liczba = n())
```

---

# Cars

In order to present more possibilities of the grouping operation, we will use the set of data `auta2012`.

Please find below six first rows and the selected columns of this set of data. You can find the detailed description of this set at https://rawgithub.com/pbiecek/MOOC/master/O_dane/O_dane.html.

```{r, message=FALSE}
auta2012 %>%
  select(Cena.w.PLN, Marka, Przebieg.w.km, Rodzaj.paliwa, Rok.produkcji) %>%
  head()
```

---

# Grouping

We are going to start the examples for the data on the car offer prices with the comparison of the prices and mileages of the cars using different types of fuel.

In order to reasonably compare different types of fuel, we limit ourselves to one car make and one year of manufacture. 
In the below example, we select only 5-year old Volkswagen, and then for the gasoline-, diesel oil-, or gas-fuelled cars, we compute the median of the price and mileage, and the number of the cars in that group.

```{r, warning=FALSE}
auta2012 %>%
  filter(Marka == "Volkswagen", Rok.produkcji == 2007) %>%
  group_by(Rodzaj.paliwa) %>%
  summarise(medianaCeny = median(Cena.w.PLN, na.rm=TRUE),
            medianaPrzebieg = median(Przebieg.w.km, na.rm=TRUE),
            liczba = n())
```

The largest car group includes the diesel oil-fuelled cars. Their mileage is almost twice as high as of the gasoline-fuelled cars (see the medians), and yet they are more expensive by about 15\%. 

---

# Sorting

We can work with the aggregates like with the data frames.  We can transfer them further to the functions, which sort, select, or change the variables.

In the example below, we sort the aggregates by the number of observations.

```{r, warning=FALSE}
auta2012 %>%
  filter(Marka == "Volkswagen", Rok.produkcji == 2007) %>%
  group_by(Rodzaj.paliwa) %>%
  summarise(medianaCeny = median(Cena.w.PLN, na.rm=TRUE),
            medianaPrzebieg = median(Przebieg.w.km, na.rm=TRUE),
            liczba = n()) %>%
  arrange(liczba)
```

---

# Grouping by Two Variables

You can group by several variables, in which case the aggregates are counted in each variable subset.

Let’s see how the mileages and prices would look like, if we additionally divide the cars into the models. In the group of 5-year old Volkswagens, you can find 19 various models.

The below instruction is virtually identical to the previous one, the only difference is that we group by two variables, model and fuel type.

```{r, warning=FALSE}
auta2012 %>%
  filter(Rok.produkcji == 2007, Marka == "Volkswagen") %>%
  group_by(Model, Rodzaj.paliwa) %>%
  summarise(medianaCeny = median(Cena.w.PLN, na.rm=TRUE),
            medianaPrzebieg = median(Przebieg.w.km, na.rm=TRUE),
            liczba = n()) 

```

---

# Grouping and Filtering

In the previous example, many groups were small, so their results were quite random, and thus difficult to compare.

The application of the function `filter()` at the end enables to leave only those groups with more than 10 observations.

Please note that in the below example, the function `filter()` occurs twice, in the first case it filters the rows in the original dataset, and in the second case it filters too small groups.

```{r, warning=FALSE}
auta2012 %>%
  filter(Rok.produkcji == 2007, Marka == "Volkswagen") %>%
  group_by(Model, Rodzaj.paliwa) %>%
  summarise(medianaCeny = median(Cena.w.PLN, na.rm=TRUE),
            medianaPrzebieg = median(Przebieg.w.km, na.rm=TRUE),
            liczba = n()) %>%
  filter(liczba > 10) 
```

---

# Exercises

* Select 5-year old Volkswagens Golf and check whether the average price depends on a country of the current registration. For this purpose, group by the variable `Kraj.aktualnej.rejestracji` and compute the mean value in each group.

* Select Peugeot 206 cars only and calculate the mean price depending on the year of manufacture. Arrange those groups by the year of manufacture.

You can find the exemplary answers at https://rawgit.com/pbiecek/MOOC/master/0_dane/9_zadania.html

# What’s Next?

The package `dplyr` has completely changed a manner of data processing in the R. The processing has become easier to describe, 80\% of the redundant work can be performed more simply and quicker.

A great supplement to the results of the Episodes about this package will be a graphical 2-page cheat sheet that features the capabilities of this package. This cheat sheet is available at http://www.rstudio.com/wp-content/uploads/2015/01/data-wrangling-cheatsheet1.pdf.

More such cheat sheets are available on the website of RStudio at http://www.rstudio.com/resources/cheatsheets/

A short presentation of the most important functions of the package illustrated with an example of flight data can be found on the workshop website of the `dplyr` creator at http://cran.rstudio.com/web/packages/dplyr/vignettes/introduction.html.
