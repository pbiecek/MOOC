---
title: "Czyszczenie i wprowadzenie do obróbki danych"
author: "pogRomcy danych"
date: "sezon 1 / odcinek 16 <br><br> <a href='http://biecek.pl/'>Przemysław Biecek @ Uniwersytet Warszawski</a><br><br><br>Naciśnij `A` by zamienić slajdy na ciągły tekst. <br> Naciśnij `T` by wyświetlić spis treści."
output:
  slidy_presentation:
    includes:
      in_header: ../tracking.html
    highlight: default
    css: ../style.css
    font_adjustment: 0
    footer: "pogRomcy danych / przetwarzanie / czyszczenie i obróbka"

---

# O czym jest ten odcinek

Praca z danymi to w dużej części czyszczenie i wielokrotna zmiana reprezentacji. Po co dane czyścić? Zarówno dane zbierane przez ludzi, jak i przez automatyczne czujniki, 
mają tendencje do zawierania braków, obserwacji odstających lub zwykłych błędów. Aby móc sensownie analizować dane, musimy przekształcić je do postaci w której wyniki analiz będą wiarygodne.

Czyszczenie to bardzo istotna faza. Bez względu bowiem jak zaawansowana i dobrze dobrana jest nasza technika analiza danych, jeżeli na wejściu będą śmieciowe dane to na wyjściu będą śmieciowe wyniki. *Garbage in garbage out*

W tym odcinku nauczymy się:

- jak edytować zbiory danych by doprowadzić je do spójnej postaci,
- jak zastępować jedne wartości przez inne,
- jak identyfikować wartości odstające / zbędne.

Mając dane wyczyszczone, możemy przejść do kolejnych etapów, czyli wstępnej obróbki, analizy i wizualizacji.

---

# Tworzenie danych przez funkcję data.frame()

Na potrzeby ćwiczeń z czyszczenia danych stworzymy sztuczną ramkę danych z kilkoma celowo dodanymi błędami.

Ramkę danych stworzymy funkcją `data.frame()`. Kolejne argumenty to wektory, które zostaną zamienione na kolejne kolumny w ramce danych. 
Ostatni argument `stringsAsFactors = FALSE` określa, że napisy mają NIE być zamieniane na zmienne jakościowe (domyślne dochodzi do zamiany).

```{r}
DF <- data.frame(
        imie = c("Maja","Anna","Zosia","Anna"),
        wiek = c("40","12,5","25","16.6"),
        numer = c(1,2,NA,4),
        oczo = factor(c("niebieskie", "jasno-niebieskie", "ciemne", "niebieskie")),
        stringsAsFactors = FALSE)
DF
```

W wynikowej ramce będziemy chcieli poprawić następujące błędy:

+ nazwę kolumny `oczo` zamienić na `oczy`,
+ zmienną `wiek` zamienić na liczbową, w tym celu trzeba wpierw zamienić `,` na `.`,
+ imię `Zosia` zamienić na `Zofia`,
+ kolory oczu zamienić na dwie grupy: `niebieskie` i `ciemne`.


# Zamiana nazwy kolumny

Aby wyświetlić nazwy kolumn można wykorzystać funkcję `colnames()`. Wynikiem jest wektor napisów, można na elementach tego wektora używać indeksów podobnie jak w poniższym przykładzie.
Analogicznie funkcja `rownames()` pozwala na pracę z nazwami wierszy.

```{r}
colnames(DF)
# czwarty element wektora
colnames(DF)[4]
```

Funkcji `colnames()` można również użyć by zmienić nazwy kolumn. Poniższe dwie instrukcje wywołają funkcję `colnames<-()`, 
która zmienia nazwy kolumn. Można jednocześnie zmienić wszystkie lub tylko wybrane elementy wektora nazw kolumn.

Obie poniższe instrukcje poprawią nazwę ostatniej kolumny.

```{r}
colnames(DF) <- c("imie", "wiek", "numer", "oczy")
colnames(DF)[4] <- "oczy"
```

W wyniku mamy więc zbiór danych

```{r}
DF
```

# Zamiana przecinka na kropkę

Jeżeli pracujemy na danych wprowadzanych przez człowieka to często zdarza się, że raz wpisuje on jako separator dziesiętny znak `.` (kropka), a  raz `,` (przecinek). 
Jeszcze więcej problemów tego typu występuje, gdy dane wprowadza kilka osób.

```{r}
DF$wiek
```

Zamienimy przecinek na kropkę i zamienimy napis na liczbę. 

Do podmiany znaków użyjemy funkcji `gsub()`, (opisanej także w odcinku 14 tego sezonu). Nazwy argumentów `pattern` i `replacement` 
można by pominąć, ponieważ są w domyślnej kolejności, ale wpisujemy je tutaj dla czytelności.

Wynik przekazujemy do funkcji `as.numeric()`, która zamienia napisy na liczby. Ostatecznie wynik przypisujemy do kolumny `wiek`.

Dwie linie opatrzyliśmy nawiasami `()` aby wynik przypisania został wyświetlony na ekranie.

```{r}
(tmp <- gsub(pattern = ",", replacement = ".", DF$wiek))
(DF$wiek <- as.numeric(tmp))
```

W wyniku mamy więc poprawiony zbiór danych

```{r}
DF
```

# Normalizacja kolumny lub wiersza

W analizie danych często spotykamy się z sytuacją, gdy dane w kolumnie chcemy unormować. 

Unormować, czyli wycentrować, a więc usunąć z nich wartość średnią (tak by średnia była równa 0), i przeskalować, 
czyli podzielić tak, aby odchylenie standardowe było równe 1. 

Do normalizacji można wykorzystać funkcję `scale()`. Domyślnie centruje i skaluje ona dane, ale ustawiając dodatkowe 
argumenty możemy wyłącznie wycentrować lub przeskalować dane.

Wynik funkcji `scale()` możemy przypisać do kolumny zbioru danych. 

```{r}
# tylko centrowanie: scale(DF$wiek, center = TRUE, scale = FALSE)
# tylko skalowanie:  scale(DF$wiek, center = FALSE, scale = TRUE)
# normalizacja
(DF$wiekNorm <- scale(DF$wiek))
```

Otrzymujemy nowy, poszerzony zbiór danych

```{r}
DF
```

# Usuwanie lub zastępowanie brakujących danych

W kolumnie `numer` występują brakujące wartości `NA`. 

Takie wartości możemy usunąć (tzn. usunąć musimy cały wiersz) korzystając z funkcji `na.omit()` 
```{r}
na.omit(DF)
```

Lub zastąpić przez np. średnią w kolumnie. Na poniższym przykładzie funkcją `is.na()` identyfikuje wartości brakujące, 
funkcja `which()` wyznacza indeksy wartości brakujących. Te indeksy będą następnie wykorzystane aby nadpisać wartości brakujące przez średnią wyznaczoną przez funkcję `mean()`.

```{r}
(ktorePuste <- which(is.na(DF$numer)))
DF$numer[ktorePuste] <- mean(DF$numer, na.rm=TRUE)
```

Otrzymujemy nowy, uzupełniony zbiór danych

```{r}
DF
```

# Nazwy czynników w zmiennej jakościowej 

Gdy przetwarzamy zmienną jakościową, częstą operacją jest zmiana nazw poziomów, zmiana ich kolejności lub połączenie kilku poziomów w jeden.

```{r}
DF$oczy
```

Aby wyświetlić lub zmienić nazwy poziomów można wykorzystać funkcję `levels()`. W podobny sposób co dla `colnames()` tą samą funkcją możemy wyświetlić wektor nazw lub go zmienić.

Jeżeli przypiszemy do niego wartości z powtarzającymi się napisami, to wskazane poziomy zostaną połączone w jeden.

```{r}
levels(DF$oczy)
levels(DF$oczy) <- c("ciemne", "niebieskie", "niebieskie")
DF$oczy
```

Jeżeli chcemy zmienić kolejność poziomów w zmiennej jakościowej, to najłatwiej jest to zrobić z użyciem funkcji `factor()`. 
W argumencie `levels` możemy podać poziomy w dowolnej kolejności. Wartości są takie same, ale kolejność poziomów jest inna. 
Kolejność poziomów jest ważna w tworzeniu wykresów (odpowiada ona kolejności poziomów na wykresie) oraz w modelowaniu statystycznym.

```{r}
factor(DF$oczy, levels=c("niebieskie", "ciemne"))
```

Otrzymujemy nowy, zmieniony zbiór danych

```{r}
DF
```


# Podmiana dowolnej wartości

Często się zdarza, że w kolumnie podmienić trzeba wszystkie wartości na inne. Być może ktoś omyłkowo 
wpisał `100.00` zamiast `10000` i trzeba zastąpić jedną wartość przez drugą. Być może ktoś źle wpisywał 
nazwy terapii i chcemy te nazwy pozmieniać.
 
Na przykładzie poniżej zastąpimy imiona `Anna` na `Joanna`. Wynik przyrównania zwraca wektor wartości logicznych.

```{r}
DF$imie=="Anna"
```

Można ten wektor wykorzystać do indeksowania wiersza. Jeżeli do kilkuelementowego wektora przypiszemy 
jedną wartość, tak jak w przykładzie poniżej, to wszystkie elementy tego wektora zostaną zastąpione przez tę wartość.

```{r}
DF$imie[DF$imie=="Anna"] <- "Joanna"
```

W wyniku tej instrukcji otrzymujemy nowy, zmieniony zbiór danych.

```{r}
DF
```

# Zadania

Po wczytaniu poniższej ramki danych napraw następujące błędy:

+ popraw nazwę kolumny `litary`,
+ zamień wartości `X` i `Y` odpowiednio na `A` i `B`,
+ zamień kolumnę `liczby` na kolumnę liczb,
+ zastąp brakujące dane w kolumnie `braki`.

```{r}
df <- data.frame(
        litary = c("X","B","Y","D"),
        liczby = c("1","2","3,0","4,0"),
        braki = c(NA,1,NA,1),
        stringsAsFactors = FALSE)
df
```


# Co dalej

Na tych kilku slajdach zaledwie zarysowaliśmy temat czyszczenia danych. Więcej informacji na temat poprawiania zbiorów danych znaleźć można na przykład w pozycjach:

+ Rozdział 3.3 ,,Wstępne przetwarzanie danych'' w książce ,,Przewodnik po pakiecie R'', dostępnej pod adresem http://biecek.pl/R/
+ W języku angielskim książka ,,An introduction to data cleaning with R'' http://cran.r-project.org/doc/contrib/de_Jonge+van_der_Loo-Introduction_to_data_cleaning_with_R.pdf
+ W języku angielskim kurs na portalu Coursera ,,Getting and Cleaning Data'' https://www.coursera.org/course/getdata

Przykładowe odpowiedzi znajdują się na stronie http://pogromcydanych.icm.edu.pl/materials/1_przetwarzanie/9_zadania.html


