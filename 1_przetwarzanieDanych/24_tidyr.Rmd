---
title: "Reformatowanie i przerzucanie danych [tidyr]"
author: "pogRomcy danych"
date: "sezon 1 / odcinek 24 <br><br> Wszelkie prawa zastrzeżone.<br> Wykorzystanie możliwe wyłącznie za zgodą autora.  <br><br><br><br>Naciśnij `A` by zamienić slajdy na ciągły tekst. <br> Naciśnij `T` by wyświetlić spis treści."
output:
  slidy_presentation:
    includes:
      in_header: ../tracking.html
    highlight: default
    css: ../style.css
    font_adjustment: 0
    footer: "pogRomcy danych / przetwarzanie / formatowanie"

---

# O czym jest ten odcinek

Dane najczęściej są przedstawiane w postaci tabelarycznej. Jednak mogą być w tej tabeli różnie sformatowane. Wyróżnia się między innymi reprezentacje szeroką danych, wąską danych i reprezentacje mieszane.

Po co taka róznorodność? Otóż w zalezności od tego co z danymi chcemy zrobić czasem lepiej je mieć w takiej czy innej postaci. Pakiet `tidyr` udostępnia funkcje, aby szybko i wygodnie przechodzić z jednego sposobu reprezentacji na drugi.

W tym odcinku nauczymy się

- Jak przejść z wąskiej postaci na szeroką
- Jak przejść z szerokiej postaci do wąskiej

Do ilustracji tych zagadnień wykorzystamy dwa zbiory danych. Pierwszy, to zbiór danych `kidney` z pakietu `PBImisc`, pozwoli nam na ilustracje przejścia z formatu szerokiego na wąski. Drugi zbiór danych to dane z Eurostatu, które pobierzemy z użyciem pakietu `SmarterPoland`. Pozwolą one zilustrować przejście z reprezentacji wąskiej danych na szeroką.

---

# Dane o pracy nerki

Aby zilustrować czym jest szeroka reprezentacja danych i jak przejść z niej na wąską reprezetnację wykorzystamy zbiór danych `kidney` z pakietu `PBImisc`. Ten pakiet nie jest dostępny wraz z bazową wersją R. Należy go doinstalować funkcją `install.packages()` (informacja o tym jak to zrobić jest w odcinku 2). Po instalacji włączymy ten pakiet a następnie ze zbioru `kidney` wybierzemy kilka interesujących nas kolumn. Każdy wiersz w tym zbiorze danych opisuje jednego pacjenta. W kolumnie `therapy` znajduje się zmienna jakościowa o trzech poziomach a w kolumnach MDRD7 ... MDRD60 znajdują sie pomiary sprawności nerki (mierzone współczynnikiem MDRD) w dniach 7, 30, oraz miesiącach 3, 6, 12, 24, 36 i 60 po przeszczepie.

```{r, warning=FALSE, message=FALSE}
library(PBImisc)
library(dplyr)
kidney$id <- rownames(kidney)
kidney_wybrane <- kidney %>% 
  dplyr::select(id, therapy, MDRD7:MDRD60)

head(kidney_wybrane)
```

---

# Dane o pracy nerki



```{r, warning=FALSE, message=FALSE}
library(tidyr)

kidney_waska <- kidney_wybrane %>% 
  gather(time, MDRD, MDRD7:MDRD60)

kidney_waska %>% 
  head()

```

---

# Dane do ćwiczeń

Pakiet `tidyr` zawiera kilka użytecznych funkcji do zmiany kształtu danych. 
Do ilustracji tych funkcji wykorzystamy zbiór danych z eurostatu o popularności transpostu w różnych krajach.

Do pobrania tych danych użyjemy funkcji `getEurostatRCV()`, która zwraca dane w tak zwanej wąskiej postaci.

```{r, warning=FALSE, message=FALSE}
library(SmarterPoland)
tsdtr210 <- getEurostatRCV("tsdtr210")
head(tsdtr210)
```

---

# Z postaci wąskiej do szerokiej

Aby przejść z postaci wąskiej do postaci szerokie, można użyć funkcji `spread()`.

Jej pierwszym argumentem jest ramka z danymi, a kolejne dwie zmienne określają kolumnę w której przechowywane są klucze i wartości. Następnie ramka danych jest konwertowana w ten sposób, że wartości drugiej kolumny wejściowego zbioru danych stają się nazwami kolumn wyjściowego zbioru danych.

```{r, warning=FALSE, message=FALSE}
library(tidyr)
library(dplyr)
szeroka <- 
  tsdtr210 %>%
    spread(time, value)

# wyświetlmy wiersze dla Polski
szeroka %>%
  filter(geo == "PL")
```

---

# Z szerokiej do wąskiej

Odwrotną operację, przejście z postaci szerokiej do wąskiej, można wykonać operacją `gather()`.

Pierwszym argumentem jest zbiór danych (poniżej przekazany za pomocą operatora `%>%`), kolejne dwa określają nazwy nowych kolumn w których zapisane będą klucze i wartości. Trzeci argument to opis kolumn, które mają być zamienione na postać wąską.


```{r, warning=FALSE, message=FALSE}
szeroka %>% 
  gather(rok, wartosc, -geo, -vehicle) %>%
  head()
```

---

# Sklejanie i rozcinanie kolumn.

Zdarza się, że wartości z kilku kolumn chcemy połączyć w jedną kolumnę, sklejając je ze sobą.
Można tę operację łatwo wykonać funkcją `unite()`.

```{r, warning=FALSE, message=FALSE}
szeroka %>%
  unite(połącz, vehicle : geo, sep=".") %>%
  head(3)
```

Operację odwrotną można wykonać funkcją `separate()`

---

# Zadania
* W bazie danych eurostatu `prc_ppp` zebrane są informacje o średniej mocy nabywczej.
Odczytaj te dane a następnie zamień z postaci wąskiej do szerokiej.

Przykładowe odpowiedzi znajdują się na stronie https://rawgit.com/pbiecek/MOOC/master/0_dane/9_zadania.html



