---
title: "Wyznaczanie nowych zmiennych danych [dplyr / mutate]"
author: "pogRomcy danych"
date: "sezon 1 / odcinek 21 <br><br> Przemysław Biecek @ Uniwersytet Warszawski<br><br><br>Naciśnij `A` by zamienić slajdy na ciągły tekst. <br> Naciśnij `T` by wyświetlić spis treści."
output:
  slidy_presentation:
    includes:
      in_header: ../tracking.html
    highlight: default
    css: ../style.css
    font_adjustment: 0
    footer: "pogRomcy danych / przetwarzanie / mutate"

---

# O czym jest ten odcinek

Bardzo często na podstawie istniejących danych tworzymy nowe.
Mając prędkość w metrach na sekundę liczymy prędkość w kilometrach na godzinę. Mając wagę i wzrost liczymy BMI. Mając odległość w milach liczymy odległość w kilometrach i tak dalej.

W programie R na różne sposoby można dodać nową zmienną do zbioru danych. Z tych wszystkich sposobów wygodnym i szybkim jest z wykorzystaniem funkcji `mutate()` z pakietu `dplyr`.

W tym odcinku nauczymy się:

- jak do zbioru danych dodać nową kolumnę,
- jak nadpisać wartości w istniejącej kolumnie.

Do ilustracji tych zagadnień wykorzystamy dwa zbiory danych. Pierwszy, mały zbiór danych, to `koty_ptaki` a drugi, 
znacznie większy, to `auta2012` - oba dostępne w pakiecie `PogromcyDanych`.

# Ptaki vs. koty

Rozpocznijmy przykład dla tworzenia nowych zmiennych od zbioru danych o kotach i ptakach. Jest on na tyle mały, że wynik operacji będzie można przedstawić na ekranie.

```{r, message=FALSE}
library(PogromcyDanych)
koty_ptaki
```

---

# Wyliczanie nowych zmiennych

W zbiorze danych `koty_ptaki` jest zmienna `predkosc` opisująca prędkość w kilometrach na godzinę.

Dodajmy dwie nowe zmienne. W jednej przeliczmy prędkość z kilometrów na godzinę na prędkość w milach na godzinne, w drugiej przeliczymy prędkość na liczbę długości na sekundę 
(długość zwierząt jest w metrach). Nową zmienną można dodać funkcją `mutate()`. Pierwszym argumentem jest ramka danych, a kolejne to deklaracje nowych zmiennych w postaci `nazwa.zmiennej = wzór.na.nową.zmienną`. 

W przetwarzaniu danych wykorzystamy operator `%>%` omówiony w 20 odcinku. 

```{r, message=FALSE, warning=FALSE}
library(dplyr)
koty_ptaki %>%
  mutate(predkosc.mph = round(predkosc / 0.621371),
         dlugosci.na.sek = round(predkosc / 3.6 / dlugosc,1))
```

---

# Nadpisywanie zmiennych

Funkcję `mutate()` można też wykorzystać do zmiany wartości w zmiennej, już obecnej w zbiorze danych. 

W tym celu wystarczy, że nową wartość przypiszemy do nazwy istniejącej kolumny.

W przykładzie poniżej przeliczamy długość na cale i zaokrąglamy wynik do całkowitych liczb.

```{r, message=FALSE, warning=FALSE}
library(dplyr)
koty_ptaki %>%
  mutate(dlugosc = round(dlugosc * 100 / 2.54))
```

---

# Auta

Operacje tworzenia nowych zmiennych przećwiczymy też na znacznie większym i złożonym zbiorze danych. Mianowicie na zbiorze danych o cenach ofertowych używanych samochodów.

Zbiór danych `auta2012` jest dostępny po wczytaniu pakietu `PogromcyDanych`. Poniżej przedstawiamy 6 pierwszych wierszy z tego zbioru danych. Szczegółowy opis tego zbioru znajduje się na stronie https://rawgithub.com/pbiecek/MOOC/master/0_dane/0_dane.html

```{r, message=FALSE}
head(auta2012)
```

---

# Wyliczanie jednej nowej zmiennej

Policzmy najpierw wiek auta. Dane były zbierane w roku 2012, więc wiek auta to różnica pomiędzy rokiem 2012 plus 1, a rokiem produkcji.

```{r, warning=FALSE}
autaZWiekiem <- auta2012 %>%
  mutate(Wiek.auta = 2013 - Rok.produkcji)
```

Następnie wyświetlimy pierwsze 6 wierszy i dwie kolumny (wiek i rok produkcji).

```{r, warning=FALSE}
autaZWiekiem %>% 
  select(Wiek.auta, Rok.produkcji) %>%
  head()
```

---

# Wyliczanie nowych zmiennych

Zauważmy, że część cen jest netto, a część brutto. Przeliczmy wszystkie ceny na brutto dodając 23\% tam gdzie podana jest cena netto.

Wykorzystamy w tym celu funkcję `ifelse()`, która jako wynik zwraca drugi lub trzeci argument w zależności od tego czy pierwszy argument jest prawdziwy czy nie.

```{r, warning=FALSE}
autaZCenaBrutto <- auta2012 %>%
  mutate(Cena.brutto = Cena.w.PLN * ifelse(Brutto.netto == "brutto", 1, 1.23))
```

Wyświetlmy pierwsze sześć wierszy i wybrane trzy kolumny.

```{r, warning=FALSE}
autaZCenaBrutto %>% 
  select(Cena.brutto, Brutto.netto, Cena.w.PLN) %>%
  head()
```


---

# Wyliczanie nowych zmiennych

W jednym wykonaniu funkcji `mutate()` można podać kilka transformacji. 

Na poniższym przykładzie w jednym kroku wykonujemy obie powyżej przedstawione transformacje.

```{r, warning=FALSE}
autaZWiekiemIBrutto <- auta2012 %>%
  mutate(Wiek.auta = 2013 - Rok.produkcji,
         Cena.brutto = Cena.w.PLN * ifelse(Brutto.netto == "brutto", 1, 1.23))
```

Wyświetlmy wybrane kolumny.

```{r, warning=FALSE}
autaZWiekiemIBrutto %>% 
  select(Cena.brutto, Brutto.netto, Cena.w.PLN, Wiek.auta, Rok.produkcji) %>%
  head()
```


# Klimatyzacja i nie tylko

Wykorzystajmy funkcję `mutate()` aby dodać kolumny określające czy dane auto ma klimatyzację, centralny zamek czy autoalarm.

Aby sprawdzić czy w kolumnie `Wyposazenie.dodatkowe` występuje określony element użyjemy funkcji `grepl()`

```{r, warning=FALSE}
autaZWyposazeniem <- auta2012 %>%
  mutate(Autoalarm = grepl(pattern = "autoalarm", Wyposazenie.dodatkowe),
         Centralny.zamek = grepl(pattern = "centralny zamek", Wyposazenie.dodatkowe),
         Klimatyzacja = grepl(pattern = "klimatyzacja", Wyposazenie.dodatkowe))
```

Wyświetlmy wybrane kolumny.

```{r, warning=FALSE}
autaZWyposazeniem %>% 
  select(Autoalarm, Centralny.zamek, Klimatyzacja) %>%
  head()
```

---

# Zadania

* Dla zbioru danych `koty_ptaki` dodajmy nową zmienną. Z fizyki wiemy, że pęd to prędkość razy masa. Policz maksymalne pędy dla każdego gatunku oraz uporządkuj wiersze w kolejności od tych zdolnych do uzyskiwania najwyższego pędu.
* Policz średni przebieg na rok, dzieląc przebieg przez wieka auta.
* Poza koniem mechanicznym inną ciekawą jednostką mocy jest koń parowy (jednostka HP). Jeden koń mechaniczny to 0.9863 konia parowego. Utwórz nową zmienną, która przedstawi moc aut w koniach parowych (btw: Wikipedia zna jeszcze kilka innych ciekawych jednostek mocy).

Przykładowe odpowiedzi znajdują się na stronie http://pogromcydanych.icm.edu.pl/materials/1_przetwarzanie/9_zadania.html

