---
title: "Grupowanie danych i analiz [dplyr / group_by]"
author: "pogRomcy danych"
date: "sezon 1 / odcinek 23 <br><br> Wszelkie prawa zastrzeżone.<br> Wykorzystanie możliwe wyłącznie za zgodą autora.  <br><br><br><br>Naciśnij `A` by zamienić slajdy na ciągły tekst. <br> Naciśnij `T` by wyświetlić spis treści."
output:
  slidy_presentation:
    includes:
      in_header: ../tracking.html
    highlight: default
    css: ../style.css
    font_adjustment: 0
    footer: "pogRomcy danych / przetwarzanie / groupowanie"

---

# O czym jest ten odcinek

W poprzednim odcinku pokazliśmy jak liczyć na zbiorze danych statystyki / agregaty. Użyteczność tej opcji znacząco rośnie gdy liczymy te agregaty w grupach. Dzięki temu możemy później łatwo te grupy porównać. Do określania grup wykorzystamy funkcję `group_by()` z pakietu `dplyr`.

W tym odcinku nauczymy się

- jak określać jedną lub więcej zmiennych grupujących?
- jak liczyć agregaty w grupach?

Do ilustracji tych zagadnień wykorzystamy dwa zbiory danych. Pierwszy, mały zbiór danych, to `koty_ptaki` a drugi, 
znacznie większy, to `auta2012`, oba dostępne w pakiecie `SmarterPoland`.

---

# Ptaki vs. koty

Rozpocznijmy od przykładu dla danych o kotach i ptakach. Jest on na tyle mały, że wynik operacji będzie można przedstawić na ekranie.

Zmienna `druzyna` nadaje się świetnie na zmienną grupującą.

```{r, message=FALSE}
library(SmarterPoland)
koty_ptaki
```

# Ptaki vs. koty

Funkcja `group_by()` jako pierwszy argument przyjmuje zbiór danych a jako kolejne zmienne grupujące (jedną lub więcej). Sama funkcja `group_by()` nie powoduje wyliczenia nowych wartoścu, a jedynie zaznacza, które zmienne mają być użyte do grupowania. Przez co użycie kolejnych funkcji, takich jak `summarise()` będzie miało zmienione działanie. 

Zobaczmy jak wygląda użycie funkcji `group_by()` do porównania maksymalnej wagi, prędkości i żywotności w grupie ptaków i kotów.

Wynikiem jest ramka danych, której kolumny to w pierwszej kolejnosci zmienne grupujące a nastepnie wyniki agregatów w grupach.

```{r, message=FALSE, warning=FALSE}
library(dplyr)

koty_ptaki %>%
  group_by(druzyna) %>%
  summarise(najszybszy = max(predkosc),
            najciezszy = max(waga),
            najzywotniejszy = max(zywotnosc),
            liczba = n())
```

---

# Auta

Aby przedstawić więcej możliwości, które daje operacja grupowania wykorzystamy  zbiór danych `auta2012`.

Poniżej przedstawiamy 6 pierwszych wierszy i wybrane kolumny z tego zbioru danych. Szczegółowy opis tego zbioru znajduje się na stronie https://rawgithub.com/pbiecek/MOOC/master/0_dane/0_dane.html

```{r, message=FALSE}
auta2012 %>%
  select(Cena.w.PLN, Marka, Przebieg.w.km, Rodzaj.paliwa, Rok.produkcji) %>%
  head()
```



---

# Grupowanie

Jedną z bardziej użytecznych funkcji jest możliwość liczenia agregatów w grupach. 
Aby określić jedną lub kilka zmiennych grupujących można wykorzystać funkcję `group_by()`.

W poniższym przykładzie liczymy agregaty osobno dla każdej grupy określonej przez `Rodzaj.paliwa`.

```{r, warning=FALSE}
auta2012 %>%
  group_by(Rodzaj.paliwa) %>%
  summarise(medianaCeny = median(Cena.w.PLN, na.rm=TRUE),
            medianaPrzebieg = median(Przebieg.w.km, na.rm=TRUE),
            liczba = n())
```

---

# Grupowanie

Na agregatach możemy pracować tak jak na zwykłych ramkach danych. Możemy przekazać je dalej do funkcji które sortują, wybierają lub zmieniają zmienne.

W poniższym przykładzie sortujemy agregaty po średniej cenie.

```{r, warning=FALSE}
auta2012 %>%
  group_by(Rodzaj.paliwa) %>%
  summarise(medianaCeny = median(Cena.w.PLN, na.rm=TRUE),
            medianaPrzebieg = median(Przebieg.w.km, na.rm=TRUE),
            liczba = n()) %>%
  arrange(medianaCeny)
```

---

# Grupowanie

Grupować można po kilku zmiennych, w tym przypadku agregaty liczone są w każdym podzbiorze zmiennych.

Prześledźmy teraz większy przykład przetwarzania skłądającego się z kilku kroków.
Będziemy chcieli zobaczyć średnie ceny i przebiegi różnych pięcioletnich modeli Volkswagena w zależności od rodzaju paliwa.

Zaczniemy od wybrania tylko pięcioletnich Volkswagenów.

```{r, warning=FALSE}
tmp <- auta2012 %>%
  filter(Rok.produkcji == 2007, Marka == "Volkswagen")
```

---

# Grupowanie

Następnie do potoku dodamy informację, że chcemy grupować po modelach i po rodzajach paliwa. 
Dla każdej grupy chcemy wyznaczyć średnią cenę, średni przebieg i liczbę samochodów w takiej grupie.

```{r, warning=FALSE}
auta2012 %>%
  filter(Rok.produkcji == 2007, Marka == "Volkswagen") %>%
  group_by(Model, Rodzaj.paliwa) %>%
  summarise(sredniaCena = mean(Cena.w.PLN, na.rm=TRUE),
            sredniPrzebieg = mean(Przebieg.w.km, na.rm=TRUE),
            liczba = n())
```

---

# Grupowanie

Kolejność wierszy jest przypadkowa co utrudnia jakiekolwiek porównania.
Posortujmy więc te wyniki po zmiennej Model i zmiennej sredniaCena, którą przed chwilą wyznaczyliśmy.

Dzięki temu auta będą posortowane po modelu a w ramach tego samego modelu po średniej cenie.

```{r, warning=FALSE}
auta2012 %>%
  filter(Rok.produkcji == 2007, Marka == "Volkswagen") %>%
  group_by(Model, Rodzaj.paliwa) %>%
  summarise(sredniaCena = mean(Cena.w.PLN, na.rm=TRUE),
            sredniPrzebieg = mean(Przebieg.w.km, na.rm=TRUE),
            liczba = n()) %>%
  arrange(Model, sredniaCena) 
```

---

# Grupowanie

Niektóre średnie są dosyć przypadkowe, ponieważ w grupie było tylko jedno / dwa auta. 
Usuńmy grupy, w których było mniej niż 10 samochodów, dzięki temu te średnie będą bardziej wiarygodne.

```{r, warning=FALSE}
auta2012 %>%
  filter(Rok.produkcji == 2007, Marka == "Volkswagen") %>%
  group_by(Model, Rodzaj.paliwa) %>%
  summarise(sredniaCena = mean(Cena.w.PLN, na.rm=TRUE),
            sredniPrzebieg = mean(Przebieg.w.km, na.rm=TRUE),
            liczba = n()) %>%
  arrange(Model, sredniaCena) %>%
  filter(liczba > 10)
```

---

# Zadania
* Wybierz pięcioletnie Golfy i sprawdź czy średnia cena zależy od kraju aktualnej rejestracji. W tym celu pogrupuj po zmiennej Kraj.aktualnej.rejestracji i w każdej grupie policz średnią.
* Wybierz tylko Peugeoty 206 i policz średnią cenę w zależności od roku produkcji. Posortuj te grupy po roku produkcji.


# Co dalej

Sciagawka z zabawy danymi w dplyr

http://www.rstudio.com/wp-content/uploads/2015/01/data-wrangling-cheatsheet1.pdf

wiecej sciagawek

http://www.rstudio.com/resources/cheatsheets/



