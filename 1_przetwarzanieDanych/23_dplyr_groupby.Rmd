---
title: "Grupowanie danych i analiz [dplyr / group_by]"
author: "pogRomcy danych"
date: "sezon 1 / odcinek 23 <br><br> Wszelkie prawa zastrzeżone.<br> Wykorzystanie możliwe wyłącznie za zgodą autora.  <br><br><br><br>Naciśnij `A` by zamienić slajdy na ciągły tekst. <br> Naciśnij `T` by wyświetlić spis treści."
output:
  slidy_presentation:
    includes:
      in_header: ../tracking.html
    highlight: default
    css: ../style.css
    font_adjustment: 0
    footer: "pogRomcy danych / przetwarzanie / groupowanie"

---

# O czym jest ten odcinek

W poprzednim odcinku pokazliśmy jak liczyć na zbiorze danych statystyki / agregaty. Użyteczność tej opcji znacząco rośnie gdy liczymy te agregaty w grupach. Dzięki temu możemy później łatwo te grupy porównać. Do określania grup wykorzystamy funkcję `group_by()` z pakietu `dplyr`.

W tym odcinku nauczymy się

- jak określać jedną lub więcej zmiennych grupujących?
- jak liczyć agregaty w grupach?

Do ilustracji tych zagadnień wykorzystamy dwa zbiory danych. Pierwszy, mały zbiór danych, to `koty_ptaki` a drugi, 
znacznie większy, to `auta2012`, oba dostępne w pakiecie `SmarterPoland`.

---

# Ptaki vs. koty

Rozpocznijmy od przykładu dla danych o kotach i ptakach. Jest on na tyle mały, że wynik operacji będzie można przedstawić na ekranie.

Zmienna `druzyna` nadaje się świetnie na zmienną grupującą.

```{r, message=FALSE}
library(SmarterPoland)
koty_ptaki
```

# Ptaki vs. koty

Funkcja `group_by()` jako pierwszy argument przyjmuje zbiór danych a jako kolejne zmienne grupujące (jedną lub więcej). Sama funkcja `group_by()` nie powoduje wyliczenia nowych wartoścu, a jedynie zaznacza, które zmienne mają być użyte do grupowania. Przez co użycie kolejnych funkcji, takich jak `summarise()` będzie miało zmienione działanie. 

Zobaczmy jak wygląda użycie funkcji `group_by()` do porównania maksymalnej wagi, prędkości i żywotności w grupie ptaków i kotów.

Wynikiem jest ramka danych, której kolumny to w pierwszej kolejnosci zmienne grupujące a nastepnie wyniki agregatów w grupach.

```{r, message=FALSE, warning=FALSE}
library(dplyr)

koty_ptaki %>%
  group_by(druzyna) %>%
  summarise(najszybszy = max(predkosc),
            najciezszy = max(waga),
            najzywotniejszy = max(zywotnosc),
            liczba = n())
```

---

# Auta

Aby przedstawić więcej możliwości, które daje operacja grupowania wykorzystamy  zbiór danych `auta2012`.

Poniżej przedstawiamy 6 pierwszych wierszy i wybrane kolumny z tego zbioru danych. Szczegółowy opis tego zbioru znajduje się na stronie https://rawgithub.com/pbiecek/MOOC/master/0_dane/0_dane.html

```{r, message=FALSE}
auta2012 %>%
  select(Cena.w.PLN, Marka, Przebieg.w.km, Rodzaj.paliwa, Rok.produkcji) %>%
  head()
```

---

# Grupowanie

Przykłady dla danych o cenach ofertowych aut rozpoczniemy od porównania cen i przebiegów samochodów napędznych różnymi paliwami.

Aby sensownie porównywać różne rodzaje paliwa ograniczymy się do jednej marki samochodów i jednego rocznika. Na poniższym przykładzie wybieramy tylko 5-letnie Volkswageny a następnie dla aut napędzanych benzyną olejem czy gazem liczymy medianę ceny, przebiegu i liczbę aut w tej grupie.

```{r, warning=FALSE}
auta2012 %>%
  filter(Marka == "Volkswagen", Rok.produkcji == 2007) %>%
  group_by(Rodzaj.paliwa) %>%
  summarise(medianaCeny = median(Cena.w.PLN, na.rm=TRUE),
            medianaPrzebieg = median(Przebieg.w.km, na.rm=TRUE),
            liczba = n())
```

Najliczniejszą grupą aut są samochody napędzane olejem napędowym, mają one przeszło dwukrotnie większy przebieg niż napędzane benzyną (patrząc na mediany) a mimo to sa droższe o około 15\%.

---

# Sortowanie

Na agregatach możemy pracować tak jak na zwykłych ramkach danych. Możemy przekazać je dalej do funkcji które sortują, wybierają lub zmieniają zmienne.

W poniższym przykładzie sortujemy agregaty po liczbie obserwacji.

```{r, warning=FALSE}
auta2012 %>%
  filter(Marka == "Volkswagen", Rok.produkcji == 2007) %>%
  group_by(Rodzaj.paliwa) %>%
  summarise(medianaCeny = median(Cena.w.PLN, na.rm=TRUE),
            medianaPrzebieg = median(Przebieg.w.km, na.rm=TRUE),
            liczba = n()) %>%
  arrange(liczba)
```

---

# Grupowanie po dwóch zmiennych

Grupować można po kilku zmiennych, w tym przypadku agregaty liczone są w każdym podzbiorze zmiennych.

Zobaczmy jak będą wyglądały przebiegi i ceny gdy auta podzielimy dodatkowo ma modele. W grupie pięcioletnich Volkswagenów znaleźć można 19 różnych modeli.

Poniższa lista instrukcji jest praktycznie identyczna z poprzednią, różnica polega na tym, że grupujemy po dwóch zmiennych, Modelu i Rodzaju paliwa.

```{r, warning=FALSE}
auta2012 %>%
  filter(Rok.produkcji == 2007, Marka == "Volkswagen") %>%
  group_by(Model, Rodzaj.paliwa) %>%
  summarise(medianaCeny = median(Cena.w.PLN, na.rm=TRUE),
            medianaPrzebieg = median(Przebieg.w.km, na.rm=TRUE),
            liczba = n()) 

```

---

# Grupowanie i filtrowanie

W wyniku z poprzedniego wiele grup miało małą liczebność, przez co wyniki dla nich były dosyć przypadkowe a to utrudnia porównywania.

Dodanie funkcji `filter()` na koniec umożliwia pozostawienei tylko tych grup, w których liczebmość przekracza 10 obserwacji.

Warto zwrócić uwagę, że w poniższym przykładzie funkcja `filter()` występuje dwukrotnie, w pierwszym przypadku filtruje wiersze w oryginalnym zbiorze danych a w drugim filtruje grupy o zbyt małej liczebności.

```{r, warning=FALSE}
auta2012 %>%
  filter(Rok.produkcji == 2007, Marka == "Volkswagen") %>%
  group_by(Model, Rodzaj.paliwa) %>%
  summarise(medianaCeny = median(Cena.w.PLN, na.rm=TRUE),
            medianaPrzebieg = median(Przebieg.w.km, na.rm=TRUE),
            liczba = n()) %>%
  filter(liczba > 10) 
```

---

# Zadania

* Wybierz pięcioletnie Golfy i sprawdź czy średnia cena zależy od kraju aktualnej rejestracji. W tym celu pogrupuj po zmiennej Kraj.aktualnej.rejestracji i w każdej grupie policz średnią.
* Wybierz tylko Peugeoty 206 i policz średnią cenę w zależności od roku produkcji. Posortuj te grupy po roku produkcji.

Przykładowe odpowiedzi znajdują się na stronie https://rawgit.com/pbiecek/MOOC/master/0_dane/9_zadania.html

# Co dalej

Pakiet `dplyr` zupełnie zmienił sposób przetwarzania danych w R. Przetwarzanie stało się prostsze do opisania, 80\% niezbędnej pracy można wykonać łatwiej i szybciej.

Świetnym uzupełnieniem do wyników z odcinków o tym pakiecie będzie graficzna dwustronicowa ściągawka, prezentująca możliwości tego pakietu. Ta ściągawka dostępna jest na stronie http://www.rstudio.com/wp-content/uploads/2015/01/data-wrangling-cheatsheet1.pdf

Wiecej takich skrótowych ściagawek jest dostępnych na stronie programy rstudio http://www.rstudio.com/resources/cheatsheets/

Krótka prezentacja najważneijszych funkcji tego pakietu na przykłądzie danych o lotach znaleźć można na stronie warsztatów twórcy dplyr'a http://cran.rstudio.com/web/packages/dplyr/vignettes/introduction.html.




