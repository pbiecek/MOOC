---
title: "Sortowanie danych [dplyr / sort]"
author: "pogRomcy danych"
date: "sezon 1 / odcinek 6 <br><br><br><br>Naciśnij `A` by zamienić slajdy na ciągły tekst. <br> Naciśnij `T` by wyświetlić spis treści."
output:
  slidy_presentation:
    includes:
      in_header: ../tracking.html
    highlight: default
    css: ../style.css
    font_adjustment: 0
    footer: "pogRomcy danych / wizualizacja / zaawansowane"

---

# O czym jest ten odcinek

W tym odcinku nauczymy się

- Jak ze zbioru danych wybierać tylko interesujące nas wiersze

Do ilustracji wykorzystamy dwa zbiory danych. Pierwszy, mały zbiór danych to `koty_ptaki` a drugi, znacznie większy to `auta2012`.

---

## Ptaki vs. koty

Liczenie agregatów jest bardzo wygodne, jeżeli możemy to zrobić w grupach.

Ułatwia to porównywanie grup.
Zobaczmy jak wygląda porównanie wagi, prędkosći i żywotności ptaków i kotów.

```{r, message=FALSE, warning=FALSE}
library(SmarterPoland)
koty_ptaki %>%
  group_by(druzyna) %>%
  summarise(najszybszy = max(predkosc),
            najciezszy = max(waga),
            najzywotniejszy = max(zywotnosc),
            liczba = n())
```

---

# Grupowanie

Jedną z bardziej użytecznych funkcji jest możliwość liczenia agregatów w grupach. 
Aby określić jedną lub kilka zmiennych grupujących można wykorzystać funkcję `group_by()`.

W poniższym przykładzie liczymy agregaty osobno dla każdej grupy określonej przez `Rodzaj.paliwa`.

```{r, warning=FALSE}
auta2012 %>%
  group_by(Rodzaj.paliwa) %>%
  summarise(medianaCeny = median(Cena.w.PLN, na.rm=TRUE),
            medianaPrzebieg = median(Przebieg.w.km, na.rm=TRUE),
            liczba = n())
```

---

# Grupowanie

Na agregatach możemy pracować tak jak na zwykłych ramkach danych. Możemy przekazać je dalej do funkcji które sortują, wybierają lub zmieniają zmienne.

W poniższym przykładzie sortujemy agregaty po średniej cenie.

```{r, warning=FALSE}
auta2012 %>%
  group_by(Rodzaj.paliwa) %>%
  summarise(medianaCeny = median(Cena.w.PLN, na.rm=TRUE),
            medianaPrzebieg = median(Przebieg.w.km, na.rm=TRUE),
            liczba = n()) %>%
  arrange(medianaCeny)
```

---

# Grupowanie

Grupować można po kilku zmiennych, w tym przypadku agregaty liczone są w każdym podzbiorze zmiennych.

Prześledźmy teraz większy przykład przetwarzania skłądającego się z kilku kroków.
Będziemy chcieli zobaczyć średnie ceny i przebiegi różnych pięcioletnich modeli Volkswagena w zależności od rodzaju paliwa.

Zaczniemy od wybrania tylko pięcioletnich Volkswagenów.

```{r, warning=FALSE}
tmp <- auta2012 %>%
  filter(Rok.produkcji == 2007, Marka == "Volkswagen")
```

---

# Grupowanie

Następnie do potoku dodamy informację, że chcemy grupować po modelach i po rodzajach paliwa. 
Dla każdej grupy chcemy wyznaczyć średnią cenę, średni przebieg i liczbę samochodów w takiej grupie.

```{r, warning=FALSE}
auta2012 %>%
  filter(Rok.produkcji == 2007, Marka == "Volkswagen") %>%
  group_by(Model, Rodzaj.paliwa) %>%
  summarise(sredniaCena = mean(Cena.w.PLN, na.rm=TRUE),
            sredniPrzebieg = mean(Przebieg.w.km, na.rm=TRUE),
            liczba = n())
```

---

# Grupowanie

Kolejność wierszy jest przypadkowa co utrudnia jakiekolwiek porównania.
Posortujmy więc te wyniki po zmiennej Model i zmiennej sredniaCena, którą przed chwilą wyznaczyliśmy.

Dzięki temu auta będą posortowane po modelu a w ramach tego samego modelu po średniej cenie.

```{r, warning=FALSE}
auta2012 %>%
  filter(Rok.produkcji == 2007, Marka == "Volkswagen") %>%
  group_by(Model, Rodzaj.paliwa) %>%
  summarise(sredniaCena = mean(Cena.w.PLN, na.rm=TRUE),
            sredniPrzebieg = mean(Przebieg.w.km, na.rm=TRUE),
            liczba = n()) %>%
  arrange(Model, sredniaCena) 
```

---

# Grupowanie

Niektóre średnie są dosyć przypadkowe, ponieważ w grupie było tylko jedno / dwa auta. 
Usuńmy grupy, w których było mniej niż 10 samochodów, dzięki temu te średnie będą bardziej wiarygodne.

```{r, warning=FALSE}
auta2012 %>%
  filter(Rok.produkcji == 2007, Marka == "Volkswagen") %>%
  group_by(Model, Rodzaj.paliwa) %>%
  summarise(sredniaCena = mean(Cena.w.PLN, na.rm=TRUE),
            sredniPrzebieg = mean(Przebieg.w.km, na.rm=TRUE),
            liczba = n()) %>%
  arrange(Model, sredniaCena) %>%
  filter(liczba > 10)
```

---

# Zadania
* Wybierz pięcioletnie Golfy i sprawdź czy średnia cena zależy od kraju aktualnej rejestracji. W tym celu pogrupuj po zmiennej Kraj.aktualnej.rejestracji i w każdej grupie policz średnią.
* Wybierz tylko Peugeoty 206 i policz średnią cenę w zależności od roku produkcji. Posortuj te grupy po roku produkcji.



