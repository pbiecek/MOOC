---
title: "Package ggplot2  - working on details"
author: "Data CruncheRs"
date: "season 2 / episode 4 <br><br> All rights reserved.<br> The use shall be subject
to prior consent of the author<br><br><br><br> Press `A` to see the plain text instead
of the slides <br> Press `T` to display the table of contents"
output:
  slidy_presentation:
    includes:
      in_header: ../tracking.html
    highlight: default
    css: ../style.css
    font_adjustment: 0
    footer: "Data CruncheRs / wizualizacja / dopieszczanie"

---

# What is this episode about?

Functions from `ggplot2` look good at default settings.

However, while creating more complex graphics, there is frequently a need for changing some details.

In this section you will learn:

- How to add annotations to a chart?
- How to control mapping for `shape` feature? 
- How to control mapping for `colour` feature? 
- How to modify the chart key?
- How to change graphic chart themes?

---

# Annotations, axes text and titles

Good chart title and axes descriptions are the elements that significantly facilitate correct reading of the chart, though their contribution is often belittled.

Why are they so important? Since without title and description of the axis, the reader may not know what a topic of a chart is. If the reader does not know what is presented on the chart,  then the chart is useless.

Why is it belittled? Since the chart creator usually knows what is presented on the chart and not necessarily feels like and has time to take care for the chart reader.

We will create very good charts, which means they will be clear and described.
Let's have a closer look at the chart from the first episode and consider what elements should be described more accurately. 
Spend few minutes trying to find at least five elements that need more accurate description.

```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE}
library(PogromcyDanych)
ggplot(koty_ptaki, aes(x=waga, y=predkosc, shape=druzyna)) +
  geom_point(size=5) 
```

---

# Annotations, axes text and titles

Was that a difficult task?

It could be, because we have seen this chart already many times and we know, what it presents. However, if you have managed to find elements worth additional description, that's great! You started to adopt critical approach towards charts.

Here is what I found:

- Axes are missing units. There is information on "weight", but what are the units? Kilograms, pounds? 
- A similar problem concerns speed. Are these kilometers per hour or miles per hour?
- The `druzyna` legend description is kind of funny, but says little about the content. What team? The text cannot be understood by people not knowing about species races
- But what is it all about with this chart? Where is the title? What does it mean?
- What species represent the most extreme points? What kind of cat and what kind of bird is the fastest?

Let's see how to prepare a chart with relevant annotations.

---

# Annotations, axes text and titles

In the example below four lines are added to a chart, each changing specified chart element.

1. The `ggtitle()` function adds chart title and function `theme()` changes chart title size. Larger text will be clearer.

2. The functions `xlab()` and `ylab()` are used for adding descriptions to axes. We should add units, it would be better if the descriptions started with large letter and included unusual characters, for example Polish characters.

3. To change legend title, argument name should be specified for the function describing mapping for size (`scale_shape_discrete()`), and function `theme()` should be used to move the key closer to the upper part of a chart.

4. Function `geom_text()` adds labels for selected points at the chart. We marked the quickest cat and bird.

# Annotations, axes text and titles

And here is the chart after adding these modifications.

```{r, fig.height=5, fig.width=5, message=FALSE, warning=FALSE, eval=FALSE}
# Before [left]
ggplot(koty_ptaki, aes(x=waga, y=predkosc, shape=druzyna)) +
  geom_point(size=5)
# After [right]
ggplot(koty_ptaki, aes(x=waga, y=predkosc, shape=druzyna)) +
  geom_point(size=5) + 
  # Bigger and legible title
  ggtitle("Lighter ones run faster!") + theme(plot.title = element_text(size=20)) + 
  # axis labels
  xlab("Weight [kg]") + ylab("Speed [km/h]") + 
  # Legend title
  scale_shape_discrete(name="Cats or birds?") + theme(legend.position="top") + 
  # additional text
  geom_text(data=koty_ptaki[c(6,8),], aes(label=gatunek), hjust=-0.2)
```

```{r, fig.height=5, fig.width=5, message=FALSE, warning=FALSE, echo=FALSE}
# Before
ggplot(koty_ptaki, aes(x=waga, y=predkosc, shape=druzyna)) +
  geom_point(size=5)
# After
ggplot(koty_ptaki, aes(x=waga, y=predkosc, shape=druzyna)) +
  geom_point(size=5) + 
  # Bigger and legible title
  ggtitle("Lighter ones run faster!") + theme(plot.title = element_text(size=20)) + 
  # axis labels
  xlab("Weight [kg]") + ylab("Speed [km/h]") + 
  # Legend title
  scale_shape_discrete(name="Cats or birds?") + theme(legend.position="top") + 
  # additional text
  geom_text(data=koty_ptaki[c(6,8),], aes(label=gatunek), hjust=-0.2)
```

---

# Greater control over mapping

Mapping is one of the largest advantage of `ggplot2` package. You can just choose variables to present on the chart and chart features to describe these variables with and R will automatically select the mode of presentation, taking into account the variable type and checking whether it has few values or many of them, whether it is a quantitative variable or qualitative one etc. 

Sometimes, however, we would like to change the manner of variable representation, that is change the default mapping.

We can do this using function of names compliant with template `scale_xxx_yyy()` where `xxx` describes feature we map (`shape`/`size`/`color`/`x`/`y`), and `yyy` describes the mode of representation.

For instance, `scale_shape_manual()` function enables mapping variables on points' shapes. Argument `values=` enables indicating what shapes represent different groups while an argument `breaks= `enables indicating mapped variable's values in the legend.

In a similar manner `scale_color_manual()` enables manual indication of colours that code particular values.

While mapping `x` and `y` features (coordinates) it is interesting to use `expand=` parameter, which enables identifying how large are the margins of the axis.

# Greater control over mapping

And here is the exemplary application of all of these mapping modifications.

```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE, eval=FALSE}
# Before
ggplot(koty_ptaki, aes(x=waga, y=predkosc, shape=druzyna, color=druzyna)) +geom_point(size=5) 
# After
ggplot(koty_ptaki, aes(x=waga, y=predkosc, shape=druzyna, color=druzyna)) +
  geom_point(size=5) +
  # we define different shapes for groups and labels in the legend 
  scale_shape_manual(values=c("K", "P"), breaks=c("Kot", "Ptak")) +
  # we define the colours
  scale_color_manual(values=c("blue3", "red3"), breaks=c("Kot", "Ptak")) +
  # for OY axis we remove the margins outside the 0 - 200 range
  scale_y_continuous(limits=c(0,200), expand=c(0,0)) 
```

```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE, echo=FALSE}
# Before
ggplot(koty_ptaki, aes(x=waga, y=predkosc, shape=druzyna, color=druzyna)) +geom_point(size=5) 
# After
ggplot(koty_ptaki, aes(x=waga, y=predkosc, shape=druzyna, color=druzyna)) +
  geom_point(size=5) +
  # we define different shapes for groups and labels in the legend 
  scale_shape_manual(values=c("K", "P"), breaks=c("Kot", "Ptak")) +
  # we define the colours
  scale_color_manual(values=c("blue3", "red3"), breaks=c("Kot", "Ptak")) +
  # for OY axis we remove the margins outside the 0 - 200 range
  scale_y_continuous(limits=c(0,200), expand=c(0,0)) 
```

# Greater control over mapping - continuous variables

Let's see how controlling mapping of continuous variables looks like. As an example we will use `zywotnosc` variable. We will map it on colour and size of a point.

If we do not like default selection of colours (for continuous variables it is from black to blue), using function `scale_color_gradient()` we can define values `low=` and `high=`, obtaining custom colour scale.

For the size of a point we determine what interval life span should be presented `limits=` and what point size this interval should be presented `range=`.

More information about possible additional parameters can be found in functions help files: `?scale_color_gradient` and `?scale_size_continuous`

# Greater control over mapping - continuous variables

And here is the exemplary application of all of these mapping modifications.

```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE, eval=FALSE}
# Before [left]
ggplot(koty_ptaki, aes(x=waga, y=predkosc, size=zywotnosc, color=zywotnosc)) +
  geom_point() 
# After [right]
ggplot(koty_ptaki, aes(x=waga, y=predkosc, size=zywotnosc, color=zywotnosc)) +
  geom_point() +
  # changing the range of point size
  scale_size_continuous(range=c(5,15), limits=c(10,50)) +
  # changing the colour scale (for continuous we define two extreme values)
  scale_color_gradient(low="gold", high="red4")
```

```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE, echo=FALSE}
# Before
ggplot(koty_ptaki, aes(x=waga, y=predkosc, size=zywotnosc, color=zywotnosc)) +
  geom_point() 
# After
ggplot(koty_ptaki, aes(x=waga, y=predkosc, size=zywotnosc, color=zywotnosc)) +
  geom_point() +
  scale_size_continuous(range=c(5,15), limits=c(10,50)) +
  scale_color_gradient(low="gold", high="red4")
```

---

# Chart legend modification

Package `ggplot2` automatically creates and draws the legend (key). In many cases this default preservation is sufficient and the legend is legible enough. But sometimes we want to put the legend elsewhere, name it differently or colour it.

It all can be done, often it is enough to modify particular theme arguments, using function `theme()`.

In the window below function `theme()` is used to determine background and framing colour of the legend, its size and position. The `scale_shape_manual()` function determines mapping elements, key title and names of legend's items.

# Chart legend modification

Example of changes in the key

```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE, eval=FALSE}
# Before [left]
ggplot(koty_ptaki, aes(x=waga, y=predkosc, shape=druzyna)) +
  geom_point(size=5) 
# After [right]
ggplot(koty_ptaki, aes(x=waga, y=predkosc, shape=druzyna)) +
  geom_point(size=5) +
  # changing the text inside the legend concerning mapping for shape
  scale_shape_manual(values=c("K", "P"), 
                     labels=c("Big Cats", "Angry Birds"), name="What \n animal?") +
  # adding grey background, bigger title and adjusting legend position
  theme(legend.background = element_rect(color="red", fill="grey95"), 
        legend.title = element_text(size=15), 
        legend.position=c(0.8,0.8)) 
# 0.8, 0.8 are the coordinates for the legend to appear
```
```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE, echo=FALSE}
# Before [left]
ggplot(koty_ptaki, aes(x=waga, y=predkosc, shape=druzyna)) +
  geom_point(size=5) 
# After [right]
ggplot(koty_ptaki, aes(x=waga, y=predkosc, shape=druzyna)) +
  geom_point(size=5) +
  scale_shape_manual(values=c("K", "P"), labels=c("Big Cats", "Angry Birds"), name="What \n animal?") +
  theme(legend.background = element_rect(color="red", fill="grey95"), 
        legend.title = element_text(size=15), 
        legend.position=c(0.8,0.8)) 
```

---

# Many charts in one window

Very often we want to put several charts side by side. Below we will show you how to do it.

In R everything is an object. It means that also `ggplot()` function results is an object that can be assigned to a variable and later repeatedly used.

We will illustrate it with example. This instruction assigns scatter plot definitions to `pl_waga` variable. No chart will be drawn unless we display content of `pl_waga` variable.

```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE}
pl_waga <- ggplot(koty_ptaki, aes(x=waga, y=predkosc)) +
                geom_point(size=5)
```

To display chart `pl_waga` chart, `print()` function can be used.

```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE}
print(pl_waga)
```

# Many charts in one window

One of arguments of this `print()` function for charts, is argument `vp=` enabling specifying where chart is to be drawn.

By default the whole area of coordinates [0.1] x [0.1] is outlined, but we can ask for the chart to be drawn at a smaller area.

This is very convenient, if we want to place several charts side by side.

The example below presents the same chart three times every time elsewhere and with a different title. The `x` and `y` arguments define the centre of an outlined area and `width` and `height` define the width and height of the outlined rectangle respectively.

```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE}
library(grid)
# we draw a chart in a square od height and width 0.5 in a left top corner
print(pl_waga + ggtitle("Wykres 1"), 
      vp=viewport(x=0.25, y = 0.75, width=0.5, height=0.5))
# we draw a chart in a square od height and width 0.5 in a left bottom corner 
print(pl_waga + ggtitle("Wykres 2"), 
      vp=viewport(x=0.25, y = 0.25, width=0.5, height=0.5))
# we draw a chart in a square od height and width 0.5 on a right side
print(pl_waga + ggtitle("Wykres 3"), 
      vp=viewport(x=0.75, y = 0.5, width=0.5, height=1))
```

# Many charts in one window

Argument `vp=` enables drawing in lower part of a chart.

However if we want draw charts on a regular grid, it is convenient to first specify the grid with `grid.layout()` function
and then fill it with charts specifying grid position for outlining.

```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE}
# grid of height and width of two rows and columns
pushViewport(viewport(layout = grid.layout(2,2)))
# inserting charts into specified cells
# drawing in the cell of coordinates 1x1
print(pl_waga + ggtitle("Chart 1"),
      vp = viewport(layout.pos.row=1, layout.pos.col=1))
# drawing in the cell of coordinates 2x1
print(pl_waga + ggtitle("Chart 2"),
      vp = viewport(layout.pos.row=2, layout.pos.col=1))
# drawing in the cell of coordinates 1:2x2
print(pl_waga + ggtitle("Chart 3"),
      vp = viewport(layout.pos.row=1:2, layout.pos.col=2))
```

---

# Graphic themes

Grey chart background might have become irritating by now.

It turns out that appearance of the whole chart may be changed simply by using the so-called themes, namely graphic settings sets. Many such themes are available in `ggthemes` package. Adding theme function is enough to change chart appearance. Names of these functions start with `theme_`.

Below examples of four graphic themes are presented, it is worth seeing how the rest looks like.

```{r, fig.height=4, fig.width=5, eval=FALSE}
# preparing a point chart
pl <- ggplot(koty_ptaki, aes(x=waga, y=predkosc, shape=druzyna)) +
  geom_point(size=5) 
# package with additional themes
# if not installed, use install.packages("ggthemes")
library(ggthemes)
# white background, grey lines
pl + theme_bw()
# Excel look alike chart
pl + theme_excel()
# chart with some elements removed
pl + theme_minimal()
# Economist newspaper look alike chart
pl + theme_economist()
```
```{r, fig.height=4, fig.width=5, echo=FALSE, message=FALSE, warning=FALSE}
library(ggthemes)
pl <- ggplot(koty_ptaki, aes(x=waga, y=predkosc, shape=druzyna)) +
  geom_point(size=5) 
pl + theme_bw() + ggtitle("theme_bw")
pl + theme_excel() + ggtitle("theme_excel")
pl + theme_minimal() + ggtitle("theme_minimal")
pl + theme_economist() + ggtitle("theme_economist")
```

---

# Additional information

The flexibility of `ggplot2` pachage is tremendous. You can do very original things.

For instance, it is possible to create of charts in style of popular comics from XKCD series http://xkcd.com/.

```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE}
# you need a xkcd package to create comic style charts
library(xkcd)
ggplot(koty_ptaki, aes(x=waga, y=predkosc)) +
  geom_point(size=5) + xkcdaxis(c(0,300),c(50,200))

```

Based on theme `theme_bw()`  inversion of default charts from `ggplot2` can be achieved. Maybe these are not options for everyday use, but they show that while exploring ggplot2 package we will not come across a sign saying "It cannot be done".

```{r, fig.height=4, fig.width=5,  message=FALSE, warning=FALSE}
pl + theme_bw() + theme(plot.background = element_rect(fill = "gray80"))
```


---

# What's next

- Information of different skins for ggplot2 packagecan be found on `easyGgplot2`. http://www.sthda.com/english/wiki/easyggplot2

- When pasting charts into Excel or Word we may want charts that are editable. There is a way to achieve the desired result: http://www.sthda.com/english/wiki/create-an-editable-graph-from-r-software

- Many useful instructions can also be found in an e-book *"CookBook for R"*  http://www.cookbook-r.com/Graphs/ and in *"Effective tables and graphs in official statistics"* document
https://gss.civilservice.gov.uk/wp-content/uploads/2014/12/Effective-graphs-and-tables-in-official-statistics-version-1.pdf

- On the Internet you can find many pages concerning creating good charts. Selected interesting lists of such tips are:
    * *Do’s and Don’ts* http://stat545-ubc.github.io/block015_graph-dos-donts.html
    * *Ten Simple Rules for Better Figures*  http://www.ploscompbiol.org/article/info:doi/10.1371/journal.pcbi.1003833
    * *Twenty rules for good graphics* http://robjhyndman.com/hyndsight/graphics/

# Exercises, season 2, episode 4

+ Like in the previous section, select `Volkswagen Passat` and then draw how average price changes in relation to production costs using `geom_smooth()` geometry. Then see how this chart looks like if you use `theme_bw()`, `theme_excel()` and `theme_economist()` themes.

+ Change the chart below by changing colours scale from green to red, replacing dots with squares and adding title to a chart (and adding appropriate axis labels).

```{r, eval=FALSE}
ggplot(koty_ptaki, aes(x=waga, y=predkosc, size=zywotnosc, color=zywotnosc)) +
  geom_point() 
```
