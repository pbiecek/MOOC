---
title: "Package ggplot2 - maps"
author: "Data CruncheRs"
date: "season 2 / episode 5 <br><br> All rights reserved.<br> The use shall be subject
to prior consent of the author<br><br><br><br> Press `A` to see the plain text instead
of the slides <br> Press `T` to display the table of contents"
output:
  slidy_presentation:
    includes:
      in_header: ../tracking.html
    highlight: default
    css: ../style.css
    font_adjustment: 0
    footer: "Data CruncheRs / wizualizacja / mapy"

---

# What is this episode about?

One of a very visually attractive methods of data presentation are cartograms, i.e. popular "maps".

In this episode we will learn:

- How to upload maps data?
- How to present on maps information concerning filling colour?
- How to present on maps information using point or bar size?

In this episode we will learn how to operate on `mandatySejmik2014` data set available in the `PogromcyDanych` package.

---

# Data set

In this episode we will work on data set concerning results of local government election of 2014 (elections for sejmik).

The `mandatySejmik2014` data set shows the number of mandates given to politicians of SLD, PIS, PO, and other parties in each of 16 provinces.

In column `ProcentWaznychGlosow` the percentage of valid votes is presented (in relation to persons eligible to vote) and the last two columns present length and latitude of the province center.

```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE}
# if not installed yet, install with
# install.packages("PogromcyDanych")
library(PogromcyDanych)
# first 6 rows
head(mandatySejmik2014)
```

---

# Files with maps / shapes - shape files

To present information on maps in R, you should first upload outlines of areas from maps.

Such data are made available in `.shp` files, called shape files.

Files with shapes of polish provinces that I will use in this episode, come from GADM data base http://www.gadm.org and contain some small errors in coding that we will correct manually.

After downloading data, in folder `dane/POL_adm` we have areas shapes at various levels of specificity. File `POL_adm0.shp` is an outline of the whole country, `POL_adm1.shp` are outlines of provinces and `POL_adm2.shp` are anoutlines of communes.

Using `readShapePoly()` we will upload data of provinces outlines with the `shp1` variable.

```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE}
# we will start with loading some essential packages
library(maptools)
library(rgdal)
library(gpclib)
gpclibPermit()
# loading shapes of voivodships
shp1 <- readShapePoly("../dane/POL_adm/POL_adm1.shp") 
```

Object `shp1` is an object of `SpatialPolygonsDataFrame` class. More information on this file can be found in help file. `?SpatialPolygonsDataFrame`.

For instance, variable `shp1@data` contains data set attached to shapes and this particular file `shp1@data$VARNAME_1`  contains names of provinces.

Owing to error in coding we need to change its name for Łódź Province.

```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE}
#  VARNAME_1 contains the names of voivodships
shp1@data$VARNAME_1 <- as.character(shp1@data$VARNAME_1)
shp1@data$VARNAME_1
# removing problems with coding
shp1@data$VARNAME_1[4] <- "Lodzkie"
```

---

# Drawing map of voivodships

Data read by function `readShapePoly()`  have a specific structure of vectors list that constitute shapes of areas. One province is not always an outline of one area, for instance if we want to include islands in the outline of coastal provinces, the province outline will comprise islands outlines as well.

In order to draw such data with the `ggplot2` package, it should be converted into tabular format. The easiest way to do it is to use `fortify()` option. It changes data format to tabular. Below, a new format for outlines of provinces is saved in a form of `shp1f` variable.

Aby można było takie dane narysować w pakiecie `ggplot2` należy je wpierw przetransportować do formatu tabelarycznego. Najłatwiej to zrobić funkcją `fortify()`. Zmienia ona format danych na tabelaryczny. W poniższym przykładzie nowy format dla obrysów województw jest zapisany w zmiennej `shp1f`. 

The first two columns of this table are geographic coordinates of points on the outline of each province.

```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE}
library(ggplot2)
# fortify changes the format of the file into ggplot2 friendly one
shp1f <- fortify(shp1, region = "VARNAME_1")
head(shp1f, 4)
```

After converting data into tabular format we can draw them, e.g. using `geom_path`. Follow the example below.

```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE}
ggplot() +
  geom_path(data=shp1f, aes(x=long, y=lat, group=id), colour="black", size=0.25)
```

---

# Drawing map of provinces - geom_map()

We will use `geom_path()` geometry for drawing outlines of provinces.

However, to mark numeric values on the map with colour filling, we will use `geom_map()` geometry.

The argument `map=` of this geometry indicates objects presenting provinces (in this case `shp1f`). The argument `data=` indicates numeric data object, namely our data of mandates of sejmiki. In mapping for `geom_map()` geometry `map_id= feature` is indicated in order to present names of provinces and `fill=` to indicate which variable is to be presented with filling colour.

The below example presents drawing a cartogram in which information of percentage of valid votes can be presented with filling colour

```{r, fig.height=4, fig.width=7, message=FALSE, warning=FALSE}
# empty plot
ggplot() +
  # filling shapes
    geom_map(data=mandatySejmik2014, aes(map_id=Wojewodztwo, fill=ProcentWaznychGlosow), 
             map=shp1f) +
  # drawing borders
    geom_path(data=shp1f, aes(x=long, y=lat, group=id), colour="black", size=0.25)
```

---

# Map drawing

The term "projection" is associated with drawing maps, it is a method of mapping three-dimensional globe surface on two-dimensional chart surface.

Maps can be drawn in different projections, there is no perfect projection. Some preserve areas better, other are better in presenting angles or lengths of sections. List of projections with a description of properties can be found at http://en.wikipedia.org/wiki/List_of_map_projections

In R, in package `ggplot2`, we can use most popular projectections. To select one of them, it is enough to add function `coord_map()`.

Below there are two sample charts with different projections. Since in comparison to the area of the globe, the area of Poland is relatively small, differences between maps are rather subtle.

```{r, fig.height=4, fig.width=7, message=FALSE, warning=FALSE, eval=FALSE}
# plot just as in previous episode
mapka <- ggplot() +
    geom_map(data=mandatySejmik2014, aes(map_id=Wojewodztwo, fill=ProcentWaznychGlosow), 
             map=shp1f) +
    geom_path(data=shp1f, aes(x=long, y=lat, group=id), colour="black", size=0.25) 

# transforming map, using mercator projection
# angles between longitude and lattitude are preserved
mapka + coord_map(projection="mercator") + ggtitle("mercator")
# stereographic projection
mapka + coord_map(projection="stereographic") + ggtitle("stereographic")
```
```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE, echo=FALSE}
mapka <- ggplot() +
    geom_map(data=mandatySejmik2014, aes(map_id=Wojewodztwo, fill=ProcentWaznychGlosow), 
             map=shp1f) +
    geom_path(data=shp1f, aes(x=long, y=lat, group=id), colour="black", size=0.25) 

mapka + coord_map(projection="mercator") + ggtitle("mercator")
mapka + coord_map(projection="stereographic") + ggtitle("stereographic")
```

---

# Drawing maps - working on details

We have already drawn several choropleths. But they could be better. How to modify them?

Maps made with `ggplot2` package can be modified like other charts in `ggplot2` package.

In the following example we present several sample changes. Using `theme_bw()`  function, we change default chart motive, using `scale_fill_gradient()` we change the manner of variable representation with filling colour, and with additional `theme()` function arguments we remove all additional chart elements.

```{r, fig.height=4, fig.width=7, message=FALSE, warning=FALSE}
ggplot() +
    geom_map(data=mandatySejmik2014, aes(map_id=Wojewodztwo, fill=ProcentWaznychGlosow), 
             map=shp1f) +
    geom_path(data=shp1f, aes(x=long, y=lat, group=id), colour="white", size=1) +
  # using mercator projection
  coord_map(projection="mercator") +
  # changing theme
  theme_bw() +
  # continuous variable will be presented
  # with colour gradient from grey to black 
  scale_fill_gradient(low = "grey90", high = "black") +
  # additional theme options removes everything unnecessary
  theme(axis.ticks = element_blank(),     panel.border = element_blank(),
        axis.text.x = element_blank(),    axis.text.y = element_blank(),
        panel.grid.minor=element_blank(), panel.grid.major=element_blank(),
        axis.title.x = element_blank(),   axis.title.y = element_blank())
```

---

# Map drawing - mapping value to a point size

Presenting data by means of colour filling is not always a good idea.

Alternative way of information presentation at the map is e.g. item size.

The `geom_point()` geometry can be used for points drawing, indicating as point coordinates centers of provinces and point size will be dependent on `ProcentWaznychGlosow` variable.

To make points more visible we enlarge them by modifying mapping with functions `scale_size_continuous()`.

```{r, fig.height=4, fig.width=7, message=FALSE, warning=FALSE}
ggplot() +
  geom_point(data=mandatySejmik2014, aes(x=long, y=lat, size=ProcentWaznychGlosow)) +
  geom_path(data=shp1f, aes(x=long, y=lat, group=id), colour="black", size=0.25) +
  # mercator projection
  coord_map(projection="mercator") +
  # changing theme
  theme_bw() +
 # continuous variable will be presented
  # with point size ranging from 1 to 20 
  scale_size_continuous(range=c(1,20)) +
  theme(axis.ticks = element_blank(),     panel.border = element_blank(),
        axis.text.x = element_blank(),    axis.text.y = element_blank(),
        panel.grid.minor=element_blank(), panel.grid.major=element_blank(),
        axis.title.x = element_blank(),   axis.title.y = element_blank())
```

---

# Map drawing - mapping variable to length of a bar

Another way of presenting numeric data on maps is by length of bars.

To add information on mandates obtained by `PO` we will use `geom_rect()` geometry.

It should cover `xmin` and `xmax` coordinates denoting beginning and the end of a bar and `ymin` and `ymax` depending on `PO` variable value.

```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE}
ggplot() +
  geom_path(data=shp1f, aes(x=long, y=lat, group=id), colour="grey", size=0.25) +
  geom_rect(data=mandatySejmik2014, aes(xmin=long-0.3, xmax=long-0.1, 
                                        ymin=lat, ymax=lat + PO/15), fill="orange3", color="white") +
  # mercator projection
  coord_map(projection="mercator") +
  # changing theme
  theme_bw() +
  theme(axis.ticks = element_blank(),     panel.border = element_blank(),
        axis.text.x = element_blank(),    axis.text.y = element_blank(),
        panel.grid.minor=element_blank(), panel.grid.major=element_blank(),
        axis.title.x = element_blank(),   axis.title.y = element_blank())
```

---

# Rysowanie mapy - variable as a length of a bar

If you managed to draw results of one party, you can add subsequent layers depicting the results of subsequent parties.

On the chart below we pursue this idea. We add posts presenting the number of mandates obtained by PIS, PSL and SLD, we mark each party with different colour. It makes it easier to notice which party won in which province and what was the winning margin.

```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE}
ggplot() +
  geom_path(data=shp1f, aes(x=long, y=lat, group=id), colour="grey", size=0.25) +
  # layer with bars representing mandate obtained by PO
  geom_rect(data=mandatySejmik2014, aes(xmin=long-0.3, xmax=long-0.1, 
                                        ymin=lat, ymax=lat + PO/15), fill="orange3", color="white") +
  # layer with bars representing mandate obtained by PiS
  geom_rect(data=mandatySejmik2014, aes(xmin=long-0.1, xmax=long+0.1, 
                                        ymin=lat, ymax=lat + PiS/15), fill="blue3", color="white") +
  # layer with bars representing mandate obtained by PSL
  geom_rect(data=mandatySejmik2014, aes(xmin=long+0.1, xmax=long+0.3, 
                                        ymin=lat, ymax=lat + PSL/15), fill="green3", color="white") +
  # layer with bars representing mandate obtained by SLD
  geom_rect(data=mandatySejmik2014, aes(xmin=long+0.5, xmax=long+0.3, 
                                        ymin=lat, ymax=lat + SLD/15), fill="red", color="white") +
  # additional parameters
  coord_map(projection="mercator") +
  theme_bw() +
  scale_size_continuous(range=c(1,20)) +
  theme(axis.ticks = element_blank(),     panel.border = element_blank(),
        axis.text.x = element_blank(),    axis.text.y = element_blank(),
        panel.grid.minor=element_blank(), panel.grid.major=element_blank(),
        axis.title.x = element_blank(),   axis.title.y = element_blank())
```
---

# What's next

- Great presentation of capabilities data presentation on maps is described in the article: *ggmap: Spatial Visualization with ggplot2* http://journal.r-project.org/archive/2013-1/kahle-wickham.pdf

- This blog is a short summary including interesting examples: *Making Maps in R* http://www.kevjohnson.org/making-maps-in-r/

- Many useful instructions can also be found in an e-book *"CookBook for R"* http://www.cookbook-r.com/Graphs/


