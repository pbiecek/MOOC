---
title: "Pakiet ggplot2 - mapy"
author: "pogRomcy danych"
date: "sezon 3 / odcinek 4 <br><br><br><br>Naciśnij `A` by zamienić slajdy na ciągły tekst. <br> Naciśnij `T` by wyświetlić spis treści."
output:
  slidy_presentation:
    includes:
      in_header: ../tracking.html
    highlight: default
    css: ../style.css
    font_adjustment: 0
    footer: "poskRamiacze danych / wizualizacja / mapy"

---

## O czym to będzie

W tym odcinku nauczymy się

- Jak wczytywać dane o mapach
- Jak przedstawiać na mapach informacje za pomocą koloru wypełnienia
- Jak przedstawiać na mapach informacje za pomocą wielkości punktów lub słupków

W tym odcinku będziemy pracować ze zbiorem danych `mandatySejmik2014`.

---

## Zbiór danych

W tym odcinku będziemy pracować na zbiorze danych o wynikach wyborów samorządowych z roku 2014 do sejmików.

Zbiór danych `mandatySejmik2014` dla każdego z 16 województw pokazuje ile mandatów zdobyli kandydaci pod sztandarami SLD, PiS, PO, SLD i innymi. W kolumnie `ProcentWaznychGlosow` przedstawiono procent ważnych oddanych głosów (w stosunku do osób uprawnionych do głosowania) a ostatnie dwie kolumny przedstawiają długość i szerokość geograficzną środka województwa.

```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE}
library(PogromcyDanych)
head(mandatySejmik2014)
```

---

# Pliki z mapami - shape files

Aby przedstawiać informacje na mapach w programie R, należy wpierw wczytać obrysy map. Te obrysy są udostępnione w plikach o rozszerzeniu `.shp`, nazywanych *shape files*. 

Pliki, które wykorzystam tutaj pochodzą z bazy danych GADM http://www.gadm.org i mają pewne niewielkie błędy w kodowaniu, które ręcznie naprawimy. W katalogu `dane/POL_adm` znajdują się kształty obszarów na różnych poziomach szczegółowości. Plik `POL_adm0.shp` to obrys całego kraju, `POL_adm1.shp` to obrysy województw a `POL_adm2.shp` to obrysy gmin. Funkcją `readShapePoly()` wczytamy dane o obrysach województw do zmiennej `shp1`. Zmienna `shp1@data$VARNAME_1` zawiera nazwy województw, musimy w nich poprawić nazwę dla województwa Łódzkiego.

```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE}
library(maptools)
library(rgdal)
library(gpclib)
gpclibPermit()
shp1 <- readShapePoly("../dane/POL_adm/POL_adm1.shp") 

# W zmiennej VARNAME_1 znajdują się nazwy województw
shp1@data$VARNAME_1 <- as.character(shp1@data$VARNAME_1)
shp1@data$VARNAME_1
# poprawiamy kodowanie polskich znaków
shp1@data$VARNAME_1[4] <- "Lodzkie"
```

---

# Rysowanie mapy

Aby dane wczytane przez funkcję `readShapePoly()` można było narysować w pakiecie `ggplot2` należy je najpierw przekonwertować funkcją `fortify()`. Zmienia ona format danych na tabelaryczny, w poniższym przykładzie nowy format dla obrysów województw jest zapisany w zmiennej `shp1f`. 

Pierwsze dwie kolumny tej tabeli to współrzędne geograficzne punktów na obrysie każdego województwa. Używając geometrii `geom_path` narysujemy te obrysy. 

```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE}
library(ggplot2)
# fortify zmienia format danych na zgodny z pakietem ggplot2
shp1f <- fortify(shp1, region = "VARNAME_1")
head(shp1f, 4)

ggplot() +
  geom_path(data=shp1f, aes(x=long, y=lat, group=id), colour="black", size=0.25)
```

---

# Rysowanie mapy

Geometrii `geom_path()` będziemy używać do rysowania obrysów województw. Do zaznaczania wartości liczbowych za pomocą koloru wypełnienia użyjemy geometrii `geom_map()`. Argument `map=` tej geometrii wskazuje obiekt przedstawiający województwa, argument `data=` wskazuje na obiekt z danymi liczbowymi. W mapowaniach określamy cechę `map_id=` aby wskazać nazwy województw a `fill=` by wskazać która zmienna ma być przedstawiona kolorem wypełnienia.

```{r, fig.height=4, fig.width=7, message=FALSE, warning=FALSE}
ggplot() +
    geom_map(data=mandatySejmik2014, aes(map_id=Wojewodztwo, fill=ProcentWaznychGlosow), 
             map=shp1f) +
    geom_path(data=shp1f, aes(x=long, y=lat, group=id), colour="black", size=0.25)
```

---

# Rysowanie mapy

Mapy można rysować w różnych projekcjach. Aby je wybrać wystarczy dodać wywołanie funkcji `coord_map()`. Poniżej dwa przykładowe projekcje. Listę projekcji z opisem właściwości znaleźć można pod adresem http://en.wikipedia.org/wiki/List_of_map_projections

```{r, fig.height=4, fig.width=7, message=FALSE, warning=FALSE, eval=FALSE}
mapka <- ggplot() +
    geom_map(data=mandatySejmik2014, aes(map_id=Wojewodztwo, fill=ProcentWaznychGlosow), 
             map=shp1f) +
    geom_path(data=shp1f, aes(x=long, y=lat, group=id), colour="black", size=0.25) 

mapka + coord_map(projection="mercator")
mapka + coord_map(projection="stereographic")
```
```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE, echo=FALSE}
mapka <- ggplot() +
    geom_map(data=mandatySejmik2014, aes(map_id=Wojewodztwo, fill=ProcentWaznychGlosow), 
             map=shp1f) +
    geom_path(data=shp1f, aes(x=long, y=lat, group=id), colour="black", size=0.25) 

mapka + coord_map(projection="mercator")
mapka + coord_map(projection="stereographic")
```

---

# Rysowanie mapy - zmienna jako kolor wypełnienia

Mapy modyfikuje się podobnie jak inne wykresy w pakiecie `ggplot2`. Przedstawmy kilka przykładowych zmian, funkcją `theme_bw()` zmieniamy domyślny motyw wykresu, funkcją `scale_fill_gradient()` zmieniamy sposób reprezentacji zmiennej za pomocą koloru wypełniania, a dodatkowymi argumentami funkcji `theme()` usuwamy wszystkie dodatkowe elementy wykresu.


```{r, fig.height=4, fig.width=7, message=FALSE, warning=FALSE}
ggplot() +
    geom_map(data=mandatySejmik2014, aes(map_id=Wojewodztwo, fill=ProcentWaznychGlosow), 
             map=shp1f) +
    geom_path(data=shp1f, aes(x=long, y=lat, group=id), colour="white", size=1) +
  coord_map(projection="mercator") +
  theme_bw() +
  scale_fill_gradient(low = "grey90", high = "black") +
  theme(axis.ticks = element_blank(),     panel.border = element_blank(),
        axis.text.x = element_blank(),    axis.text.y = element_blank(),
        panel.grid.minor=element_blank(), panel.grid.major=element_blank(),
        axis.title.x = element_blank(),   axis.title.y = element_blank())
```

---

# Rysowanie mapy - zmienna jako wielkość punktu.

Alternatywny sposób prezentacji informacji na mapie jest wielkość punktu. Do rysowania punktów można wykorzystać geometrię `geom_point()`, wskazując jako współrzędne punktu środki województw a wielkość punktu uzależniamy od zmiennej `ProcentWaznychGlosow`. Aby punkty były bardziej widoczne powiększamy je modyfikując mapowanie za pomocą funkcji `scale_size_continuous()`.

```{r, fig.height=4, fig.width=7, message=FALSE, warning=FALSE}
ggplot() +
  geom_point(data=mandatySejmik2014, aes(x=long, y=lat, size=ProcentWaznychGlosow)) +
  geom_path(data=shp1f, aes(x=long, y=lat, group=id), colour="black", size=0.25) +
  coord_map(projection="mercator") +
  theme_bw() +
  scale_size_continuous(range=c(1,20)) +
  theme(axis.ticks = element_blank(),     panel.border = element_blank(),
        axis.text.x = element_blank(),    axis.text.y = element_blank(),
        panel.grid.minor=element_blank(), panel.grid.major=element_blank(),
        axis.title.x = element_blank(),   axis.title.y = element_blank())
```

---

# Rysowanie mapy - zmienna jako długość paska

Jeszcze innym sposobem prezentacji danych liczbowych na mapach są długości słupków. 
Aby dorysować informację o mandatach zdobytych przez PO wykorzystamy geometrię `geom_rect()`. Należy do niej podać współrzędne `xmin` i `xmax` oznaczające początek i koniec słupka oraz `ymin` i `ymax` zależne od wartości zmiennej `PO`.

```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE}
ggplot() +
  geom_path(data=shp1f, aes(x=long, y=lat, group=id), colour="grey", size=0.25) +
  geom_rect(data=mandatySejmik2014, aes(xmin=long-0.3, xmax=long-0.1, 
                                        ymin=lat, ymax=lat + PO/15), fill="orange3", color="white") +
  coord_map(projection="mercator") +
  theme_bw() +
  scale_size_continuous(range=c(1,20)) +
  theme(axis.ticks = element_blank(),     panel.border = element_blank(),
        axis.text.x = element_blank(),    axis.text.y = element_blank(),
        panel.grid.minor=element_blank(), panel.grid.major=element_blank(),
        axis.title.x = element_blank(),   axis.title.y = element_blank())
```

---

# Rysowanie mapy - zmienna jako długość paska

Na poniższym wykresie rozszerzamy pomysł z poprzedniego slajdu, dodając również słupki prezentujące liczbę zdobytych mandatów przez PiS, PSL i SLD.

```{r, fig.height=4, fig.width=5, message=FALSE, warning=FALSE}
ggplot() +
  geom_path(data=shp1f, aes(x=long, y=lat, group=id), colour="grey", size=0.25) +
  geom_rect(data=mandatySejmik2014, aes(xmin=long-0.3, xmax=long-0.1, 
                                        ymin=lat, ymax=lat + PO/15), fill="orange3", color="white") +
  geom_rect(data=mandatySejmik2014, aes(xmin=long-0.1, xmax=long+0.1, 
                                        ymin=lat, ymax=lat + PiS/15), fill="blue3", color="white") +
  geom_rect(data=mandatySejmik2014, aes(xmin=long+0.1, xmax=long+0.3, 
                                        ymin=lat, ymax=lat + PSL/15), fill="green3", color="white") +
  geom_rect(data=mandatySejmik2014, aes(xmin=long+0.5, xmax=long+0.3, 
                                        ymin=lat, ymax=lat + SLD/15), fill="red", color="white") +
  coord_map(projection="mercator") +
  theme_bw() +
  scale_size_continuous(range=c(1,20)) +
  theme(axis.ticks = element_blank(),     panel.border = element_blank(),
        axis.text.x = element_blank(),    axis.text.y = element_blank(),
        panel.grid.minor=element_blank(), panel.grid.major=element_blank(),
        axis.title.x = element_blank(),   axis.title.y = element_blank())
```
---

# Co dalej

- Więcej informacji o tym jak budować wykresy w pakiecie ggplot2 znaleźć można w rozdziale 4 książki *,,Przewodnik po pakiecie R''*. Więcej informacji o tej książce http://www.biecek.pl/R/

- Wiele przydatnych wskazówek można również znaleźć w internetowej książce *,,Cookbook for R''* http://www.cookbook-r.com/Graphs/

- Bardzo rozbudowana dokumentacja dla pakietu ggplot2 dostępna jest na stronie *,,ggplot2''* http://docs.ggplot2.org/current/index.html


