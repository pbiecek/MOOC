---
title: "Jak zrobić wykres w ggplot2"
author: "pogRomcy danych"
date: "sezon 3 / odcinek 4 <br><br><br><br>Naciśnij `A` by zamienić slajdy na ciągły tekst <br> Naciśnij `T` by wyświetlić spis treści"
output:
  slidy_presentation:
    includes:
      in_header: ../tracking.html
    highlight: default
    css: ../style.css
    font_adjustment: 0
    footer: "pogRomcy danych / wizualizacja / wstęp do ggplot2"

---

# O czym jest ten odcinek

Dane są czymś abstrakcyjnym i często trudno zrozumieć zależności pomiędzy różnymi zmiennymi.

Ale znacznie łatwiej dostrzec lub zrozumieć te zależności, jeżeli tylko poprawnie się je przedstawi graficznie.

Cały sezon 3 poświęcony jest wizualizacji danych, ale w tym odcinku poznamy pakiet graficzny `ggplot2`, pozwalający na tworzenie dobrze wyglądających i czytelnych wykresów.

W tym odcinku dowiemy się:

- W programie R wykresy można tworzyć z użyciem najróżniejszych pakietów. Dowiemy się, dlaczego w pierwszej kolejności warto poznać i dlaczego warto używać pakietu `ggplot2`?
- Jednym z najpopularniejszych sposobów przedstawiania danych są wykresy punktowe. Pokażemy jak tworzyć takie wykresy.
- Jednym z kluczowych pomysłów w pakiecie `ggplot2` są mapowania zmiennych na właściwości wykresu, dokładnie omówimy na czym polega ten pomysł.
- Poznamy kolejne rodzaje wykresów, takie jak wykres z etykietami lub wykres liniowy.
- Pokażemy też jak składać różne warstwy wykresu?

W tym odcinku będziemy pracować z dwoma zbiorami danych: `koty_ptaki` oraz `WIG`.

```{r,  message=FALSE}
library(SmarterPoland)

head(koty_ptaki)

head(WIG)
```

---


# Dlaczego warto poznać pakiet `ggplot2`?

Coraz więcej osób dostrzega potencjał wizualizacji danych zarówno w zastosowaniach biznesowych, w nauce, mediach czy życiu codziennym.
Z tego powodu powstaje coraz więcej rozwiązań, programów i pakietów, pozwalających na prezentację danych.

My skupimy się na jednym, na pakiecie `ggplot2`. Dlaczego? Jest ku temu kilka powodów.

- Zaawansowana analiza danych bardzo często ma miejsce w programie R. Wykorzystanie tego samego programu do analiz i do wizualizacji, ma tę zaletę, że nie musimy danych konwertować do nowego formatu, nie musimy poznawać dwóch języków opisu wizualizacji, możemy pracować w jednym spójnym środowisku. Z pakietów programu R, to właśnie `ggplot2` jest najbardziej dojrzałym rozwiązaniem.
- Pakiet `ggplot2` pozwala na tworzenie grafiki *publicaition ready*, czyli wystarczająco dobrej by pokazać ją innym osobom bez dodatkowych zabiegów upiększających. 
- Pakiet `ggplot2` wymusza myślenie o wykresach danych w kategorii zmiennych, które chcemy przedstawić a nie w kategorii szablonu, który chcemy wypełnić. Krzywa uczenia jest bardziej stroma, niż w przypadku ,,klikadeł'', ale z czasem nasze możliwości niepomiernie rosną. 


---

# Dlaczego `ggplot2` a nie standardowe pakiety R?

Wykorzystując zbiór danych `koty_ptaki` przedstawmy zależność wagi od prędkości dla wybranych gatunków. Wykorzystamy w tym celu dwa pakiety graficzne dostępne w programie R, pakiet `graphics` z funkcją `plot()` oraz pakiet `ggplot2`  z funkcją `ggplot()`. 

Poniższe instrukcje tworzą wykres z domyślnymi ustawieniami.

```{r,  message=FALSE, eval=FALSE}
library(ggplot2)        # ten pakiet pozwala na tworzenie wykresów 

plot(koty_ptaki$waga, koty_ptaki$predkosc)
ggplot(koty_ptaki, aes(x=waga, y=predkosc)) +
  geom_point()
```

---

# Co różni te dwa wykresy?

Przyjrzymy się wynikowym wykresom oraz postarajmy się znaleźć jak najwięcej różnic.

```{r, fig.height=5, fig.width=5, message=FALSE, echo=FALSE}

library(SmarterPoland)
library(ggplot2)

plot(koty_ptaki$waga, koty_ptaki$predkosc)
ggplot(koty_ptaki, aes(x=waga, y=predkosc)) +
  geom_point()
```


---

# Co różni te dwa wykresy?

Oczywiście te wykresy różnią się wieloma elementami. 
Różnice, które uznałem za najistotniejsze to:

- Na prawym wykresie widoczne są pionowe i poziome linie pomocnicze, ułatwiają one dokładniejsze odczytanie współrzędnych punktów niż w przypadku lewego wykresu.
- Linie pomocnicze są białe na szarym tle, przez co nie dominują wykresu i są delikatnie przesunięte na drugi plan.
- Jeżeli wykres umieszczamy na białej stronie internetowej to szare tło umożliwia szybką lokalizację wykresu.
- Oba wykresy wypełniają obszar 10 x 10 cm, ale lewy wykres ma duże marginesy, przez co mniej miejsca pozostaje na prezentacje danych. Prawy wykres ma małe marginesy, przez co jest więcej miejsca na zaprezentowanie danych.
- Etykiety na osiach na prawym wykresie są poziome, nie trzeba obracać głowy by je odczytać.
- Etykiety na prawym wykresie są pomniejszone i wyszarzane, przesunięte na drugi plan. Wciąż są widoczne ale mniej dominują wykres, pozwalając przesunąć dane na pierwszy plan.
- Nazwy na osiach są krótsze i czytelniejsze, nie ma członu `koty_ptaki$`, który nie jest potrzebny.
- Punkty zaznaczone są kropkami a nie pustymi okręgami, dzięki czemu zajmują mniej miejsca, więcej ich się zmieści na wykresie i łatwiej odczytać współrzędne punktu.

Używając pakietu `ggplot2` otrzymujemy przy fabrycznych ustawieniach czytelny wykres. Jeżeli chcemy go zmienić, możemy zmienić każdy jego element. Ale jeżeli nie chcemy, możemy skupić się na danych a nie upiększaniu wykresu.


---

# Jak zrobić wykres punktowy?

Przyjrzyjmy się instrukcji, która tworzy wykres punktowy.

```{r, fig.height=4, fig.width=4}
head(koty_ptaki, 3)
ggplot(koty_ptaki, aes(x=waga, y=predkosc)) +
  geom_point()
```

---

# Elementy wykresu punktowego

```{r, eval=FALSE}
ggplot(koty_ptaki, aes(x=waga, y=predkosc)) +
  geom_point()
```

Trzy elementy są kluczowe w tej instrukcji.

- Funkcja `ggplot()` jest główną funkcją tworzącą trzon wykresu. Zazwyczaj przyjmuje ona dwa argumenty. Pierwszy to zbiór danych (w tym przypadku `koty_ptaki`). Drugi to opis, które zmienne i w jaki sposób mają być przedstawione na wykresie, tak zwany opis mapowań. (BŁĄD STYLISTYCZNY W ZDANIU)
- Mapowania opisuje funkcja `aes()`. Argumenty tej funkcji to pary `cecha wykresu=zmienna`. Każda z tych par opisuje w jaki sposób określona zmienne ma być przedstawiona. W powyższym przypadku opis ten oznacza, że zmienna `waga` ma być przedstawiona przez współrzędne `x` a zmienna `predkosc` ma być przedstawiona przez zmienną `y`.
- Trzon wykresu rozbudowuje się dodając, z użyciem operatora `+`, kolejne funkcje. W tym przypadku funkcja `geom_point()` dodaje do wykresu warstwę przedstawiającą dane za pomocą punktów. Funkcje, o nazwach rozpoczynających się od `geom_` nazywamy geometriami, określają one w jaki sposób dane są prezentowane. Czy jako punkty, linie, obszary czy jeszcze inaczej. W tym sezonie poznamy kilka geometrii, zbiór wszystkich dostępnych geometrii znaleźć można na stronie http://docs.ggplot2.org.

---

# Dodajemy mapowania - kształt punktu - `shape`

Jak dotąd, nie widać jeszcze jak potężnym mechanizmem są mapowania. Zademonstrujmy to w kolejnym przykładzie, gdzie na wykresie przedstawimy również zmienną `druzyna`. Różne wartości tej zmiennej przedstawimy za pomocą różnych kształtów punktów, a więc cechy `shape`.

```{r, fig.height=4, fig.width=5}
head(koty_ptaki, 3)
ggplot(koty_ptaki, aes(x=waga, y=predkosc, shape=druzyna)) +
  geom_point(size=5) 
```

---

# Jak budować wykresy z `ggplot2`?

```{r, eval=FALSE}
ggplot(koty_ptaki, aes(x=waga, y=predkosc, shape=druzyna)) +
  geom_point(size=5) 
```

Przeanalizujemy jak wygląda sposób myślenia przy tworzeniu wykresu.

W pierwszym kroku wybieramy zmienne, które chcemy przedstawić na wykresie. W naszym przypadku te zmienne to `predkosc`, `waga` oraz `druzyna`.

W następnym kroku wybieramy geometrię, która przedstawi wybrane dane. Kierujemy się tutaj rodzajem zmiennych. Przedstawiając zależność pomiędzy dwoma ilościowymi zmiennymi, naturalnym wyborem jest geometria punktowa. Zmienną jakościową potraktujemy jako zmienną grupującą.

Kolejny krok to wybór cech geometrii, które mają przedstawić wybrane zmienne. W naszym przypadku zmienne `predkosc` i `waga` przedstawimy przez współrzędne punktu. Zmienną punkt przedstawimy przez kształt punktu.

---

# Dodajemy mapowania - wielkość punktu - `size`

Jeżeli efekt nam się nie podoba, możemy wykorzystać inną cechą. Na przykład wielkość punktu, czyli cechę `size`.

```{r, fig.height=4, fig.width=5}
ggplot(koty_ptaki, aes(x=waga, y=predkosc, size=druzyna)) +
  geom_point() 
```

---

# Dodajemy mapowania - kolor punktu - `color`

Jeżeli wynik jest wciąż niezadawalający, możemy próbować zmieniać kolejne cechy, na przykład koloru `color`.

```{r, fig.height=4, fig.width=5}
ggplot(koty_ptaki, aes(x=waga, y=predkosc, color=druzyna)) +
  geom_point(size=5) 

```

---

# Wiele mapowań dla tej samej zmiennej

Zależność *cecha geometrii -- zmienna* to zależność jeden do wielu. Oznacza to, że w opisie mapowań jedna cecha może być powiązana z tylko jedną zmienną. Ale jedna zmienna, może być powiązana z kilkoma cechami. 

Na poniższym przykładzie jedna zmienna jest reprezentowana przez zarówno kolor, kształt jak i wielkość punktu.

```{r, fig.height=4, fig.width=5}
ggplot(koty_ptaki, aes(x=waga, y=predkosc, color=druzyna, 
                       shape=druzyna, size=druzyna)) +
  geom_point() 
```

---

# Na jaką cechę mapować?

Zmieniając argumenty funkcji `aes()`, możemy wybierać sposób reprezentacji określonych zmiennych. Z czterech, które rozważaliśmy, które jest najlepsze?

```{r, fig.height=4, fig.width=5, echo=FALSE}
ggplot(koty_ptaki, aes(x=waga, y=predkosc, shape=druzyna)) +
  geom_point(size=5) 
ggplot(koty_ptaki, aes(x=waga, y=predkosc, size=druzyna)) +
  geom_point() 
ggplot(koty_ptaki, aes(x=waga, y=predkosc, color=druzyna)) +
  geom_point(size=5) 
ggplot(koty_ptaki, aes(x=waga, y=predkosc, color=druzyna, 
                       shape=druzyna, size=druzyna)) +
  geom_point() 
```

---

# Geometria `geom_text()` - etykiety tekstowe na wykresie

Zobaczmy, jak skorzystać z innych geometrii. Za przykład posłuży nam geometria do umieszczania napisów na wykresie, czyli `geom_text()`. Szczegółowy opis tej geometrii, wraz z przykładami użycia, znajduje się na stronie http://docs.ggplot2.org/current/geom_text.html. W sekcji `Aesthetics` znaleźć można listę cech tej geometrii, które można zmienić. Trzy obowiązkowe cechy to `x`, `y` i `label`. 

Tak wygląda przykładowe wywołanie.


```{r, fig.height=4, fig.width=5, echo=FALSE}
ggplot(koty_ptaki, aes(x= waga, y=predkosc, label=gatunek)) +
  geom_text()
```

---

# Geometria `geom_text()` - pozycjonowanie napisu

Zauważmy, że niektóre napisy wychodzą poza wykres. Nie wygląda to najlepiej. Można ten problem naprawić na dwa sposoby. Jeden to rozszerzenie osi OX, drugi to pozycjonowanie napisów względem lewego brzegu a nie środka.

Spróbujmy tego drugiego rozwiązania. Śledząc opis geometrii `geom_text()` można zauważyć, że za pozycjonowanie odpowiadają cechy `hjust` (w poziomie) i `vjust` (w pionie).

Zauważmy, że argument `hjust` definiujemy wewnątrz `geom_text()` poza blokiem `aes()`, nie mapuje on zmiennej na cechy wykresu ale przypisuje cesze stałą wartość (w tym przypadku `0`). Aby na wykresie zmieściła się też etykieta `Tygrys` zmieniamy funkcją `xlim()` zakres prezentowany na osi OX.

```{r, fig.height=4, fig.width=5}
ggplot(koty_ptaki, aes(x= waga, y=predkosc, label=gatunek)) +
  geom_text(hjust=0) + xlim(0,350)
```

---

# Składanie dwóch geometrii

Jedną z ciekawszych cech pakietu `ggplot2` jest to, że możemy dodawać kolejne warstwy z danymi dodając kolejne geometrie. Dzięki temu, można osiągnąć bardzo ciekawe efekty.

Na poniższym przykładzie do warstwy z napisami dodajemy warstwę z punktami.

```{r, fig.height=4, fig.width=5}
ggplot(koty_ptaki, aes(x= waga, y=predkosc, label=gatunek)) +
  geom_text(hjust=-0.1) + geom_point() + xlim(0,350)
```

---

# Globalne mapowania

Zauważmy, że mapowania określone przez funkcję `aes()` wewnątrz funkcji `ggplot()` dotyczą wszystkich warstw.
Na poniższym przykładzie mapujemy zmienną `druzyna` na cechę `color` i to mapowanie dotyczy obu geometrii.

```{r, fig.height=4, fig.width=5}
ggplot(koty_ptaki, aes(x=waga, y=predkosc, label=gatunek, color=druzyna)) +
  geom_text(hjust=-0.1) + geom_point() + xlim(0,350)
```

---

# Lokalne mapowania

Jeżeli chcemy aby mapowanie dotyczyło tylko jednej warstwy, należy przenieść je do określonej geometrii.
Na poniższym przykładzie mapowanie zmiennej `druzyna` na `color` przypisane jest tylko do geometrii `geom_text()`.

```{r, fig.height=4, fig.width=5}
ggplot(koty_ptaki, aes(x=waga, y=predkosc, label=gatunek)) +
  geom_text(hjust=-0.1, aes(color=druzyna)) + geom_point() + xlim(0,350)
```

---

# Geometria `geom_line()` - wykres liniowy

Każdą geometrię używa się podobnie prosto. Przykładowo, geometria `geom_line()` służy do rysowania linii, aby ją wykorzystać na wykresie, wystarczy ją dodać do wykresu. 

Przedstawimy tę geometrię na przykładzie danych o indeksie WIG. Przy okazji zauważmy, że jeżeli na cechę `x` będziemy mapować zmienną, która jest datą, to oś wykresu zostanie tak dobrana by poprawnie odwzorować wskazaną zmienną.

```{r, fig.height=4, fig.width=5}
head(WIG,2)
ggplot(WIG, aes(x=Data, y=Kurs.zamkniecia)) + 
  geom_line()
```

---

# Geometria `geom_ribbon()` - wykres wstęga

Ostatnim przykładem w tym odcinku będzie geometria `geom_ribbon()` do rysowania wstęg. Wstęgi są opisane przez cechy `ymin` i `ymax`. Możemy na te cechy zamapować zmienną lub stała. W poniższym przykładzie rysujemy wstęgę rozpinającą się od zera do wartości indeksu WIG.

```{r, fig.height=4, fig.width=5}
ggplot(WIG, aes(x=Data, ymin=0, ymax=Kurs.zamkniecia)) + 
  geom_ribbon()
```

---

# Gdzie szukać dalszych informacji

Opanowaliśmy podstawy tworzenia wykresów z użyciem pakietu `ggplot2`. W kolejnych odcinkach przedstawimy więcej informacji, ale można ich też poszukać w poniższych źródłach.

- Więcej informacji o tym jak budować wykresy w pakiecie ggplot2 znaleźć można w rozdziale 4 książki *,,Przewodnik po pakiecie R''*. Więcej informacji o tej książce http://www.biecek.pl/R/

- Wiele przydatnych wskazówek można również znaleźć w internetowej książce *,,Cookbook for R''* http://www.cookbook-r.com/Graphs/

- Bardzo rozbudowana dokumentacja dla pakietu ggplot2 dostępna jest na stronie *,,ggplot2''* http://docs.ggplot2.org/current/index.html



